<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Mileage Tracker</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Custom scrollbar for modal content */
        #edit-modal-content::-webkit-scrollbar, #confirm-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #edit-modal-content::-webkit-scrollbar-track, #confirm-modal-content::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        #edit-modal-content::-webkit-scrollbar-thumb, #confirm-modal-content::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
       #edit-modal-content::-webkit-scrollbar-thumb:hover, #confirm-modal-content::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        
        <header class="mb-6 text-center">
            <svg id="company-logo-svg" viewBox="0 0 128 60" class="h-20 w-auto mx-auto" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M110.165 26.9631C110.42 27.2434 110.821 27.3713 111.222 27.2891L122.563 24.8159C123.511 24.6141 124.038 23.5932 123.642 22.7018L119.923 14.3391C119.527 13.4477 118.428 13.0903 117.514 13.435L110.165 16.3312V5C110.165 3.34315 108.822 2 107.165 2H5C3.34315 2 2 3.34315 2 5V48C2 49.6569 3.34315 51 5 51H18.9419C20.4749 55.4364 24.5636 58.5 29.5 58.5C34.4364 58.5 38.5251 55.4364 40.0581 51H89.9419C91.4749 55.4364 95.5636 58.5 100.5 58.5C105.436 58.5 109.525 55.4364 111.058 51H125C126.657 51 128 49.6569 128 48V30.1502L110.165 26.9631ZM29.5 54.5C25.9101 54.5 23 51.5899 23 48C23 44.4101 25.9101 41.5 29.5 41.5C33.0899 41.5 36 44.4101 36 48C36 51.5899 33.0899 54.5 29.5 54.5ZM100.5 54.5C96.9101 54.5 94 51.5899 94 48C94 44.4101 96.9101 41.5 100.5 41.5C104.09 41.5 107 44.4101 107 48C107 51.5899 104.09 54.5 100.5 54.5Z" fill="#2D3748"/>
            </svg>
            <h1 class="text-3xl font-bold text-cyan-400 mt-2">Truck Mileage Tracker</h1>
            <p class="text-gray-400 mt-1">Log your trips and keep accurate track of your miles.</p>
        </header>

        <!-- Driver & Vehicle Info Section -->
        <div class="bg-gray-700 p-6 rounded-xl mb-8">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Driver & Vehicle Info</h2>
                <button id="edit-info-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hidden">Edit Info</button>
            </div>
            <div id="vehicle-info-display" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 text-gray-300">
                    <p><strong>Driver:</strong> <span id="display-driverName"></span></p>
                    <p><strong>Company:</strong> <span id="display-company"></span></p>
                    <p><strong>Truck #:</strong> <span id="display-truckNumber"></span></p>
                    <p><strong>Trailer #:</strong> <span id="display-trailerNumber"></span></p>
                    <p><strong>Initial Odometer:</strong> <span id="display-initialOdometer"></span></p>
                </div>
            </div>
            <form id="vehicle-info-form" class="">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1">Driver Name</label>
                        <input type="text" id="driverNameInfo" placeholder="Your Name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
                        <input type="text" id="companyInfo" placeholder="Your Company Name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Truck #</label>
                        <input type="text" id="truckNumberInfo" placeholder="e.g., T-123" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                     <div>
                        <label for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Trailer #</label>
                        <input type="text" id="trailerNumberInfo" placeholder="e.g., P-456" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="mb-4">
                     <label for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1">Initial Odometer</label>
                     <input type="number" id="initialOdometerInfo" placeholder="e.g., 150000" required class="w-full md:w-1/4 bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Save Info</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-700 p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Trip</h2>
            <form id="mileage-form">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="md:col-span-1">
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="departure" placeholder="City, State" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="number" id="odometer" placeholder="e.g., 150200" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300">
                        Add Trip
                    </button>
                </div>
            </form>
        </div>

        <div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Trip History</h2>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 <button type="button" id="archive-reset-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm1-4a1 1 0 000 2h10a1 1 0 100-2H5z" clip-rule="evenodd"></path></svg>
                    Archive &amp; Reset
                </button>
                 <button type="button" id="share-pdf-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                    Share PDF
                </button>
                <div class="bg-gray-700 rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm">Total Miles</span>
                    <span id="total-miles" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div class="bg-gray-700 rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm">Amount to Charge</span>
                    <span id="total-amount" class="font-bold text-2xl text-green-400">$0.00</span>
                </div>
            </div>
            
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-cyan-300 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3">Driver</th>
                            <th scope="col" class="px-6 py-3">Departure</th>
                            <th scope="col" class="px-6 py-3">Initial Odometer</th>
                            <th scope="col" class="px-6 py-3">Ending Odometer</th>
                            <th scope="col" class="px-6 py-3">Company</th>
                            <th scope="col" class="px-6 py-3">Truck #</th>
                            <th scope="col" class="px-6 py-3">Trailer #</th>
                            <th scope="col" class="px-6 py-3">Miles</th>
                            <th scope="col" class="px-6 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="mileage-table-body">
                        <tr id="empty-row" class="bg-gray-800 border-b border-gray-700">
                           <td colspan="10" class="text-center py-8 text-gray-500">No records yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal for Editing a Trip --><div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-lg" id="edit-modal-content">
            <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-yellow-400">Edit Trip</h3>
                <button id="edit-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="edit-departure" placeholder="City, State" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="number" id="edit-odometer" placeholder="e.g., 150200" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-600 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal --><div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-lg" id="confirm-modal-content">
            <div class="p-4 border-b border-gray-600">
                <h3 class="text-lg font-semibold text-red-400">Confirm Action</h3>
            </div>
            <div class="p-6">
                <p>Are you sure you want to archive all trips? This will download a PDF report, clear all records, and update the initial odometer. This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-gray-600 flex justify-end gap-4">
                <button id="confirm-no-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Archive & Reset</button>
            </div>
        </div>
    </div>


    <!-- Notification Element --><div id="notification" class="fixed top-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>


    <script>
        // --- Global Notification Function ---
        const showNotification = (message, isError = true) => {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            if (!notification || !notificationMessage) return;

            notificationMessage.textContent = message;
            notification.classList.remove('bg-red-600', 'bg-green-500');
            notification.classList.add(isError ? 'bg-red-600' : 'bg-green-500');
            notification.classList.remove('opacity-0');
            setTimeout(() => {
                notification.classList.add('opacity-0');
            }, 4000);
        };
        
        const getSvgAsImageBase64 = (svgElement) => {
            return new Promise((resolve, reject) => {
                if (!svgElement) return reject("SVG element not provided");

                const svgString = new XMLSerializer().serializeToString(svgElement);
                const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                const url = URL.createObjectURL(svgBlob);
                
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const viewBox = svgElement.getAttribute('viewBox').split(' ').map(Number);
                    const width = viewBox[2];
                    const height = viewBox[3];
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = (err) => {
                    URL.revokeObjectURL(url);
                    reject(err);
                };
                img.src = url;
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            const form = document.getElementById('mileage-form');
            const tableBody = document.getElementById('mileage-table-body');
            const totalMilesEl = document.getElementById('total-miles');
            const emptyRow = document.getElementById('empty-row');
            const departureInput = document.getElementById('departure');
            const vehicleInfoForm = document.getElementById('vehicle-info-form');
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display');
            const editInfoBtn = document.getElementById('edit-info-btn');
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');
            const sharePdfBtn = document.getElementById('share-pdf-btn');
            const archiveResetBtn = document.getElementById('archive-reset-btn');
            // Modals
            const editModal = document.getElementById('edit-modal');
            const editTripForm = document.getElementById('edit-trip-form');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || [];
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;

            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                if (vehicleInfo) {
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();

                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    
                    vehicleInfoDisplay.classList.remove('hidden');
                    vehicleInfoForm.classList.add('hidden');
                    editInfoBtn.classList.remove('hidden');
                } else {
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden');
                    editInfoBtn.classList.add('hidden');
                }
            };
            
            editInfoBtn.addEventListener('click', () => {
                vehicleInfoDisplay.classList.add('hidden');
                vehicleInfoForm.classList.remove('hidden');
            });

            vehicleInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newInfo = {
                    driverName: driverNameInfoInput.value,
                    company: companyInfoInput.value,
                    truckNumber: truckNumberInfoInput.value,
                    trailerNumber: trailerNumberInfoInput.value,
                    initialOdometer: initialOdometerInfoInput.value,
                };
                localStorage.setItem('vehicleInfo', JSON.stringify(newInfo));
                loadVehicleInfo();
            });
            
            const renderTable = () => {
                tableBody.innerHTML = '';
                
                if (records.length === 0) {
                    tableBody.appendChild(emptyRow.cloneNode(true));
                    sharePdfBtn.disabled = true;
                    archiveResetBtn.disabled = true;
                    sharePdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    archiveResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    sharePdfBtn.disabled = false;
                    archiveResetBtn.disabled = false;
                    sharePdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600/50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${record.date}</td>
                            <td class="px-6 py-4">${record.driverName}</td>
                            <td class="px-6 py-4">${record.departure}</td>
                            <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${Number(record.odometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${record.company}</td>
                            <td class="px-6 py-4">${record.truckNumber}</td>
                            <td class="px-6 py-4">${record.trailerNumber}</td>
                            <td class="px-6 py-4 font-bold text-cyan-400">${Number(record.miles).toLocaleString()}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${record.id}" class="edit-btn text-yellow-500 hover:text-yellow-400 font-medium mr-4">Edit</button>
                                <button data-id="${record.id}" class="delete-btn text-red-500 hover:text-red-400 font-medium">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                updateTotalMiles();
                saveToLocalStorage();
            };

            const updateTotalMiles = () => {
                const total = records.reduce((sum, record) => sum + Number(record.miles), 0);
                totalMilesEl.textContent = total.toLocaleString();

                const totalAmountEl = document.getElementById('total-amount');
                const amount = total * 0.70;
                totalAmountEl.textContent = amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };
            const saveToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                if (!vehicleInfo || vehicleInfo.initialOdometer === undefined) {
                    showNotification('Please save driver & vehicle info, including an initial odometer, before adding a trip.');
                    return;
                }

                const initialOdometer = Number(vehicleInfo.initialOdometer);
                const endingOdometerInput = document.getElementById('odometer').value;
                const endingOdometer = endingOdometerInput ? Number(endingOdometerInput) : 0;

                let tripMiles = 0;
                let shouldUpdateOdometer = false;

                if (endingOdometer > 0) {
                    if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer.');
                        return;
                    }
                    tripMiles = endingOdometer - initialOdometer;
                    shouldUpdateOdometer = true;
                }

                const newRecord = {
                    id: Date.now(),
                    date: document.getElementById('date').value,
                    departure: departureInput.value,
                    driverName: vehicleInfo.driverName,
                    company: vehicleInfo.company,
                    truckNumber: vehicleInfo.truckNumber,
                    trailerNumber: vehicleInfo.trailerNumber,
                    initialOdometer: initialOdometer,
                    odometer: endingOdometer,
                    miles: tripMiles,
                };

                records.push(newRecord);
                records.sort((a, b) => a.id - b.id); // Sort by creation timestamp ASC
                
                if (shouldUpdateOdometer) {
                    vehicleInfo.initialOdometer = endingOdometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }
                
                form.reset();
                renderTable();
                loadVehicleInfo(); 
            });
            
            const generateAndHandlePdf = async (recordsToExport, forSharing = true) => {
                 if (!recordsToExport || recordsToExport.length === 0) {
                    showNotification('No data to generate a report.');
                    return;
                }

                let logoBase64;
                try {
                    logoBase64 = await getSvgAsImageBase64(document.getElementById('company-logo-svg'));
                } catch (error) {
                    showNotification('Could not load company logo for the PDF report.');
                }

                const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                
                showNotification(`Generating ${uniqueDrivers.length} PDF report(s)...`, false);

                for (const driver of uniqueDrivers) {
                    const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                     const driverInfo = {
                        driverName: driver,
                        company: driverRecords[0]?.company || vehicleInfo?.company,
                        truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber,
                        trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber,
                    };

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const totalMilesForDriver = driverRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                    
                    let startY = 15;
                    if(logoBase64) {
                        const imgWidth = 50;
                        const imgHeight = 25;
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const x = (pageWidth - imgWidth) / 2;
                        doc.addImage(logoBase64, 'PNG', x, 15, imgWidth, imgHeight);
                        startY = 45;
                    }

                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                    startY += 8;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(50);
                    const headerText = `Driver: ${driverInfo.driverName} | Truck #: ${driverInfo.truckNumber} | Trailer #: ${driverInfo.trailerNumber}`;
                    doc.text(headerText, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                    startY += 15;

                    const tableColumn = ["Date", "City", "Odometer", "Miles"];
                    const tableRows = driverRecords.map(r => [r.date, r.departure, Number(r.odometer).toLocaleString(), Number(r.miles).toLocaleString()]);
                    
                    doc.autoTable(tableColumn, tableRows, { startY: startY });
                    const finalY = doc.lastAutoTable.finalY || startY;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Total Miles: ${totalMilesForDriver.toLocaleString()}`, 14, finalY + 15);
                    
                    if(forSharing) {
                        const pdfBlob = doc.output('blob');
                        const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' });
                        const shareData = { files: [pdfFile], title: `Mileage Report for ${driverInfo.driverName}` };

                        if (navigator.canShare && navigator.canShare(shareData)) {
                            try { await navigator.share(shareData); } catch (err) {
                                if (err.name !== 'AbortError') { showNotification(`Could not share report for ${driverInfo.driverName}.`);}
                            }
                        } else {
                            showNotification(`Browser doesn't support sharing. Downloading report for ${driverInfo.driverName}.`, false);
                            doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                        }
                    } else {
                         doc.save(`ARCHIVED_mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                    }
                }
            };

            sharePdfBtn.addEventListener('click', () => {
                if (records.length === 0) {
                    showNotification('No trip data to share.');
                    return;
                }
                generateAndHandlePdf(records, true);
            });

            // --- Edit Modal Logic ---
            const openEditModal = (trip) => {
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date;
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            };

            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editTripForm.reset();
            };

            editCloseBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);

            editTripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const tripId = Number(document.getElementById('edit-trip-id').value);
                const tripIndex = records.findIndex(r => r.id === tripId);
                
                if (tripIndex === -1) {
                    showNotification('Could not find trip to update.');
                    return;
                }

                const updatedTrip = {
                    ...records[tripIndex],
                    date: document.getElementById('edit-date').value,
                    departure: document.getElementById('edit-departure').value,
                    odometer: Number(document.getElementById('edit-odometer').value)
                };
                
                const endingOdometer = updatedTrip.odometer;
                const initialOdometer = updatedTrip.initialOdometer;

                if (endingOdometer > 0) {
                     if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer for this trip.');
                        return;
                    }
                    updatedTrip.miles = endingOdometer - initialOdometer;
                } else {
                    updatedTrip.miles = 0;
                }
                
                records[tripIndex] = updatedTrip;
                records.sort((a, b) => a.id - b.id);

                renderTable();
                saveToLocalStorage();
                closeEditModal();
                showNotification('Trip updated successfully.', false);
            });
            
            // --- Archive & Reset Logic ---
            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            };
            const closeConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            };

            archiveResetBtn.addEventListener('click', openConfirmModal);
            confirmNoBtn.addEventListener('click', closeConfirmModal);
            
            confirmYesBtn.addEventListener('click', async () => {
                if (records.length === 0) {
                    showNotification('No trips to archive.');
                    closeConfirmModal();
                    return;
                }
                
                await generateAndHandlePdf(records, false);

                const lastValidRecord = [...records].reverse().find(r => r.odometer > 0);
                if (lastValidRecord) {
                    vehicleInfo.initialOdometer = lastValidRecord.odometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }

                records = [];
                localStorage.setItem('mileageRecords', JSON.stringify(records));

                renderTable();
                loadVehicleInfo();
                closeConfirmModal();
                showNotification('Trips have been archived and reset.', false);
            });
            
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = Number(e.target.dataset.id);
                    records = records.filter(record => record.id !== idToDelete);
                    renderTable();
                } else if (e.target.classList.contains('edit-btn')) {
                    const idToEdit = Number(e.target.dataset.id);
                    const tripToEdit = records.find(r => r.id === idToEdit);
                    if (tripToEdit) {
                        openEditModal(tripToEdit);
                    }
                }
            });
            
            // --- Initial Load ---
            loadVehicleInfo();
            renderTable();
        });
    </script>

</body>
</html>

