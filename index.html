<!DOCTYPE html>
<!-- Set initial language based on localStorage or default to English -->
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Mileage Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Crect x='55' y='10' width='240' height='55' rx='5' fill='%232D3748'/%3E%3Cpath d='M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z' fill='%234A5568'/%3E%3Crect x='5' y='65' width='290' height='5' fill='%231A202C'/%3E%3Cg%3E%3Ccircle cx='50' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='50' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='230' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='230' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='260' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='260' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 100%);
            overflow: hidden; /* Prevent body scroll, main container handles it */
            min-height: 100vh;
        }
        
        /* Main content container with custom scrollbar */
        .main-container {
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(74, 85, 104, 0.7) rgba(45, 55, 72, 0.5); /* Firefox */
        }
        .main-container::-webkit-scrollbar { width: 8px; }
        .main-container::-webkit-scrollbar-track { background: rgba(45, 55, 72, 0.5); }
        .main-container::-webkit-scrollbar-thumb { background: rgba(74, 85, 104, 0.7); border-radius: 4px; }
        .main-container::-webkit-scrollbar-thumb:hover { background: rgba(113, 128, 150, 0.8); }

        /* Welcome screen pulse animation */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        .welcome-animation { animation: pulse 2s ease-in-out infinite; }
        
        /* Simple spinner animation */
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }

        /* Modal scrollbar styles */
        .modal-scrollbar::-webkit-scrollbar { width: 8px; }
        .modal-scrollbar::-webkit-scrollbar-track { background: rgba(45, 55, 72, 0.5); }
        .modal-scrollbar::-webkit-scrollbar-thumb { background: rgba(74, 85, 104, 0.7); border-radius: 4px; }
        .modal-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(113, 128, 150, 0.8); }
        
        /* Glassmorphism effect utility class */
       .glass-effect {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
       }

       /* Glassmorphism input styles */
       .glass-input {
            background-color: rgba(17, 24, 39, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
       }
       .glass-input::placeholder { color: rgba(209, 213, 219, 0.6); }
       .glass-input:focus {
            background-color: rgba(17, 24, 39, 0.7);
            border-color: rgba(59, 130, 246, 0.7);
            --tw-ring-color: rgba(59, 130, 246, 0.5);
       }

       /* Invert date picker icon color for dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }

        /* Sticky Footer styles */
        .sticky-footer {
            position: sticky;
            bottom: 0; /* Stick to the bottom */
            left: 0; 
            width: 100%; 
            padding: 1rem; 
            margin-top: auto; 
            background: linear-gradient(to top, rgba(30, 41, 59, 1), rgba(30, 41, 59, 0)); /* Stronger gradient */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 40; 
            transition: transform 0.3s ease-in-out; 
        }

        /* Class to hide the footer by sliding it down */
        .footer-hidden {
            transform: translateY(120%); /* Move further down to fully hide */
        }

        /* Transition for the central button */
        #show-add-trip-btn {
             transition: transform 0.3s ease-in-out; 
        }
        /* Class to move the central button out of view (down) */
        .button-hidden-down {
            transform: translateY(150%); /* Adjust as needed */
        }


        /* Base styles for liquid glass buttons */
        .btn-liquid-glass {
            background-color: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease; 
        }
        .btn-liquid-glass:hover { background-color: rgba(255, 255, 255, 0.05); }
        .btn-liquid-glass:active { transform: scale(0.98); } 
        
        /* Colored liquid glass button variants - INCREASED OPACITY */
        .btn-danger { background-color: rgba(239, 68, 68, 0.2); border-color: rgba(255, 100, 100, 0.1); } /* 20% opacity */
        .btn-danger:hover { background-color: rgba(220, 38, 38, 0.25); } /* Slightly more on hover */
        .btn-edit { background-color: rgba(234, 179, 8, 0.2); border-color: rgba(255, 220, 100, 0.1); } /* 20% opacity */
        .btn-edit:hover { background-color: rgba(217, 119, 6, 0.25); }
        .btn-purple { background-color: rgba(147, 51, 234, 0.2); border-color: rgba(160, 90, 240, 0.1); } /* 20% opacity */
        .btn-purple:hover{ background-color: rgba(126, 34, 206, 0.25); }
        .btn-success { background-color: rgba(34, 197, 94, 0.2); border-color: rgba(74, 222, 128, 0.1); } /* 20% opacity */
        .btn-success:hover { background-color: rgba(22, 163, 74, 0.25); }
        .btn-primary { background-color: rgba(59, 130, 246, 0.2); border-color: rgba(96, 165, 250, 0.1); } /* 20% opacity */
        .btn-primary:hover { background-color: rgba(37, 99, 235, 0.25); }
        .btn-accent { background-color: rgba(22, 163, 165, 0.2); border-color: rgba(56, 189, 248, 0.1); } /* 20% opacity */
        .btn-accent:hover { background-color: rgba(8, 145, 178, 0.25); }

        /* Language button style */
        #language-switcher {
            position: absolute;
            top: 1.5rem; /* Adjust as needed */
            right: 1.5rem; /* Adjust as needed */
            z-index: 50;
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-2 md:p-4">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100] transition-opacity duration-500">
        <svg id="welcome-truck-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 100" class="w-64 h-auto mb-8">
            <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
            <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
            <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
            <g><circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="50" cy="70" r="5" fill="#4A5568"/></g>
            <g><circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="230" cy="70" r="5" fill="#4A5568"/></g>
            <g><circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="260" cy="70" r="5" fill="#4A5568"/></g>
        </svg>
        <h1 class="text-4xl font-bold text-cyan-400 welcome-animation" data-translate-key="welcome_message">Hello Drivers, Stay safe.</h1>
    </div>

    <!-- Main Content Container -->
    <div class="main-container w-[95%] h-[95vh] max-w-7xl glass-effect rounded-2xl shadow-lg p-6 md:p-8 md:m-4 md:w-full md:h-auto md:max-w-7xl md:min-h-0 relative pb-20"> 
        
        <!-- Language Switcher Button -->
        <button id="language-switcher" class="btn-liquid-glass font-bold py-1 px-3 rounded-lg text-sm">
            <span id="language-switcher-text">EN</span> 
        </button>

        <!-- Header Section -->
        <header class="mb-6 text-center pt-8"> <!-- Added padding top -->
            <svg id="company-logo-svg" viewBox="0 0 300 100" class="h-20 w-auto mx-auto" xmlns="http://www.w3.org/2000/svg">
                <!-- Static truck SVG -->
                <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
                <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
                <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
                <g><circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="50" cy="70" r="5" fill="#4A5568"/></g>
                <g><circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="230" cy="70" r="5" fill="#4A5568"/></g>
                <g><circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/><circle cx="260" cy="70" r="5" fill="#4A5568"/></g>
            </svg>
            <h1 class="text-3xl font-bold text-cyan-400 mt-2" data-translate-key="app_title">Truck Mileage Tracker</h1>
            <p class="text-gray-300 mt-1" data-translate-key="app_subtitle">Log your trips and keep accurate track of your miles.</p>
            <button id="show-info-section-btn" class="hidden mt-4 btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="view_edit_driver_info">
                View/Edit Driver Info
            </button>
        </header>

        <!-- Driver & Vehicle Info Section (Collapsible) -->
        <div id="driver-vehicle-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> 
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold" data-translate-key="driver_vehicle_info_title">Driver & Vehicle Info</h2>
             </div>
            <!-- Info Display Area (Hidden, used for PDF data source) -->
            <div id="vehicle-info-display" class="hidden">
                <p><strong><span data-translate-key="pdf_driver">Driver</span>:</strong> <span id="display-driverName"></span></p>
                <p><strong><span data-translate-key="pdf_company">Company</span>:</strong> <span id="display-company"></span></p>
                <p><strong><span data-translate-key="pdf_truck">Truck #</span>:</strong> <span id="display-truckNumber"></span></p>
                <p><strong><span data-translate-key="pdf_trailer">Trailer #</span>:</strong> <span id="display-trailerNumber"></span></p>
                <p><strong><span data-translate-key="initial_odometer_label">Initial Odometer</span>:</strong> <span id="display-initialOdometer"></span></p>
                <p><strong><span data-translate-key="rate_per_mile_label">Rate per Mile</span>:</strong> <span id="display-ratePerMile"></span></p>
            </div>
            <!-- Info Edit Form -->
            <form id="vehicle-info-form" class="hidden"> 
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                     <div><label for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="driver_name_label">Driver Name</label><input type="text" id="driverNameInfo" data-translate-key="driver_name_placeholder" placeholder="Your Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                     <div><label for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="company_label">Company</label><input type="text" id="companyInfo" data-translate-key="company_placeholder" placeholder="Your Company Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                     <div><label for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="truck_number_label">Truck #</label><input type="text" id="truckNumberInfo" data-translate-key="truck_number_placeholder" placeholder="e.g., T-123" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                     <div><label for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="trailer_number_label">Trailer #</label><input type="text" id="trailerNumberInfo" data-translate-key="trailer_number_placeholder" placeholder="e.g., P-456" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div><label for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="initial_odometer_label">Initial Odometer</label><input type="text" inputmode="numeric" pattern="[0-9]*" id="initialOdometerInfo" data-translate-key="initial_odometer_placeholder" placeholder="e.g., 150000" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                      <div><label for="ratePerMileInfo" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="rate_per_mile_label">Rate per Mile</label><input type="text" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" id="ratePerMileInfo" data-translate-key="rate_per_mile_placeholder" placeholder="e.g., 0.70" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                 </div>
                 <div class="flex justify-end gap-4">
                      <button type="button" id="cancel-info-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg hidden" data-translate-key="cancel_button">Cancel</button>
                     <button type="submit" class="btn-liquid-glass btn-accent font-bold py-2 px-4 rounded-lg" data-translate-key="save_info_button">Save Info</button>
                 </div>
            </form>
        </div>

        <!-- Last Trip Info Display Section -->
        <div id="add-trip-btn-original-location" class="mb-8"> 
            <div class="glass-effect p-4 rounded-xl text-center">
                <h3 class="text-lg font-semibold text-gray-300 mb-2" data-translate-key="last_trip_title">Last Recorded Trip</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-200">
                    <p><strong class="text-cyan-400" data-translate-key="departure_label">Departure:</strong> <span id="last-trip-departure" data-translate-key="last_trip_na">N/A</span></p>
                    <p><strong class="text-cyan-400" data-translate-key="ending_odometer_short_label">Odometer:</strong> <span id="last-trip-odometer">N/A</span></p>
                </div>
             </div>
        </div>
        
        <!-- Add New Trip Section (Collapsible) -->
        <div id="add-trip-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> 
            <h2 class="text-xl font-semibold mb-4" data-translate-key="add_trip_title">Add New Trip</h2>
            <form id="mileage-form">
                <div class="grid grid-cols-1 md:grid-cols-8 gap-4 mb-4">
                    <div class="md:col-span-2"><label for="date" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="date_label">Date</label><input type="date" id="date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                    <div class="md:col-span-3"><label for="departure" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="departure_label">Departure</label><input type="text" id="departure" data-translate-key="departure_placeholder" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                    <div class="md:col-span-3"><label for="odometer" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="ending_odometer_label">Ending Odometer</label><input type="text" inputmode="numeric" pattern="[0-9]*" id="odometer" data-translate-key="ending_odometer_placeholder" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500"></div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-trip-btn" class="btn-liquid-glass font-bold py-2.5 px-6 rounded-lg" data-translate-key="cancel_button">Cancel</button>
                    <button type="submit" class="w-full md:w-auto btn-liquid-glass btn-accent font-bold py-2.5 px-6 rounded-lg" data-translate-key="add_trip_button">Add Trip</button>
                </div>
            </form>
        </div>

        <!-- Trip History Section -->
        <div>
            <!-- Totals & Archive Button -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm" data-translate-key="total_miles_label">Total Miles</span>
                    <span id="total-miles" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm" data-translate-key="amount_to_charge_label">Amount to Charge</span>
                    <span id="total-amount" class="font-bold text-2xl text-green-400">$0.00</span>
                </div>
                 <button type="button" id="archive-reset-btn" class="w-full btn-liquid-glass btn-danger font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2" data-translate-key="archive_reset_button">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm1-4a1 1 0 000 2h10a1 1 0 100-2H5z" clip-rule="evenodd"></path></svg>
                     Archive &amp; Reset
                 </button>
            </div>

            <!-- Collapsible History Table -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" data-translate-key="trip_history_title">Trip History</h2>
                <button id="toggle-history-table-btn" class="text-gray-300 hover:text-white p-2 rounded-full" data-translate-key="toggle_history_button_title" title="Toggle History">
                    <svg id="history-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
            <div id="history-table-container" class="hidden">
                <div class="overflow-x-auto rounded-lg glass-effect border-none">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-cyan-300 uppercase bg-white/5">
                            <tr>
                                <th scope="col" class="px-6 py-3" data-translate-key="date_label">Date</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="departure_label">Departure</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="initial_odometer_short_label">Initial Odometer</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="ending_odometer_short_label">Ending Odometer</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="miles_label">Miles</th>
                                <th scope="col" class="px-6 py-3 text-center" data-translate-key="action_label">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mileage-table-body">
                            <tr id="empty-row" class="bg-white/5 border-b border-white/10"><td colspan="6" class="text-center py-8 text-gray-400" data-translate-key="no_records_message">No records yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sticky Footer with Action Buttons -->
        <!-- Restructured for centering: Outer flex, fixed width sides, center fills space -->
        <div id="sticky-footer" class="sticky-footer flex justify-between items-center px-4 md:px-0 mt-8"> 
            <div id="backup-btn-container" class="z-40 w-1/4 flex justify-start"> <!-- Left third -->
                <button id="open-backup-modal-btn" class="btn-liquid-glass btn-success font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" data-translate-key="backup_restore_button_title" title="Backup & Restore">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </button>
            </div>
            <div class="z-40 w-1/2 flex justify-center"> <!-- Center third -->
                <button id="show-add-trip-btn" class="btn-liquid-glass btn-accent text-white font-bold p-6 rounded-full shadow-lg flex items-center justify-center mx-auto" data-translate-key="add_trip_button_title" title="Add New Trip">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                </button>
            </div>
            <div id="history-btn-container" class="z-40 w-1/4 flex justify-end"> <!-- Right third -->
                <button id="view-history-btn" class="btn-liquid-glass btn-primary font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" data-translate-key="view_history_button_title" title="View Archive History">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </button>
            </div>
        </div>

        <!-- Hidden input for file upload -->
        <input type="file" id="upload-backup-input" class="hidden" accept=".json">

    </div> <!-- End Main Content Container -->

    <!-- ========= MODALS ========= -->

    <!-- Edit Trip Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="edit-modal-content">
            <div class="p-4 border-b border-white/10 flex justify-between items-center"><h3 class="text-lg font-semibold text-yellow-400" data-translate-key="edit_trip_title">Edit Trip</h3><button id="edit-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button></div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div><label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="date_label">Date</label><input type="date" id="edit-date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500"></div>
                    <div><label for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="departure_label">Departure</label><input type="text" id="edit-departure" data-translate-key="departure_placeholder" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500"></div>
                    <div><label for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1" data-translate-key="ending_odometer_label">Ending Odometer</label><input type="text" inputmode="numeric" pattern="[0-9]*" id="edit-odometer" data-translate-key="ending_odometer_placeholder" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500"></div>
                </div>
                <div class="p-4 border-t border-white/10 flex justify-end gap-4"><button type="button" id="cancel-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="cancel_button">Cancel</button><button type="submit" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg" data-translate-key="save_changes_button">Save Changes</button></div>
            </form>
        </div>
    </div>
    
    <!-- Confirm Archive Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-modal-content">
            <div class="p-4 border-b border-white/10"><h3 class="text-lg font-semibold text-red-400" data-translate-key="confirm_action_title">Confirm Action</h3></div>
            <div class="p-6 text-gray-200"><p data-translate-key="confirm_archive_message">Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.</p></div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4"><button id="confirm-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="cancel_button">Cancel</button><button id="confirm-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg" data-translate-key="confirm_archive_button">Yes, Archive & Reset</button></div>
        </div>
    </div>

    <!-- Archive History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-4xl flex flex-col" style="height: 80vh;"> 
            <div class="p-4 border-b border-white/10 flex justify-between items-center"><h3 class="text-lg font-semibold text-blue-400" data-translate-key="archive_history_title">Archive History</h3><button id="history-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button></div>
            <div class="p-6 flex-grow overflow-y-auto modal-scrollbar" id="history-modal-content">
                <div class="overflow-x-auto rounded-lg border border-white/10">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-blue-300 uppercase bg-white/5 sticky top-0"> 
                            <tr>
                                <th scope="col" class="px-6 py-3" data-translate-key="archive_date_label">Archive Date</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="period_label">Period</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="rate_label">Rate</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="total_miles_label">Total Miles</th>
                                <th scope="col" class="px-6 py-3" data-translate-key="total_amount_label">Total Amount</th>
                                <th scope="col" class="px-6 py-3 text-center" data-translate-key="action_label">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archive-history-table-body">
                            <tr id="empty-history-row" class="bg-white/5 border-b border-white/10"><td colspan="6" class="text-center py-8 text-gray-400" data-translate-key="no_archive_history_message">No archive history yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center"><button type="button" id="clear-history-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg" data-translate-key="clear_history_button">Clear All History</button><button type="button" id="close-history-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="close_button">Close</button></div>
        </div>
    </div>

    <!-- Confirm Clear History Modal -->
    <div id="confirm-clear-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300"> 
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-modal-content">
            <div class="p-4 border-b border-white/10"><h3 class="text-lg font-semibold text-red-400" data-translate-key="confirm_clear_history_title">Clear Archive History?</h3></div>
            <div class="p-6 text-gray-200"><p data-translate-key="confirm_clear_history_message">Are you sure you want to permanently delete all archive history? This action cannot be undone.</p></div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4"><button id="confirm-clear-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="cancel_button">Cancel</button><button id="confirm-clear-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg" data-translate-key="confirm_clear_button">Yes, Clear</button></div>
        </div>
    </div>

    <!-- Backup & Restore Modal -->
    <div id="backup-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-3xl flex flex-col" style="height: 80vh;">
            <div class="p-4 border-b border-white/10 flex justify-between items-center"><h3 class="text-lg font-semibold text-green-400" data-translate-key="backup_restore_title">Backup & Restore</h3><button id="backup-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button></div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6 modal-scrollbar" id="backup-restore-modal-content">
                <div>
                    <h4 class="text-md font-semibold text-gray-200 mb-3" data-translate-key="manual_actions_label">Manual Actions</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="btn-download-backup" class="btn-liquid-glass btn-success font-bold py-3 px-4 rounded-lg" data-translate-key="download_backup_button">Download Backup File</button><button id="btn-upload-backup" class="btn-liquid-glass btn-purple font-bold py-3 px-4 rounded-lg" data-translate-key="upload_restore_button">Upload & Restore File</button></div>
                </div>
                <div>
                    <h4 class="text-md font-semibold text-gray-200 mb-3" data-translate-key="recent_backups_label">Recent Backups (Auto/Manual)</h4>
                    <div class="overflow-x-auto rounded-lg border border-white/10" style="max-height: 40vh; overflow-y: auto;">
                        <table class="w-full text-sm text-left text-gray-200">
                            <thead class="text-xs text-green-300 uppercase bg-white/5 sticky top-0"> 
                                <tr>
                                    <th scope="col" class="px-6 py-3" data-translate-key="backup_date_label">Backup Date</th>
                                    <th scope="col" class="px-6 py-3" data-translate-key="backup_type_label">Type</th>
                                    <th scope="col" class="px-6 py-3 text-center" data-translate-key="action_label">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list-body"><tr id="empty-backup-row" class="bg-white/5 border-b border-white/10"><td colspan="3" class="text-center py-8 text-gray-400" data-translate-key="no_backups_message">No backups yet.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center"><button type="button" id="clear-backups-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg" data-translate-key="clear_backups_button">Clear All Backups</button><button type="button" id="close-backup-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="close_button">Close</button></div>
        </div>
    </div>

    <!-- Confirm Restore Modal -->
    <div id="confirm-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-restore-modal-content">
            <div class="p-4 border-b border-white/10"><h3 class="text-lg font-semibold text-yellow-400" data-translate-key="confirm_restore_title">Confirm Restore</h3></div>
            <div class="p-6 text-gray-200"><p id="confirm-restore-message" data-translate-key="confirm_restore_message_default">Are you sure you want to restore from this backup? All current data will be overwritten.</p></div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4"><button id="confirm-restore-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="cancel_button">Cancel</button><button id="confirm-restore-yes-btn" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg" data-translate-key="confirm_restore_button">Yes, Restore</button></div>
        </div>
    </div>

    <!-- Confirm Clear Backups Modal -->
    <div id="confirm-clear-backups-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-backups-modal-content">
            <div class="p-4 border-b border-white/10"><h3 class="text-lg font-semibold text-red-400" data-translate-key="confirm_clear_backups_title">Clear All Backups?</h3></div>
            <div class="p-6 text-gray-200"><p data-translate-key="confirm_clear_backups_message">Are you sure you want to delete all automatic and manual backups? This action cannot be undone.</p></div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4"><button id="confirm-clear-backups-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg" data-translate-key="cancel_button">Cancel</button><button id="confirm-clear-backups-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg" data-translate-key="confirm_clear_button">Yes, Clear</button></div>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="fixed top-5 right-5 glass-effect text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =========================================================================
            //  I18N - INTERNATIONALIZATION SETUP (Configuración de Idiomas)
            // =========================================================================
            const translations = {
                en: {
                    welcome_message: "Hello Drivers, Stay safe.",
                    app_title: "Truck Mileage Tracker",
                    app_subtitle: "Log your trips and keep accurate track of your miles.",
                    view_edit_driver_info: "View/Edit Driver Info",
                    driver_vehicle_info_title: "Driver & Vehicle Info",
                    driver_name_label: "Driver Name",
                    driver_name_placeholder: "Your Name",
                    company_label: "Company",
                    company_placeholder: "Your Company Name",
                    truck_number_label: "Truck #",
                    truck_number_placeholder: "e.g., T-123",
                    trailer_number_label: "Trailer #",
                    trailer_number_placeholder: "e.g., P-456",
                    initial_odometer_label: "Initial Odometer",
                    initial_odometer_placeholder: "e.g., 150000",
                    rate_per_mile_label: "Rate per Mile",
                    rate_per_mile_placeholder: "e.g., 0.70",
                    save_info_button: "Save Info",
                    last_trip_title: "Last Recorded Trip",
                    departure_label: "Departure",
                    departure_placeholder: "City, State",
                    ending_odometer_label: "Ending Odometer",
                    ending_odometer_placeholder: "e.g., 150200",
                    ending_odometer_short_label: "Odometer",
                    last_trip_na: "N/A",
                    add_trip_title: "Add New Trip",
                    date_label: "Date",
                    add_trip_button: "Add Trip",
                    add_trip_button_title: "Add New Trip",
                    total_miles_label: "Total Miles",
                    amount_to_charge_label: "Amount to Charge",
                    archive_reset_button: "Archive & Reset",
                    trip_history_title: "Trip History",
                    toggle_history_button_title: "Toggle History",
                    initial_odometer_short_label: "Initial Odo",
                    miles_label: "Miles",
                    action_label: "Action",
                    edit_button: "Edit", // Added for table button
                    delete_button: "Delete", // Added for table button
                    no_records_message: "No records yet.",
                    backup_restore_button_title: "Backup & Restore",
                    view_history_button_title: "View Archive History",
                    edit_trip_title: "Edit Trip",
                    save_changes_button: "Save Changes",
                    confirm_action_title: "Confirm Action",
                    confirm_archive_message: "Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.",
                    confirm_archive_button: "Yes, Archive & Reset",
                    archive_history_title: "Archive History",
                    archive_date_label: "Archive Date",
                    period_label: "Period",
                    rate_label: "Rate",
                    total_amount_label: "Total Amount",
                    generate_pdf_button: "Generate PDF",
                    no_archive_history_message: "No archive history yet.",
                    clear_history_button: "Clear All History",
                    close_button: "Close",
                    confirm_clear_history_title: "Clear Archive History?",
                    confirm_clear_history_message: "Are you sure you want to permanently delete all archive history? This action cannot be undone.",
                    confirm_clear_button: "Yes, Clear",
                    backup_restore_title: "Backup & Restore",
                    manual_actions_label: "Manual Actions",
                    download_backup_button: "Download Backup File",
                    upload_restore_button: "Upload & Restore File",
                    recent_backups_label: "Recent Backups (Auto/Manual)",
                    backup_date_label: "Backup Date",
                    backup_type_label: "Type",
                    backup_type_auto: "Automatic",
                    backup_type_manual: "Manual",
                    restore_button: "Restore",
                    // delete_button: "Delete", // Already added above
                    no_backups_message: "No backups yet.",
                    clear_backups_button: "Clear All Backups",
                    confirm_restore_title: "Confirm Restore",
                    confirm_restore_message_default: "Are you sure you want to restore from this backup? All current data will be overwritten.",
                    confirm_restore_message_from_file: "Are you sure you want to restore from this file? All current data will be overwritten.",
                    confirm_restore_message_from_list: "Are you sure you want to restore the backup from {date}? All current data will be overwritten.", // {date} will be replaced
                    confirm_restore_button: "Yes, Restore",
                    confirm_clear_backups_title: "Clear All Backups?",
                    confirm_clear_backups_message: "Are you sure you want to delete all automatic and manual backups? This action cannot be undone.",
                    cancel_button: "Cancel",
                    // Notifications
                    notification_driver_info_missing: "Please save driver & vehicle info, including an initial odometer, before adding a trip.",
                    notification_odometer_low: "Ending odometer cannot be less than the initial odometer.",
                    notification_trip_updated: "Trip updated successfully.",
                    notification_trip_not_found: "Could not find trip to update.",
                    notification_no_trips_to_archive: "No trips to archive.",
                    notification_archived_success: "Trips have been archived and reset.",
                    notification_archive_history_cleared: "Archive history has been cleared.",
                    notification_pdf_generating: "Generating {count} PDF report(s)...", // {count} will be replaced
                    notification_pdf_no_data: "No data to generate a report.",
                    notification_pdf_share_error: "Could not share report for {driver}.", // {driver} will be replaced
                    notification_pdf_share_unsupported: "Browser doesn't support sharing. Downloading report for {driver}.", // {driver} will be replaced
                    notification_pdf_archive_details_missing: "Could not find detailed records for this archive entry.",
                    notification_pdf_generating_archived: "Generating PDF for archived period...",
                    notification_backup_created_manual: "Manual backup created.", // No longer used directly, but kept for translation consistency
                    notification_no_data_to_backup: "No data to back up.",
                    notification_invalid_backup_file: "Invalid backup file format.",
                    notification_read_backup_error: "Could not read backup file.",
                    notification_restore_success: "Data restored successfully. Reloading...",
                    notification_backup_deleted: "Backup deleted.",
                    notification_all_backups_cleared: "All backups cleared.",
                    notification_driver_info_saved: "Driver Info saved successfully.",
                    // PDF Specific
                    pdf_driver: "Driver",
                    pdf_company: "Company",
                    pdf_truck: "Truck #",
                    pdf_trailer: "Trailer #",
                    pdf_date_col: "Date",
                    pdf_city_col: "City",
                    pdf_initial_odo_col: "Initial Odo",
                    pdf_ending_odo_col: "Ending Odo",
                    pdf_miles_col: "Miles",
                    pdf_total_miles: "Total Miles:",
                    pdf_footer_developed: "Developed for AROHER88",
                    pdf_footer_date: "Date:",
                },
                es: {
                    welcome_message: "Hola Conductores, Cuiden su camino.",
                    app_title: "Registro de Millaje de Camión",
                    app_subtitle: "Registra tus viajes y mantén un seguimiento preciso de tus millas.",
                    view_edit_driver_info: "Ver/Editar Info Conductor",
                    driver_vehicle_info_title: "Información Conductor y Vehículo",
                    driver_name_label: "Nombre Conductor",
                    driver_name_placeholder: "Tu Nombre",
                    company_label: "Compañía",
                    company_placeholder: "Nombre de tu Compañía",
                    truck_number_label: "Camión #",
                    truck_number_placeholder: "ej., T-123",
                    trailer_number_label: "Tráiler #",
                    trailer_number_placeholder: "ej., P-456",
                    initial_odometer_label: "Odómetro Inicial",
                    initial_odometer_placeholder: "ej., 150000",
                    rate_per_mile_label: "Tarifa por Milla",
                    rate_per_mile_placeholder: "ej., 0.70",
                    save_info_button: "Guardar Info",
                    last_trip_title: "Último Viaje Registrado",
                    departure_label: "Salida",
                    departure_placeholder: "Ciudad, Estado",
                    ending_odometer_label: "Odómetro Final",
                    ending_odometer_placeholder: "ej., 150200",
                    ending_odometer_short_label: "Odómetro",
                    last_trip_na: "N/A",
                    add_trip_title: "Añadir Nuevo Viaje",
                    date_label: "Fecha",
                    add_trip_button: "Añadir Viaje",
                    add_trip_button_title: "Añadir Nuevo Viaje",
                    total_miles_label: "Millas Totales",
                    amount_to_charge_label: "Monto a Cobrar",
                    archive_reset_button: "Archivar y Resetear",
                    trip_history_title: "Historial de Viajes",
                    toggle_history_button_title: "Mostrar/Ocultar Historial",
                    initial_odometer_short_label: "Odo. Inicial",
                    miles_label: "Millas",
                    action_label: "Acción",
                    edit_button: "Editar", // Added
                    delete_button: "Borrar", // Added
                    no_records_message: "Aún no hay registros.",
                    backup_restore_button_title: "Respaldo y Restauración",
                    view_history_button_title: "Ver Historial de Archivos",
                    edit_trip_title: "Editar Viaje",
                    save_changes_button: "Guardar Cambios",
                    confirm_action_title: "Confirmar Acción",
                    confirm_archive_message: "¿Seguro que quieres archivar todos los viajes? Se descargará un reporte PDF, se añadirá un resumen al historial, se borrarán todos los registros y se actualizará el odómetro inicial. Esta acción no se puede deshacer.",
                    confirm_archive_button: "Sí, Archivar y Resetear",
                    archive_history_title: "Historial de Archivos",
                    archive_date_label: "Fecha Archivo",
                    period_label: "Periodo",
                    rate_label: "Tarifa",
                    total_amount_label: "Monto Total",
                    generate_pdf_button: "Generar PDF",
                    no_archive_history_message: "Aún no hay historial de archivos.",
                    clear_history_button: "Borrar Todo el Historial",
                    close_button: "Cerrar",
                    confirm_clear_history_title: "¿Borrar Historial de Archivos?",
                    confirm_clear_history_message: "¿Seguro que quieres borrar permanentemente todo el historial de archivos? Esta acción no se puede deshacer.",
                    confirm_clear_button: "Sí, Borrar",
                    backup_restore_title: "Respaldo y Restauración",
                    manual_actions_label: "Acciones Manuales",
                    download_backup_button: "Descargar Archivo de Respaldo",
                    upload_restore_button: "Subir y Restaurar Archivo",
                    recent_backups_label: "Respaldos Recientes (Auto/Manual)",
                    backup_date_label: "Fecha Respaldo",
                    backup_type_label: "Tipo",
                    backup_type_auto: "Automático",
                    backup_type_manual: "Manual",
                    restore_button: "Restaurar",
                    // delete_button: "Borrar", // Already added above
                    no_backups_message: "Aún no hay respaldos.",
                    clear_backups_button: "Borrar Todos los Respaldos",
                    confirm_restore_title: "Confirmar Restauración",
                    confirm_restore_message_default: "¿Seguro que quieres restaurar desde este respaldo? Todos los datos actuales serán sobreescritos.",
                    confirm_restore_message_from_file: "¿Seguro que quieres restaurar desde este archivo? Todos los datos actuales serán sobreescritos.",
                    confirm_restore_message_from_list: "¿Seguro que quieres restaurar el respaldo de {date}? Todos los datos actuales serán sobreescritos.", // {date} será reemplazado
                    confirm_restore_button: "Sí, Restaurar",
                    confirm_clear_backups_title: "¿Borrar Todos los Respaldos?",
                    confirm_clear_backups_message: "¿Seguro que quieres borrar todos los respaldos automáticos y manuales? Esta acción no se puede deshacer.",
                    cancel_button: "Cancelar",
                    // Notifications
                    notification_driver_info_missing: "Por favor, guarda la información del conductor y vehículo, incluyendo el odómetro inicial, antes de añadir un viaje.",
                    notification_odometer_low: "El odómetro final no puede ser menor que el odómetro inicial.",
                    notification_trip_updated: "Viaje actualizado correctamente.",
                    notification_trip_not_found: "No se pudo encontrar el viaje para actualizar.",
                    notification_no_trips_to_archive: "No hay viajes para archivar.",
                    notification_archived_success: "Los viajes han sido archivados y reseteados.",
                    notification_archive_history_cleared: "El historial de archivos ha sido borrado.",
                    notification_pdf_generating: "Generando {count} reporte(s) PDF...", // {count} será reemplazado
                    notification_pdf_no_data: "No hay datos para generar un reporte.",
                    notification_pdf_share_error: "No se pudo compartir el reporte para {driver}.", // {driver} será reemplazado
                    notification_pdf_share_unsupported: "El navegador no soporta compartir. Descargando reporte para {driver}.", // {driver} será reemplazado
                    notification_pdf_archive_details_missing: "No se pudieron encontrar los registros detallados para esta entrada de archivo.",
                    notification_pdf_generating_archived: "Generando PDF para periodo archivado...",
                    notification_backup_created_manual: "Respaldo manual creado.", // Ya no se usa directamente
                    notification_no_data_to_backup: "No hay datos para respaldar.",
                    notification_invalid_backup_file: "Formato de archivo de respaldo inválido.",
                    notification_read_backup_error: "No se pudo leer el archivo de respaldo.",
                    notification_restore_success: "Datos restaurados correctamente. Recargando...",
                    notification_backup_deleted: "Respaldo borrado.",
                    notification_all_backups_cleared: "Todos los respaldos borrados.",
                    notification_driver_info_saved: "Información del conductor guardada correctamente.",
                     // PDF Specific
                    pdf_driver: "Conductor",
                    pdf_company: "Compañía",
                    pdf_truck: "Camión #",
                    pdf_trailer: "Tráiler #",
                    pdf_date_col: "Fecha",
                    pdf_city_col: "Ciudad",
                    pdf_initial_odo_col: "Odo. Inicial",
                    pdf_ending_odo_col: "Odo. Final",
                    pdf_miles_col: "Millas",
                    pdf_total_miles: "Millas Totales:",
                    pdf_footer_developed: "Desarrollado para AROHER88",
                    pdf_footer_date: "Fecha:",
                }
            };
            
            let currentLanguage = localStorage.getItem('appLanguage') || 'en'; // Estado del idioma actual
            const languageSwitcher = document.getElementById('language-switcher');
            const languageSwitcherText = document.getElementById('language-switcher-text');

            /** Cambia el idioma de la aplicación y actualiza la UI. */
            const setLanguage = (lang) => {
                if (!translations[lang]) lang = 'en'; // Fallback a inglés
                currentLanguage = lang;
                localStorage.setItem('appLanguage', lang);
                document.documentElement.lang = lang; // Actualizar lang del HTML
                
                // Actualizar texto del botón de idioma
                languageSwitcherText.textContent = lang.toUpperCase();

                // Iterar sobre todos los elementos con data-translate-key
                document.querySelectorAll('[data-translate-key]').forEach(element => {
                    const key = element.getAttribute('data-translate-key');
                    const translation = translations[lang][key] || translations['en'][key] || key; // Fallback
                    
                    // Actualizar texto o placeholder según corresponda
                    if (element.placeholder !== undefined && element.hasAttribute('placeholder')) {
                        element.placeholder = translation;
                    } else if (element.title !== undefined && element.hasAttribute('title')) {
                         // Check if it's one of the footer buttons that needs dynamic title update
                        if (element.id === 'show-add-trip-btn' || element.id === 'open-backup-modal-btn' || element.id === 'view-history-btn' || element.id === 'toggle-history-table-btn') {
                             element.title = translation;
                        } else {
                            // For other elements with title, update only if it's not dynamic or complex
                             element.title = translation; // Apply cautiously
                        }
                    } 
                    else if (element.tagName === 'BUTTON' && !element.querySelector('svg')) { // Avoid overwriting button icons
                        // Special handling for buttons like Edit/Delete might be needed if they have complex content
                        if (element.classList.contains('edit-btn') || element.classList.contains('delete-btn') || element.classList.contains('generate-history-pdf-btn') || element.classList.contains('restore-backup-btn')) {
                             // Let render functions handle these specific buttons
                        } else {
                             element.textContent = translation;
                        }
                    }
                    else if (element.tagName !== 'BUTTON') { // Avoid overwriting button content in general if not text-only
                        element.textContent = translation;
                    }
                });
                
                // Forzar re-renderizado de tablas para actualizar botones internos
                 renderTable();
                 renderArchiveHistoryTable();
                 renderBackupList();
                 // Re-apply title to footer buttons after render might overwrite them
                 document.getElementById('show-add-trip-btn').title = getTranslation('add_trip_button_title');
                 document.getElementById('open-backup-modal-btn').title = getTranslation('backup_restore_button_title');
                 document.getElementById('view-history-btn').title = getTranslation('view_history_button_title');
                 document.getElementById('toggle-history-table-btn').title = getTranslation('toggle_history_button_title');
            };

            // Listener para el botón de cambio de idioma
            languageSwitcher.addEventListener('click', () => {
                const nextLang = currentLanguage === 'en' ? 'es' : 'en';
                setLanguage(nextLang);
            });
            
            // =========================================================================
            //  ELEMENT SELECTORS (Selección de Elementos del DOM) - Continuación
            // =========================================================================
            
            // --- General ---
            const welcomeScreen = document.getElementById('welcome-screen');
            const mainContainer = document.querySelector('.main-container'); 
            const stickyFooter = document.getElementById('sticky-footer'); 
            
            // --- Forms ---
            const form = document.getElementById('mileage-form'); // Formulario para añadir viaje
            const vehicleInfoForm = document.getElementById('vehicle-info-form'); // Formulario info conductor/vehículo
            const editTripForm = document.getElementById('edit-trip-form'); // Formulario editar viaje
            
            // --- Tables ---
            const tableBody = document.getElementById('mileage-table-body'); // Cuerpo de la tabla principal
            const emptyRow = document.getElementById('empty-row'); // Fila "No records yet"
            
            // --- Totals Display ---
            const totalMilesEl = document.getElementById('total-miles'); // Span para millas totales
            const totalAmountEl = document.getElementById('total-amount'); // Span para monto total
            
            // --- Driver Info Section ---
            const driverVehicleSection = document.getElementById('driver-vehicle-section'); // Sección completa
            const showInfoSectionBtn = document.getElementById('show-info-section-btn'); // Botón "View/Edit Driver Info"
            const cancelInfoEditBtn = document.getElementById('cancel-info-edit-btn'); // Botón "Cancel" en info conductor
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display'); // Div para mostrar info (oculto)
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const ratePerMileInfoInput = document.getElementById('ratePerMileInfo');
            
            // --- Driver Info Display Spans (for PDF data) ---
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');
            const displayRatePerMile = document.getElementById('display-ratePerMile');

            // --- Last Trip Display ---
            const lastTripDepartureEl = document.getElementById('last-trip-departure');
            const lastTripOdometerEl = document.getElementById('last-trip-odometer');

            // --- Add Trip Section ---
            const addTripSection = document.getElementById('add-trip-section'); // Sección completa
            const showAddTripBtn = document.getElementById('show-add-trip-btn'); // Botón grande redondo en footer
            const cancelAddTripBtn = document.getElementById('cancel-add-trip-btn'); // Botón "Cancel" en añadir viaje
            const departureInput = document.getElementById('departure'); // Input de ciudad
            
            // --- Main Control Buttons ---
            const archiveResetBtn = document.getElementById('archive-reset-btn'); // Botón "Archive & Reset"

            // --- History Table Section ---
            const toggleHistoryTableBtn = document.getElementById('toggle-history-table-btn'); // Botón para mostrar/ocultar tabla
            const historyToggleIcon = document.getElementById('history-toggle-icon'); // Icono flecha del botón
            const historyTableContainer = document.getElementById('history-table-container'); // Div contenedor tabla

            // --- Floating Buttons ---
            const backupBtnContainer = document.getElementById('backup-btn-container'); // Contenedor botón backup
            const historyBtnContainer = document.getElementById('history-btn-container'); // Contenedor botón historial
            const openBackupModalBtn = document.getElementById('open-backup-modal-btn'); // Botón backup (modal)
            const viewHistoryBtn = document.getElementById('view-history-btn'); // Botón historial (modal)

            // --- Edit Modal ---
            const editModal = document.getElementById('edit-modal');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // --- Confirm Archive Modal ---
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            // --- Archive History Modal ---
            const historyModal = document.getElementById('history-modal');
            const historyCloseBtn = document.getElementById('history-close-btn');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const archiveHistoryTableBody = document.getElementById('archive-history-table-body');
            const emptyHistoryRow = document.getElementById('empty-history-row');

            // --- Confirm Clear History Modal ---
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            const confirmClearYesBtn = document.getElementById('confirm-clear-yes-btn');
            const confirmClearNoBtn = document.getElementById('confirm-clear-no-btn');

            // --- Backup/Restore Modal ---
            const backupRestoreModal = document.getElementById('backup-restore-modal');
            const backupCloseBtn = document.getElementById('backup-close-btn');
            const closeBackupModalBtn = document.getElementById('close-backup-modal-btn');
            const btnDownloadBackup = document.getElementById('btn-download-backup');
            const btnUploadBackup = document.getElementById('btn-upload-backup');
            const uploadBackupInput = document.getElementById('upload-backup-input');
            const backupListBody = document.getElementById('backup-list-body');
            const emptyBackupRow = document.getElementById('empty-backup-row');
            const clearBackupsBtn = document.getElementById('clear-backups-btn');
            
            // --- Confirm Restore Modal ---
            const confirmRestoreModal = document.getElementById('confirm-restore-modal');
            const confirmRestoreMessage = document.getElementById('confirm-restore-message');
            const confirmRestoreYesBtn = document.getElementById('confirm-restore-yes-btn');
            const confirmRestoreNoBtn = document.getElementById('confirm-restore-no-btn');
            
            // --- Confirm Clear Backups Modal ---
            const confirmClearBackupsModal = document.getElementById('confirm-clear-backups-modal');
            const confirmClearBackupsYesBtn = document.getElementById('confirm-clear-backups-yes-btn');
            const confirmClearBackupsNoBtn = document.getElementById('confirm-clear-backups-no-btn');


            // =========================================================================
            //  STATE VARIABLES (Variables de Estado) - Continuación
            // =========================================================================
            
            // Cargar datos desde localStorage o inicializar
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || []; // Registros de viajes
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null; // Info del conductor/vehículo
            let archiveHistory = JSON.parse(localStorage.getItem('archiveHistory')) || []; // Historial de archivos
            let mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || []; // Backups guardados
            let isHistoryVisible = false; // Estado de visibilidad tabla historial
            let lastScrollTop = 0; // Para detectar dirección de scroll

            // =========================================================================
            //  HELPER FUNCTIONS (Funciones de Ayuda) - Continuación
            // =========================================================================

            /**
             * Muestra una notificación toast.
             * @param {string} message - Mensaje a mostrar (puede ser clave de traducción).
             * @param {boolean} [isError=true] - true para error (rojo), false para éxito (verde).
             */
            const showNotification = (message, isError = true) => {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                if (!notification || !notificationMessage) return;
                
                // Usar getTranslation para obtener el mensaje correcto
                notificationMessage.textContent = getTranslation(message); 

                notification.classList.remove('bg-red-600/70', 'bg-green-500/70');
                notification.classList.add(isError ? 'bg-red-600/70' : 'bg-green-500/70', 'backdrop-blur-md');
                notification.classList.remove('opacity-0');
                setTimeout(() => { notification.classList.add('opacity-0'); }, 4000);
            };

            /**
             * Convierte un elemento SVG a PNG en formato Base64.
             * @param {SVGElement} svgElement - El elemento <svg>.
             * @returns {Promise<string>} Promesa con la data URL.
             */
            const getSvgAsImageBase64 = (svgElement) => {
                return new Promise((resolve, reject) => {
                    if (!svgElement) return reject("SVG element not provided");
                    const clone = svgElement.cloneNode(true);
                    const animations = clone.querySelectorAll('animateTransform');
                    animations.forEach(anim => anim.remove()); // Quitar animaciones
                    
                    const svgString = new XMLSerializer().serializeToString(clone);
                    const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                    const url = URL.createObjectURL(svgBlob);
                    
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const viewBox = clone.getAttribute('viewBox').split(' ').map(Number);
                        canvas.width = viewBox[2];
                        canvas.height = viewBox[3];
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        URL.revokeObjectURL(url);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = (err) => { URL.revokeObjectURL(url); reject(err); };
                    img.src = url;
                });
            };
            
            /**
             * Recopila todos los datos de la app desde localStorage.
             * @returns {object} Objeto con vehicleInfo, records, y archiveHistory.
             */
            const getAllDataAsObject = () => {
                return {
                    vehicleInfo: JSON.parse(localStorage.getItem('vehicleInfo')) || null,
                    records: JSON.parse(localStorage.getItem('mileageRecords')) || [],
                    archiveHistory: JSON.parse(localStorage.getItem('archiveHistory')) || []
                };
            };

            /** Guarda los registros de viajes actuales en localStorage. */
            const saveRecordsToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            /** Guarda la información del vehículo actual en localStorage. */
            const saveVehicleInfoToLocalStorage = () => {
                localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
            };

            /** Guarda el historial de archivos actual en localStorage. */
            const saveArchiveHistoryToLocalStorage = () => {
                localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
            };

             /** Guarda la lista de backups actual en localStorage. */
            const saveBackupsToLocalStorage = () => {
                localStorage.setItem('mileageBackups', JSON.stringify(mileageBackups));
            };

            // =========================================================================
            //  UI & MODAL MANAGEMENT (Manejo de UI y Modales) - Continuación
            // =========================================================================

            /**
             * Comprueba si hay algún modal o sección colapsable abierta.
             * @returns {boolean} true si algún elemento UI está abierto.
             */
             const isUIElementOpen = () => {
                 // Comprueba si CUALQUIER modal o sección principal está visible
                 return !editModal.classList.contains('hidden') ||
                        !confirmModal.classList.contains('hidden') ||
                        !historyModal.classList.contains('hidden') ||
                        !confirmClearModal.classList.contains('hidden') ||
                        !backupRestoreModal.classList.contains('hidden') ||
                        !confirmRestoreModal.classList.contains('hidden') ||
                        !confirmClearBackupsModal.classList.contains('hidden') ||
                        !driverVehicleSection.classList.contains('hidden') || 
                        !addTripSection.classList.contains('hidden') ||
                        isHistoryVisible; // También considera si la tabla está desplegada
             };

            /** Mueve el botón central grande 'Add Trip' hacia abajo (lo oculta). */
             const moveCentralButtonDown = () => {
                 if (showAddTripBtn) {
                     showAddTripBtn.classList.add('button-hidden-down'); 
                 }
             };

            /** Mueve el botón central grande 'Add Trip' hacia arriba (lo muestra), si corresponde. */
             const moveCentralButtonUp = () => {
                 setTimeout(() => {
                    // Comprobar si las secciones que lo ocultan están cerradas
                     const addTripFormHidden = addTripSection.classList.contains('hidden');
                     const driverInfoFormHidden = driverVehicleSection.classList.contains('hidden');
                     const historyTableHidden = historyTableContainer.classList.contains('hidden'); 

                    // Solo mostrar si NINGUNA sección relevante o modal está abierta
                     if (addTripFormHidden && driverInfoFormHidden && historyTableHidden && !isUIElementOpen() && showAddTripBtn) {
                         showAddTripBtn.classList.remove('button-hidden-down');
                     }
                 }, 150); // Pequeño retraso para animaciones
             };
            
            // --- Funciones genéricas para abrir/cerrar modales ---
            /** Abre un modal específico. */
            const openModal = (modalElement) => {
                modalElement.classList.remove('hidden');
                modalElement.classList.add('flex');
                moveCentralButtonDown(); // Ocultar botón central
                stickyFooter.classList.remove('footer-hidden'); // Asegurar que footer sea visible al abrir modal
                // Forzar reflow para asegurar que la transición funcione si estaba oculto
                void stickyFooter.offsetWidth; 
            };

            /** Cierra un modal específico y reevalúa la visibilidad del botón central y footer. */
            const closeModal = (modalElement) => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('flex');
                moveCentralButtonUp(); // Intentar mostrar botón central
                // Si no hay NINGÚN otro elemento UI abierto, re-evaluar estado del footer basado en scroll
                if (!isUIElementOpen()) {
                    mainContainer.dispatchEvent(new Event('scroll')); 
                }
            };

            // --- Funciones específicas por modalidad ---
            const openEditModal = (trip) => { 
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date; // Use original YYYY-MM-DD for input
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                openModal(editModal); 
            };
            const closeEditModal = () => { editTripForm.reset(); closeModal(editModal); };
            const openConfirmModal = () => { openModal(confirmModal); };
            const closeConfirmModal = () => { closeModal(confirmModal); };
            const openHistoryModal = () => { renderArchiveHistoryTable(); openModal(historyModal); };
            const closeHistoryModal = () => { closeModal(historyModal); };
            const openConfirmClearModal = () => { confirmClearModal.classList.remove('hidden'); confirmClearModal.classList.add('flex'); /* No afecta botones */ };
            const closeConfirmClearModal = () => { confirmClearModal.classList.add('hidden'); confirmClearModal.classList.remove('flex'); };
            const openBackupModal = () => { renderBackupList(); openModal(backupRestoreModal); };
            const closeBackupModal = () => { closeModal(backupRestoreModal); };
            const openConfirmRestoreModal = (messageKey, replacements = {}) => { 
                confirmRestoreMessage.textContent = getTranslation(messageKey, replacements); 
                // Also update the data-translate-key if needed, though dynamic content might override it
                confirmRestoreMessage.setAttribute('data-translate-key', messageKey); 
                confirmRestoreModal.classList.remove('hidden'); 
                confirmRestoreModal.classList.add('flex'); 
            };
            const closeConfirmRestoreModal = () => { localStorage.removeItem('pendingRestoreData'); confirmRestoreModal.classList.add('hidden'); confirmRestoreModal.classList.remove('flex'); };
            const openConfirmClearBackupsModal = () => { confirmClearBackupsModal.classList.remove('hidden'); confirmClearBackupsModal.classList.add('flex'); };
            const closeConfirmClearBackupsModal = () => { confirmClearBackupsModal.classList.add('hidden'); confirmClearBackupsModal.classList.remove('flex'); };

            // =========================================================================
            //  DATA RENDERING & UPDATES (Renderizado y Actualización de Datos) - Continuación
            // =========================================================================

            /** Carga la info del vehículo desde el estado y actualiza la UI. */
            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                if (vehicleInfo) {
                    driverVehicleSection.classList.add('hidden'); 
                    showInfoSectionBtn.classList.remove('hidden'); 
                    // Llenar spans ocultos (para PDF)
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();
                    displayRatePerMile.textContent = (parseFloat(vehicleInfo.ratePerMile) || 0.70).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                    // Llenar formulario (para editar)
                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    ratePerMileInfoInput.value = vehicleInfo.ratePerMile || '0.70';
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.remove('hidden');
                } else {
                    driverVehicleSection.classList.remove('hidden');
                    showInfoSectionBtn.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.add('hidden');
                    ratePerMileInfoInput.value = '0.70'; 
                    moveCentralButtonDown(); 
                    stickyFooter.classList.remove('footer-hidden'); 
                }
                // Actualizar textos después de cargar - Moved to end of initialization
                // setLanguage(currentLanguage); 
            };
            
            /** Renderiza la tabla principal de historial de viajes. */
            const renderTable = () => {
                tableBody.innerHTML = ''; 
                if (records.length === 0) {
                    const emptyRowTD = emptyRow.querySelector('td');
                    if(emptyRowTD) emptyRowTD.textContent = getTranslation('no_records_message');
                    tableBody.appendChild(emptyRow.cloneNode(true));
                    archiveResetBtn.disabled = true; 
                    archiveResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    archiveResetBtn.disabled = false;
                    archiveResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => { 
                         const row = document.createElement('tr');
                         row.className = 'bg-white/5 border-b border-white/10 hover:bg-white/10';
                         row.innerHTML = `
                             <td class="px-6 py-4 font-medium whitespace-nowrap">${formatDateMMDDYY(record.date)}</td>
                             <td class="px-6 py-4">${record.departure}</td>
                             <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                             <td class="px-6 py-4">${Number(record.odometer) === 0 ? '' : Number(record.odometer).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                             <td class="px-6 py-4 font-bold text-cyan-400">${Number(record.miles) === 0 ? '' : Number(record.miles).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                             <td class="px-6 py-4 text-center whitespace-nowrap">
                                 <button data-id="${record.id}" class="edit-btn btn-liquid-glass btn-edit font-medium mr-4 px-2 py-1 rounded-lg text-sm">${getTranslation('edit_button')}</button>
                                 <button data-id="${record.id}" class="delete-btn btn-liquid-glass btn-danger font-medium px-2 py-1 rounded-lg text-sm">${getTranslation('delete_button')}</button>
                             </td>
                         `;
                         tableBody.appendChild(row);
                     });
                }
                updateTotalMiles(); 
                updateLastTripDisplay(); 
                saveRecordsToLocalStorage(); 
            };

            /** Actualiza la sección que muestra el último viaje registrado. */
            const updateLastTripDisplay = () => {
                if (records.length > 0) {
                    const lastTrip = records[records.length - 1];
                    lastTripDepartureEl.textContent = lastTrip.departure;
                    lastTripOdometerEl.textContent = lastTrip.odometer > 0 ? Number(lastTrip.odometer).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US') : getTranslation('last_trip_na');
                } else {
                    lastTripDepartureEl.textContent = getTranslation('no_records_message'); 
                    lastTripOdometerEl.textContent = '';
                }
            };
            
            /** Renderiza la tabla del historial de archivos. */
            const renderArchiveHistoryTable = () => {
                archiveHistoryTableBody.innerHTML = '';
                if (archiveHistory.length === 0) {
                     const emptyRowTD = emptyHistoryRow.querySelector('td');
                    if(emptyRowTD) emptyRowTD.textContent = getTranslation('no_archive_history_message');
                    archiveHistoryTableBody.appendChild(emptyHistoryRow.cloneNode(true));
                    clearHistoryBtn.disabled = true;
                    clearHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearHistoryBtn.disabled = false;
                    clearHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveHistory.forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';
                        // Use raw dates if available, otherwise use the potentially pre-formatted period string
                        let displayPeriod = entry.period; // Fallback
                        if (entry.rawPeriodStart && entry.rawPeriodEnd) {
                            const firstDF = formatDateMMDDYY(entry.rawPeriodStart);
                            const lastDF = formatDateMMDDYY(entry.rawPeriodEnd);
                             displayPeriod = firstDF === lastDF ? firstDF : `${firstDF} to ${lastDF}`;
                        } else if (entry.rawPeriodStart) {
                             displayPeriod = formatDateMMDDYY(entry.rawPeriodStart);
                        }

                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${entry.archiveDate}</td> {/* Locale format applied by browser */}
                            <td class="px-6 py-4">${displayPeriod}</td>
                            <td class="px-6 py-4">${(parseFloat(entry.ratePerMile || 0.70)).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 })}</td>
                            <td class="px-6 py-4">${entry.totalMiles.toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                            <td class="px-6 py-4 font-medium text-green-400">${entry.totalAmount.toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US', { style: 'currency', currency: 'USD' })}</td>
                            <td class="px-6 py-4 text-center"><button data-id="${entry.id}" class="generate-history-pdf-btn btn-liquid-glass btn-purple font-medium text-sm py-1 px-2 rounded-lg">${getTranslation('generate_pdf_button')}</button></td>
                        `;
                        archiveHistoryTableBody.appendChild(row);
                    });
                }
            };
            
            /** Renderiza la lista de backups disponibles. */
            const renderBackupList = () => {
                mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || []; // Recargar estado
                backupListBody.innerHTML = '';
                if (mileageBackups.length === 0) {
                     const emptyRowTD = emptyBackupRow.querySelector('td');
                    if(emptyRowTD) emptyRowTD.textContent = getTranslation('no_backups_message');
                    backupListBody.appendChild(emptyBackupRow.cloneNode(true));
                    clearBackupsBtn.disabled = true;
                    clearBackupsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearBackupsBtn.disabled = false;
                    clearBackupsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    mileageBackups.forEach(backup => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';
                        const backupDate = new Date(backup.timestamp).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US'); // Format date based on language
                        const typeKey = backup.type === 'auto' ? 'backup_type_auto' : 'backup_type_manual';
                        const type = getTranslation(typeKey);
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${backupDate}</td>
                            <td class="px-6 py-4">${type}</td>
                            <td class="px-6 py-4 text-center space-x-2">
                                <button data-timestamp="${backup.timestamp}" class="restore-backup-btn btn-liquid-glass btn-edit font-medium text-sm py-1 px-2 rounded-lg">${getTranslation('restore_button')}</button>
                                <button data-timestamp="${backup.timestamp}" class="delete-backup-btn btn-liquid-glass btn-danger font-medium text-sm py-1 px-2 rounded-lg">${getTranslation('delete_button')}</button>
                            </td>
                        `;
                        backupListBody.appendChild(row);
                    });
                }
            };
            
            // =========================================================================
            //  CORE FUNCTIONALITY (Funcionalidad Principal) - Continuación
            // =========================================================================

             /** Genera y maneja la descarga/compartición de un PDF. */
            const generateAndHandlePdf = async (recordsToExport, forSharing = true) => {
                if (!recordsToExport || recordsToExport.length === 0) { showNotification(getTranslation('notification_pdf_no_data')); return; }
                let logoBase64;
                try { logoBase64 = await getSvgAsImageBase64(document.getElementById('welcome-truck-svg')); } 
                catch (error) { console.warn('Could not load company logo for the PDF report.', error); }
                
                const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                showNotification(getTranslation('notification_pdf_generating', {count: uniqueDrivers.length}), false);

                for (const driver of uniqueDrivers) {
                    const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                    const driverInfo = {
                         driverName: driver,
                         company: driverRecords[0]?.company || vehicleInfo?.company || 'N/A',
                         truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber || 'N/A',
                         trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber || 'N/A',
                    };
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const totalMilesForDriver = driverRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                    let startY = 15; 
                    
                    if(logoBase64) {
                        const imgWidth = 60, imgHeight = 20;
                        const x = (doc.internal.pageSize.getWidth() - imgWidth) / 2;
                        doc.addImage(logoBase64, 'PNG', x, 15, imgWidth, imgHeight);
                        startY = 45; 
                    }
                    
                    doc.setFontSize(22); doc.setFont('helvetica', 'bold'); doc.setTextColor(50, 50, 50); 
                    doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                    startY += 8;
                    
                    // Use translated labels for PDF header parts
                    const headerParts = [
                        { text: `${getTranslation('pdf_driver')}: `, style: 'normal', color: [100, 100, 100] }, 
                        { text: driverInfo.driverName, style: 'bold', size: 13, color: [50, 50, 50] }, 
                        { text: ` | ${getTranslation('pdf_truck')}: ${driverInfo.truckNumber} | ${getTranslation('pdf_trailer')}: ${driverInfo.trailerNumber}`, style: 'normal', color: [100, 100, 100] } 
                    ];
                    let currentX = doc.internal.pageSize.getWidth() / 2;
                    const totalWidth = headerParts.reduce((sum, part) => { doc.setFont('helvetica', part.style || 'normal'); doc.setFontSize(part.size || 11); return sum + doc.getTextWidth(part.text); }, 0);
                    currentX -= totalWidth / 2;
                    headerParts.forEach(part => { doc.setFont('helvetica', part.style || 'normal'); doc.setFontSize(part.size || 11); doc.setTextColor(...(part.color || [50, 50, 50])); doc.text(part.text, currentX, startY); currentX += doc.getTextWidth(part.text); });
                    startY += 15;
                    
                    // Use translated column headers
                    const tableColumn = [
                        getTranslation('pdf_date_col'), 
                        getTranslation('pdf_city_col'), 
                        getTranslation('pdf_initial_odo_col'), 
                        getTranslation('pdf_ending_odo_col'), 
                        getTranslation('pdf_miles_col')
                    ];
                    // Format dates in table rows
                    const tableRows = driverRecords.map(r => [ 
                        formatDateMMDDYY(r.date), // Format date here
                        r.departure, 
                        Number(r.initialOdometer).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US'),
                        Number(r.odometer) === 0 ? '' : Number(r.odometer).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US'), 
                        Number(r.miles) === 0 ? '' : Number(r.miles).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US') 
                    ]);
                    // Use translated footer label
                    doc.autoTable(tableColumn, tableRows, { 
                        startY: startY,
                        headStyles: { fillColor: [22, 163, 165], textColor: [255, 255, 255] },
                        bodyStyles: { textColor: [50, 50, 50] },
                        footStyles: { fillColor: [240, 240, 240], textColor: [50, 50, 50], fontStyle: 'bold' },
                        foot: [['', '', '', getTranslation('pdf_total_miles'), totalMilesForDriver.toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US')]]
                    });
                    
                    // Use translated footer text
                    const today = new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US'); // Locale-based date
                    const pageWidth = doc.internal.pageSize.getWidth();
                    doc.setFontSize(10); doc.setFont('helvetica', 'normal'); doc.setTextColor(150, 150, 150); 
                    doc.text(getTranslation('pdf_footer_developed'), pageWidth - 14, doc.internal.pageSize.getHeight() - 15, { align: 'right' });
                    doc.text(`${getTranslation('pdf_footer_date')} ${today}`, pageWidth - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                    
                    if(forSharing) {
                        const pdfBlob = doc.output('blob'); const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' }); const shareData = { files: [pdfFile], title: `Mileage Report for ${driverInfo.driverName}` };
                        if (navigator.canShare && navigator.canShare(shareData)) { 
                            try { await navigator.share(shareData); } 
                            catch (err) { if (err.name !== 'AbortError') { showNotification(getTranslation('notification_pdf_share_error', {driver: driverInfo.driverName}));}} 
                        } else { 
                            showNotification(getTranslation('notification_pdf_share_unsupported', {driver: driverInfo.driverName}), false); 
                            doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`); 
                        }
                    } else { doc.save(`ARCHIVED_mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`); }
                }
            };

            /** Crea un backup automático si ha pasado más de una hora, manteniendo máximo 3. */
            const checkAndRunAutoBackup = () => {
                const lastBackupTime = parseInt(localStorage.getItem('lastAutoBackupTime') || '0', 10);
                const now = Date.now();
                const oneHour = 60 * 60 * 1000; 

                if (now - lastBackupTime > oneHour) {
                    const backupData = getAllDataAsObject(); 
                    if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) { console.log('No data to back up automatically.'); return; }

                    const newBackup = { timestamp: now, type: 'auto', data: backupData };
                    
                    mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || []; // Recargar estado actual
                    mileageBackups.unshift(newBackup); // Añadir nuevo al principio

                    // --- MANTENER MÁXIMO 3 BACKUPS ---
                    if (mileageBackups.length > 3) {
                        mileageBackups.pop(); // Eliminar el último (el más antiguo)
                    }
                    // --- FIN LÍMITE BACKUPS ---

                    saveBackupsToLocalStorage(); // Guardar la lista actualizada
                    localStorage.setItem('lastAutoBackupTime', now.toString());
                    console.log('Automatic backup created/updated (hourly, max 3 kept).');
                }
            };
            
            // =========================================================================
            //  EVENT LISTENERS (Escuchadores de Eventos) - Continuación
            // =========================================================================

            // --- Bienvenida ---
            setTimeout(() => { welcomeScreen.classList.add('opacity-0'); setTimeout(() => { welcomeScreen.style.display = 'none'; }, 500); }, 3000);

            // --- Formulario Info Conductor ---
            vehicleInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                vehicleInfo = { // Actualizar objeto en memoria
                    driverName: driverNameInfoInput.value, company: companyInfoInput.value, truckNumber: truckNumberInfoInput.value,
                    trailerNumber: trailerNumberInfoInput.value, initialOdometer: initialOdometerInfoInput.value,
                    ratePerMile: ratePerMileInfoInput.value || '0.70',
                };
                saveVehicleInfoToLocalStorage(); // Guardar en localStorage
                driverVehicleSection.classList.add('hidden'); // Ocultar formulario
                showInfoSectionBtn.classList.remove('hidden'); // Mostrar botón editar
                loadVehicleInfo(); // Recargar datos mostrados
                updateTotalMiles(); // Recalcular con posible nueva tarifa
                showNotification('notification_driver_info_saved', false); // Usar clave de traducción
                moveCentralButtonUp(); 
                 mainContainer.dispatchEvent(new Event('scroll')); // Re-evaluar footer
            });
            showInfoSectionBtn.addEventListener('click', () => { // Botón Editar Info
                driverVehicleSection.classList.remove('hidden'); // Mostrar formulario
                showInfoSectionBtn.classList.add('hidden'); // Ocultar botón
                moveCentralButtonDown(); 
                stickyFooter.classList.remove('footer-hidden'); // Asegurar footer visible
                void stickyFooter.offsetWidth; // Force reflow
            });
             cancelInfoEditBtn.addEventListener('click', () => { // Botón Cancelar en Info
                 if (vehicleInfo) { 
                     driverVehicleSection.classList.add('hidden'); // Ocultar formulario
                     showInfoSectionBtn.classList.remove('hidden'); // Mostrar botón editar
                     loadVehicleInfo(); // Recargar datos originales en formulario
                     moveCentralButtonUp(); 
                     mainContainer.dispatchEvent(new Event('scroll')); // Re-evaluar footer
                 } 
             });

            // --- Formulario Añadir Viaje ---
            form.addEventListener('submit', (e) => { // Al enviar nuevo viaje
                e.preventDefault();
                if (!vehicleInfo?.initialOdometer) { showNotification('notification_driver_info_missing'); return; }
                
                const initialOdo = Number(vehicleInfo.initialOdometer);
                const endingOdo = Number(document.getElementById('odometer').value) || 0;
                let miles = 0;
                let updateOdo = false;

                if (endingOdo > 0) {
                    if (endingOdo < initialOdo) { showNotification('notification_odometer_low'); return; }
                    miles = endingOdo - initialOdo;
                    updateOdo = true;
                }
                const newRecord = { id: Date.now(), date: document.getElementById('date').value, departure: departureInput.value, driverName: vehicleInfo.driverName, company: vehicleInfo.company, truckNumber: vehicleInfo.truckNumber, trailerNumber: vehicleInfo.trailerNumber, initialOdometer: initialOdo, odometer: endingOdo, miles: miles };
                records.push(newRecord); 
                records.sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id); // Ordenar por fecha, luego ID

                if (updateOdo) { vehicleInfo.initialOdometer = endingOdo; saveVehicleInfoToLocalStorage(); }
                
                form.reset(); 
                renderTable(); 
                loadVehicleInfo(); 
                addTripSection.classList.add('hidden'); 
                showAddTripBtn.classList.remove('button-hidden-down'); 
                moveCentralButtonUp(); 
                mainContainer.dispatchEvent(new Event('scroll')); 
            });
            showAddTripBtn.addEventListener('click', () => { // Botón central grande (+)
                addTripSection.classList.remove('hidden'); 
                showAddTripBtn.classList.add('button-hidden-down'); 
                moveCentralButtonDown(); 
                stickyFooter.classList.remove('footer-hidden'); 
                void stickyFooter.offsetWidth; 
            });
            cancelAddTripBtn.addEventListener('click', () => { // Botón Cancelar en Añadir Viaje
                addTripSection.classList.add('hidden'); 
                showAddTripBtn.classList.remove('button-hidden-down'); 
                form.reset();
                moveCentralButtonUp(); 
                mainContainer.dispatchEvent(new Event('scroll')); 
            });
            
            // --- Formulario Editar Viaje ---
            editTripForm.addEventListener('submit', (e) => { // Al guardar edición
                e.preventDefault();
                const tripId = Number(document.getElementById('edit-trip-id').value);
                const tripIndex = records.findIndex(r => r.id === tripId);
                if (tripIndex === -1) { showNotification('notification_trip_not_found'); return; }
                
                const updatedTrip = { ...records[tripIndex], date: document.getElementById('edit-date').value, departure: document.getElementById('edit-departure').value, odometer: Number(document.getElementById('edit-odometer').value) || 0 };
                updatedTrip.miles = updatedTrip.odometer > 0 && updatedTrip.odometer >= updatedTrip.initialOdometer ? updatedTrip.odometer - updatedTrip.initialOdometer : 0;
                if (updatedTrip.odometer > 0 && updatedTrip.odometer < updatedTrip.initialOdometer) { showNotification('notification_odometer_low'); return; }

                records[tripIndex] = updatedTrip; 
                records.sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id); // Reordenar por fecha
                
                // Recalcular odómetro inicial si se editó el ÚLTIMO registro EN FECHA
                const lastRecordByDate = records.reduce((latest, current) => (!latest || new Date(current.date) > new Date(latest.date) || (new Date(current.date).getTime() === new Date(latest.date).getTime() && current.id > latest.id)) ? current : latest, null);
                if (lastRecordByDate && lastRecordByDate.id === updatedTrip.id && updatedTrip.odometer > 0 && vehicleInfo) {
                    vehicleInfo.initialOdometer = updatedTrip.odometer;
                    saveVehicleInfoToLocalStorage();
                    loadVehicleInfo(); 
                }
                
                renderTable(); 
                closeEditModal();
                showNotification('notification_trip_updated', false);
            });
             editCloseBtn.addEventListener('click', closeEditModal); // Botón X del modal
             cancelEditBtn.addEventListener('click', closeEditModal); // Botón Cancelar del modal

            // --- Tabla Historial Viajes (Acciones y Toggle) ---
            toggleHistoryTableBtn.addEventListener('click', () => { // Botón mostrar/ocultar tabla
                isHistoryVisible = !isHistoryVisible;
                if (isHistoryVisible) {
                    historyTableContainer.classList.remove('hidden');
                    historyToggleIcon.classList.remove('rotate-180');
                    moveCentralButtonDown(); 
                    stickyFooter.classList.remove('footer-hidden'); 
                    void stickyFooter.offsetWidth; 
                } else {
                    historyTableContainer.classList.add('hidden');
                    historyToggleIcon.classList.add('rotate-180');
                    moveCentralButtonUp(); 
                    if (!isUIElementOpen()) { mainContainer.dispatchEvent(new Event('scroll')); } 
                }
            });
            tableBody.addEventListener('click', (e) => { // Clicks en botones Editar/Borrar
                if (e.target.classList.contains('delete-btn')) { // Botón Borrar
                    const idToDelete = Number(e.target.dataset.id);
                    // Find the record to potentially update odometer if it was the last one
                    const deletedRecordIndex = records.findIndex(r => r.id === idToDelete);
                    if (deletedRecordIndex > -1) {
                         const deletedRecord = records[deletedRecordIndex];
                         records = records.filter(record => record.id !== idToDelete); // Remove the record
                         
                         // Check if the deleted record was the last one by date/id
                         const lastRecordByDate = records.reduce((latest, current) => (!latest || new Date(current.date) > new Date(latest.date) || (new Date(current.date).getTime() === new Date(latest.date).getTime() && current.id > latest.id)) ? current : latest, null);

                         // If the deleted one WAS the last, and there are previous records, update odometer from the NEW last record
                         if ((!lastRecordByDate || lastRecordByDate.id !== deletedRecord.id) && vehicleInfo) { 
                             const newLastRecord = records.reduce((latest, current) => (!latest || new Date(current.date) > new Date(latest.date) || (new Date(current.date).getTime() === new Date(latest.date).getTime() && current.id > latest.id)) ? current : latest, null);
                             if (newLastRecord && newLastRecord.odometer > 0) {
                                 vehicleInfo.initialOdometer = newLastRecord.odometer;
                             } else if (records.length === 0 && vehicleInfo) {
                                 // If deleting the VERY last record, revert to original initial odometer? Or ask user?
                                 // For now, let's keep the last known odometer. Or maybe revert? Let's keep it simple: keep the odo from the deleted record IF it was the only one.
                                 // Reverting might be complex if initialOdometerInfo wasn't the absolute start.
                                 // Let's reset to the initial one stored when the user first entered info? Risky.
                                 // Safest: if no records left, keep the odometer from the deleted record.
                                 // Alternative: Reset initialOdometerInfoInput value?
                                 // Let's just update if there's a NEW last record. If not, the initialOdometer stays.
                             }
                             if (newLastRecord && newLastRecord.odometer > 0 && vehicleInfo) {
                                vehicleInfo.initialOdometer = newLastRecord.odometer;
                                saveVehicleInfoToLocalStorage();
                                loadVehicleInfo(); // Reload display if odometer changed
                             } else if (records.length === 0 && vehicleInfo) {
                                 // Maybe prompt user or have a dedicated "Reset Initial Odometer" button?
                                 // For now, do nothing if deleting the last record and no prior records exist.
                                 // We need the original initial odometer saved somewhere robustly.
                                 // Let's stick to only updating if there's a *new* last record with a valid odometer.
                             }
                         }
                         renderTable(); // Update table and save
                    }
                } else if (e.target.classList.contains('edit-btn')) { // Botón Editar
                    const tripToEdit = records.find(r => r.id === Number(e.target.dataset.id));
                    if (tripToEdit) { openEditModal(tripToEdit); }
                }
            });
            
            // --- Archivar y Resetear ---
            archiveResetBtn.addEventListener('click', openConfirmModal); 
            confirmNoBtn.addEventListener('click', closeConfirmModal); 
            confirmYesBtn.addEventListener('click', async () => { 
                if (records.length === 0) { showNotification('notification_no_trips_to_archive'); closeConfirmModal(); return; }
                
                await generateAndHandlePdf(records, false); 

                const rate = parseFloat(vehicleInfo?.ratePerMile || '0.70');
                const totalM = records.reduce((s, r) => s + Number(r.miles), 0);
                const firstRecord = records[0];
                const lastRecord = records[records.length - 1];
                const firstDF = firstRecord?.date ? formatDateMMDDYY(firstRecord.date) : '';
                const lastDF = lastRecord?.date ? formatDateMMDDYY(lastRecord.date) : '';
                const period = firstDF === lastDF ? firstDF : `${firstDF} to ${lastDF}`;
                
                archiveHistory.unshift({ id: Date.now(), archiveDate: new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US'),
                    period: period, 
                    rawPeriodStart: firstRecord?.date, 
                    rawPeriodEnd: lastRecord?.date, 
                    totalMiles: totalM, totalAmount: totalM * rate,
                    detailedRecords: [...records], ratePerMile: rate });
                saveArchiveHistoryToLocalStorage();

                // Find the last record chronologically with a valid odometer before clearing
                 const lastValidRecordBeforeClear = [...records]
                    .sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id) // Sort descending by date, then id
                    .find(r => r.odometer > 0); 

                if (lastValidRecordBeforeClear && vehicleInfo) { 
                    vehicleInfo.initialOdometer = lastValidRecordBeforeClear.odometer; 
                    saveVehicleInfoToLocalStorage(); 
                }

                records = []; 
                renderTable(); 
                loadVehicleInfo(); 
                closeConfirmModal();
                showNotification('notification_archived_success', false);
            });
            
            // --- Modal Historial de Archivos ---
            viewHistoryBtn.addEventListener('click', openHistoryModal); 
            historyCloseBtn.addEventListener('click', closeHistoryModal); 
            closeHistoryModalBtn.addEventListener('click', closeHistoryModal); 
            clearHistoryBtn.addEventListener('click', openConfirmClearModal); 
            confirmClearNoBtn.addEventListener('click', closeConfirmClearModal); 
            confirmClearYesBtn.addEventListener('click', () => { 
                archiveHistory = [];
                saveArchiveHistoryToLocalStorage();
                renderArchiveHistoryTable(); 
                closeConfirmClearModal();
                showNotification('notification_archive_history_cleared', false);
            });
            archiveHistoryTableBody.addEventListener('click', async (e) => { 
                if (e.target.classList.contains('generate-history-pdf-btn')) {
                    const entry = archiveHistory.find(item => item.id === Number(e.target.dataset.id));
                    if (entry?.detailedRecords) {
                        showNotification('notification_pdf_generating_archived', false);
                        await generateAndHandlePdf(entry.detailedRecords, true); 
                    } else { showNotification('notification_pdf_archive_details_missing'); }
                }
            });

             // --- Modal Backup & Restore ---
            openBackupModalBtn.addEventListener('click', openBackupModal); 
            backupCloseBtn.addEventListener('click', closeBackupModal); 
            closeBackupModalBtn.addEventListener('click', closeBackupModal); 
            btnDownloadBackup.addEventListener('click', () => { 
                const backupData = getAllDataAsObject();
                if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) { showNotification(getTranslation('notification_no_data_to_backup')); return; }
                const json = JSON.stringify(backupData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `truck_mileage_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click(); URL.revokeObjectURL(url); a.remove();
            });
            btnUploadBackup.addEventListener('click', () => { uploadBackupInput.click(); }); 
            uploadBackupInput.addEventListener('change', (e) => { 
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.vehicleInfo !== undefined && data.records !== undefined && data.archiveHistory !== undefined) { 
                            localStorage.setItem('pendingRestoreData', JSON.stringify(data)); 
                            openConfirmRestoreModal('confirm_restore_message_from_file'); 
                        } else { showNotification('notification_invalid_backup_file'); }
                    } catch (err) { showNotification('notification_read_backup_error'); }
                    e.target.value = null; 
                };
                reader.readAsText(file);
            });

            // --- Confirmación Restaurar ---
            confirmRestoreNoBtn.addEventListener('click', closeConfirmRestoreModal); 
            confirmRestoreYesBtn.addEventListener('click', () => { 
                const dataJSON = localStorage.getItem('pendingRestoreData'); if (!dataJSON) return;
                const data = JSON.parse(dataJSON);
                localStorage.setItem('vehicleInfo', JSON.stringify(data.vehicleInfo));
                localStorage.setItem('mileageRecords', JSON.stringify(data.records));
                localStorage.setItem('archiveHistory', JSON.stringify(data.archiveHistory));
                localStorage.removeItem('pendingRestoreData'); 
                closeConfirmRestoreModal();
                closeBackupModal(); 
                showNotification('notification_restore_success', false);
                setTimeout(() => { location.reload(); }, 1500); 
            });
            
            // --- Acciones en Lista de Backups (Restaurar/Borrar) ---
            backupListBody.addEventListener('click', (e) => {
                const timestamp = e.target.dataset.timestamp; if (!timestamp) return;
                if (e.target.classList.contains('restore-backup-btn')) { 
                    const backup = mileageBackups.find(b => b.timestamp == timestamp);
                    if (backup) {
                        localStorage.setItem('pendingRestoreData', JSON.stringify(backup.data));
                        const dateString = new Date(Number(timestamp)).toLocaleString(currentLanguage === 'es' ? 'es-ES' : 'en-US');
                        openConfirmRestoreModal('confirm_restore_message_from_list', { date: dateString });
                    }
                } else if (e.target.classList.contains('delete-backup-btn')) { 
                    mileageBackups = mileageBackups.filter(b => b.timestamp != timestamp);
                    saveBackupsToLocalStorage();
                    renderBackupList(); 
                    showNotification('notification_backup_deleted', false);
                }
            });

            // --- Limpiar Todos los Backups ---
            clearBackupsBtn.addEventListener('click', openConfirmClearBackupsModal); 
            confirmClearBackupsNoBtn.addEventListener('click', closeConfirmClearBackupsModal); 
            confirmClearBackupsYesBtn.addEventListener('click', () => { 
                mileageBackups = [];
                saveBackupsToLocalStorage();
                localStorage.removeItem('lastAutoBackupTime'); 
                renderBackupList(); 
                closeConfirmClearBackupsModal();
                showNotification('notification_all_backups_cleared', false);
            });
            
            // --- Listener Scroll para Ocultar/Mostrar Footer ---
            mainContainer.addEventListener('scroll', () => {
                const currentScroll = mainContainer.scrollTop;
                const threshold = 5; 

                // Solo ocultar/mostrar si NO hay modal/sección abierta
                if (!isUIElementOpen()) {
                    if (currentScroll > lastScrollTop && currentScroll > threshold) { // Abajo
                        stickyFooter.classList.add('footer-hidden');
                        showAddTripBtn.classList.add('button-hidden-down'); 
                    } else if (currentScroll < lastScrollTop) { // Arriba
                        stickyFooter.classList.remove('footer-hidden');
                        showAddTripBtn.classList.remove('button-hidden-down'); 
                    }
                } else {
                    // Si algo está abierto, asegurar que el footer esté visible
                    stickyFooter.classList.remove('footer-hidden');
                    // Mantener el botón central oculto si la sección AddTrip está abierta
                    if(!addTripSection.classList.contains('hidden')) {
                       showAddTripBtn.classList.add('button-hidden-down'); 
                    } else {
                       showAddTripBtn.classList.remove('button-hidden-down');
                    }
                }
                lastScrollTop = currentScroll <= 0 ? 0 : currentScroll; 
            });


            // =========================================================================
            //  INITIALIZATION (Inicialización al Cargar la Página)
            // =========================================================================
            
            loadVehicleInfo(); // Cargar info conductor
            renderTable(); // Renderizar tabla principal
            checkAndRunAutoBackup(); // Comprobar si toca backup automático
            setLanguage(currentLanguage); // Aplicar idioma guardado o por defecto AHORA, después de cargar datos iniciales

            // Estado inicial del botón central y footer
             if (!addTripSection.classList.contains('hidden') || !driverVehicleSection.classList.contains('hidden') || isHistoryVisible) {
                 moveCentralButtonDown(); 
                 stickyFooter.classList.remove('footer-hidden'); // Ensure visible if section is open initially
            } else {
                 moveCentralButtonUp(); 
                 stickyFooter.classList.remove('footer-hidden'); // Ensure visible initially
            }
             // Trigger scroll once to set initial state based on position (likely top)
            mainContainer.dispatchEvent(new Event('scroll')); 


        });
    </script>

</body>
</html>

