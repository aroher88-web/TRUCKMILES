<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Mileage Tracker</title>
    <!-- Added typography plugin for better markdown rendering in modal -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF Libraries for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple animation for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Custom scrollbar for modal content */
        #modal-content::-webkit-scrollbar, .filter-modal-content::-webkit-scrollbar, #edit-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #modal-content::-webkit-scrollbar-track, .filter-modal-content::-webkit-scrollbar-track, #edit-modal-content::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        #modal-content::-webkit-scrollbar-thumb, .filter-modal-content::-webkit-scrollbar-thumb, #edit-modal-content::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        #modal-content::-webkit-scrollbar-thumb:hover, .filter-modal-content::-webkit-scrollbar-thumb:hover, #edit-modal-content::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-center text-cyan-400">Truck Mileage Tracker</h1>
            <p class="text-center text-gray-400 mt-2">Log your trips and keep accurate track of your miles.</p>
        </header>

        <!-- Driver & Vehicle Info Section -->
        <div class="bg-gray-700 p-6 rounded-xl mb-8">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Driver & Vehicle Info</h2>
                <button id="edit-info-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hidden">Edit Info</button>
            </div>
            <div id="vehicle-info-display" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 text-gray-300">
                    <p><strong>Driver:</strong> <span id="display-driverName"></span></p>
                    <p><strong>Company:</strong> <span id="display-company"></span></p>
                    <p><strong>Truck #:</strong> <span id="display-truckNumber"></span></p>
                    <p><strong>Trailer #:</strong> <span id="display-trailerNumber"></span></p>
                    <p><strong>Initial Odometer:</strong> <span id="display-initialOdometer"></span></p>
                </div>
            </div>
            <form id="vehicle-info-form" class="">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1">Driver Name</label>
                        <input type="text" id="driverNameInfo" placeholder="Your Name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
                        <input type="text" id="companyInfo" placeholder="Your Company Name" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Truck #</label>
                        <input type="text" id="truckNumberInfo" placeholder="e.g., T-123" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                     <div>
                        <label for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Trailer #</label>
                        <input type="text" id="trailerNumberInfo" placeholder="e.g., P-456" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="mb-4">
                     <label for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1">Initial Odometer</label>
                     <input type="number" id="initialOdometerInfo" placeholder="e.g., 150000" required class="w-full md:w-1/4 bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Save Info</button>
                </div>
            </form>
        </div>

        <div class="bg-gray-700 p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Trip</h2>
            <form id="mileage-form">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="departure" placeholder="City, State" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="number" id="odometer" placeholder="e.g., 150200" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300">
                        Add Trip
                    </button>
                </div>
            </form>
        </div>

        <div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h2 class="text-xl font-semibold">Trip History</h2>
                <div class="flex flex-wrap items-center gap-4">
                    <button type="button" id="generate-report-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" disabled>
                        ✨ Generate AI Report
                    </button>
                    <button type="button" id="export-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                        Export to CSV
                    </button>
                     <button type="button" id="share-pdf-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                        Share PDF
                    </button>
                    <div class="bg-gray-700 rounded-lg p-3 flex items-center">
                        <span class="font-medium text-gray-300">Total Miles:</span>
                        <span id="total-miles" class="font-bold text-2xl text-cyan-400 ml-3">0</span>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-cyan-300 uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3"><input type="checkbox" id="select-all-checkbox" class="rounded border-gray-500 bg-gray-800 text-cyan-600 focus:ring-cyan-500"></th>
                            <th scope="col" class="px-6 py-3">Date</th>
                            <th scope="col" class="px-6 py-3">Driver</th>
                            <th scope="col" class="px-6 py-3">Departure</th>
                            <th scope="col" class="px-6 py-3">Initial Odometer</th>
                            <th scope="col" class="px-6 py-3">Ending Odometer</th>
                            <th scope="col" class="px-6 py-3">Company</th>
                            <th scope="col" class="px-6 py-3">Truck #</th>
                            <th scope="col" class="px-6 py-3">Trailer #</th>
                            <th scope="col" class="px-6 py-3">Miles</th>
                            <th scope="col" class="px-6 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="mileage-table-body">
                        <tr id="empty-row" class="bg-gray-800 border-b border-gray-700">
                           <td colspan="11" class="text-center py-8 text-gray-500">No records yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Gemini Output -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-semibold text-cyan-400">✨ AI Powered Insights</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto">
                <div id="modal-loader" class="text-center py-8">
                    <svg class="animate-spin h-8 w-8 text-cyan-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-gray-300">Generating response...</p>
                </div>
                <div id="modal-text" class="prose prose-invert max-w-none text-gray-300"></div>
            </div>
            <div id="modal-footer" class="p-4 border-t border-gray-600 text-right hidden">
                <button id="copy-report-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">Copy to Clipboard</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for CSV Filter -->
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-lg filter-modal-content">
            <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                <h3 id="filter-modal-title" class="text-lg font-semibold text-blue-400">Filter CSV Report</h3>
                <button class="filter-close-btn text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="filter-city" class="block text-sm font-medium text-gray-300 mb-1">City (Departure)</label>
                        <input type="text" id="filter-city" placeholder="Leave blank for all cities" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-300 mb-1">Start Date</label>
                        <input type="date" id="filter-start-date" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-300 mb-1">End Date</label>
                        <input type="date" id="filter-end-date" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-600 flex justify-end gap-4">
                <button class="cancel-filter-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="generate-filtered-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Generate CSV</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Editing a Trip -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-gray-700 rounded-2xl shadow-xl w-full max-w-lg" id="edit-modal-content">
            <div class="p-4 border-b border-gray-600 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-yellow-400">Edit Trip</h3>
                <button id="edit-close-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="edit-departure" placeholder="City, State" required class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="number" id="edit-odometer" placeholder="e.g., 150200" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-600 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Notification Element -->
    <div id="notification" class="fixed top-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>


    <script>
        // --- Global Notification Function ---
        const showNotification = (message, isError = true) => {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            if (!notification || !notificationMessage) return;

            notificationMessage.textContent = message;
            notification.classList.remove('bg-red-600', 'bg-green-500');
            notification.classList.add(isError ? 'bg-red-600' : 'bg-green-500');
            notification.classList.remove('opacity-0');
            setTimeout(() => {
                notification.classList.add('opacity-0');
            }, 4000);
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            
            const form = document.getElementById('mileage-form');
            const tableBody = document.getElementById('mileage-table-body');
            const totalMilesEl = document.getElementById('total-miles');
            const emptyRow = document.getElementById('empty-row');
            const departureInput = document.getElementById('departure');
            const vehicleInfoForm = document.getElementById('vehicle-info-form');
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display');
            const editInfoBtn = document.getElementById('edit-info-btn');
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const sharePdfBtn = document.getElementById('share-pdf-btn');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            // Modals
            const modal = document.getElementById('gemini-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalLoader = document.getElementById('modal-loader');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalFooter = document.getElementById('modal-footer');
            const copyReportBtn = document.getElementById('copy-report-btn');
            const filterModal = document.getElementById('filter-modal');
            const filterModalTitle = document.getElementById('filter-modal-title');
            const generateFilteredCsvBtn = document.getElementById('generate-filtered-csv-btn');
            const editModal = document.getElementById('edit-modal');
            const editTripForm = document.getElementById('edit-trip-form');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || [];
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;

            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                if (vehicleInfo) {
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();

                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    
                    vehicleInfoDisplay.classList.remove('hidden');
                    vehicleInfoForm.classList.add('hidden');
                    editInfoBtn.classList.remove('hidden');
                } else {
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden');
                    editInfoBtn.classList.add('hidden');
                }
            };
            
            editInfoBtn.addEventListener('click', () => {
                vehicleInfoDisplay.classList.add('hidden');
                vehicleInfoForm.classList.remove('hidden');
            });

            vehicleInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newInfo = {
                    driverName: driverNameInfoInput.value,
                    company: companyInfoInput.value,
                    truckNumber: truckNumberInfoInput.value,
                    trailerNumber: trailerNumberInfoInput.value,
                    initialOdometer: initialOdometerInfoInput.value,
                };
                localStorage.setItem('vehicleInfo', JSON.stringify(newInfo));
                loadVehicleInfo();
            });


            const callGeminiApi = async (prompt) => {
                const apiKey = ""; // Leave as-is for Canvas environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error.message}`);
                    }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response text found.";
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return `Error: Could not retrieve data from the AI. ${error.message}`;
                }
            };

            const showModal = (title, isLoading = true, showFooter = false) => {
                modalTitle.textContent = title;
                modalLoader.style.display = isLoading ? 'block' : 'none';
                modalText.style.display = isLoading ? 'none' : 'block';
                modalText.innerHTML = '';
                modalFooter.style.display = showFooter ? 'flex' : 'none';
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            };

            const hideModal = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
            
            const renderTable = () => {
                tableBody.innerHTML = '';
                
                if (records.length === 0) {
                    tableBody.appendChild(emptyRow.cloneNode(true));
                    exportCsvBtn.disabled = true;
                    sharePdfBtn.disabled = true;
                    exportCsvBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    sharePdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    exportCsvBtn.disabled = false;
                    sharePdfBtn.disabled = false;
                    exportCsvBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    sharePdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600/50';
                        row.innerHTML = `
                            <td class="px-4 py-4"><input type="checkbox" class="trip-checkbox rounded border-gray-500 bg-gray-800 text-cyan-600 focus:ring-cyan-500" data-id="${record.id}"></td>
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${record.date}</td>
                            <td class="px-6 py-4">${record.driverName}</td>
                            <td class="px-6 py-4">${record.departure}</td>
                            <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${Number(record.odometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${record.company}</td>
                            <td class="px-6 py-4">${record.truckNumber}</td>
                            <td class="px-6 py-4">${record.trailerNumber}</td>
                            <td class="px-6 py-4 font-bold text-cyan-400">${Number(record.miles).toLocaleString()}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${record.id}" class="edit-btn text-yellow-500 hover:text-yellow-400 font-medium mr-4">Edit</button>
                                <button data-id="${record.id}" class="delete-btn text-red-500 hover:text-red-400 font-medium">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                updateTotalMiles();
                saveToLocalStorage();
                updateReportButtonState();
                selectAllCheckbox.checked = false;
            };

            const updateTotalMiles = () => {
                const total = records.reduce((sum, record) => sum + Number(record.miles), 0);
                totalMilesEl.textContent = total.toLocaleString();
            };
            const saveToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            const updateReportButtonState = () => {
                const checkedBoxes = document.querySelectorAll('.trip-checkbox:checked');
                generateReportBtn.disabled = checkedBoxes.length === 0;
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();

                if (!vehicleInfo || vehicleInfo.initialOdometer === undefined) {
                    showNotification('Please save driver & vehicle info, including an initial odometer, before adding a trip.');
                    return;
                }

                const initialOdometer = Number(vehicleInfo.initialOdometer);
                const endingOdometerInput = document.getElementById('odometer').value;
                const endingOdometer = endingOdometerInput ? Number(endingOdometerInput) : 0;

                let tripMiles = 0;
                let shouldUpdateOdometer = false;

                if (endingOdometer > 0) {
                    if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer.');
                        return;
                    }
                    tripMiles = endingOdometer - initialOdometer;
                    shouldUpdateOdometer = true;
                }

                const newRecord = {
                    id: Date.now(),
                    date: document.getElementById('date').value,
                    departure: departureInput.value,
                    driverName: vehicleInfo.driverName,
                    company: vehicleInfo.company,
                    truckNumber: vehicleInfo.truckNumber,
                    trailerNumber: vehicleInfo.trailerNumber,
                    initialOdometer: initialOdometer,
                    odometer: endingOdometer,
                    miles: tripMiles,
                };

                records.push(newRecord);
                records.sort((a, b) => b.id - a.id); // Sort by creation timestamp
                
                if (shouldUpdateOdometer) {
                    vehicleInfo.initialOdometer = endingOdometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }
                
                form.reset();
                renderTable();
                loadVehicleInfo(); 
            });
            
            const exportToCsv = (recordsToExport) => {
                if (!recordsToExport || recordsToExport.length === 0) {
                    showNotification('No data matches the filter criteria.');
                    return;
                }
                const headers = ["Date", "Driver", "Departure", "Initial Odometer", "Ending Odometer", "Company", "Truck #", "Trailer #", "Miles"];
                const csvContent = [
                    headers.join(','),
                    ...recordsToExport.map(record => [
                        record.date, `"${record.driverName}"`, `"${record.departure}"`,
                        record.initialOdometer, record.odometer, `"${record.company}"`,
                        record.truckNumber, record.trailerNumber, record.miles
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "filtered_mileage_report.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("CSV report generated.", false);
            };
            
            const generateAndSharePdf = async (recordsToExport) => {
                 if (!recordsToExport || recordsToExport.length === 0) {
                    showNotification('No data to generate a report.');
                    return;
                }

                const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                
                showNotification(`Generating ${uniqueDrivers.length} PDF report(s)...`, false);

                for (const driver of uniqueDrivers) {
                    const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                     const driverInfo = {
                        driverName: driver,
                        company: driverRecords[0]?.company || vehicleInfo?.company,
                        truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber,
                        trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber,
                    };

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const totalMilesForDriver = driverRecords.reduce((sum, record) => sum + Number(record.miles), 0);

                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(50);
                    const headerText = `Driver: ${driverInfo.driverName} | Truck #: ${driverInfo.truckNumber} | Trailer #: ${driverInfo.trailerNumber}`;
                    doc.text(headerText, doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });

                    const tableColumn = ["Date", "City", "Odometer", "Miles"];
                    const tableRows = driverRecords.map(r => [r.date, r.departure, Number(r.odometer).toLocaleString(), Number(r.miles).toLocaleString()]);
                    
                    doc.autoTable(tableColumn, tableRows, { startY: 45 });
                    const finalY = doc.lastAutoTable.finalY || 45;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Total Miles: ${totalMilesForDriver.toLocaleString()}`, 14, finalY + 15);
                    
                    const pdfBlob = doc.output('blob');
                    const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' });
                    const shareData = {
                        files: [pdfFile],
                        title: `Mileage Report for ${driverInfo.driverName}`,
                        text: `Mileage report for ${driverInfo.driverName}.`,
                    };

                    if (navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                               console.error('Share failed:', err.message);
                               showNotification(`Could not share report for ${driverInfo.driverName}.`);
                            }
                        }
                    } else {
                        showNotification(`Browser doesn't support sharing. Downloading report for ${driverInfo.driverName}.`, false);
                        doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                    }
                }
            };
            
            const openFilterModal = () => {
                filterModalTitle.textContent = `Filter CSV Report`;
                generateFilteredCsvBtn.textContent = `Generate CSV`;
                filterModal.classList.remove('hidden');
                filterModal.classList.add('flex');
            };

            exportCsvBtn.addEventListener('click', openFilterModal);

            sharePdfBtn.addEventListener('click', () => {
                if (records.length === 0) {
                    showNotification('No trip data to share.');
                    return;
                }
                generateAndSharePdf(records);
            });

            const closeFilterModal = () => {
                filterModal.classList.add('hidden');
                filterModal.classList.remove('flex');
                document.getElementById('filter-city').value = '';
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
            };

            document.querySelectorAll('.filter-close-btn, .cancel-filter-btn').forEach(btn => {
                btn.addEventListener('click', closeFilterModal);
            });
            
            generateFilteredCsvBtn.addEventListener('click', () => {
                const city = document.getElementById('filter-city').value.trim().toLowerCase();
                const startDate = document.getElementById('filter-start-date').value;
                const endDate = document.getElementById('filter-end-date').value;

                const filteredRecords = records.filter(record => {
                    const departureCity = record.departure || '';
                    const matchesCity = !city || departureCity.toLowerCase().includes(city);
                    const recordDate = new Date(record.date + 'T00:00:00'); 
                    const matchesStartDate = !startDate || recordDate >= new Date(startDate + 'T00:00:00');
                    const matchesEndDate = !endDate || recordDate <= new Date(endDate + 'T00:00:00');
                    return matchesCity && matchesStartDate && matchesEndDate;
                });
                
                exportToCsv(filteredRecords);
                closeFilterModal();
            });

            // --- Edit Modal Logic ---
            const openEditModal = (trip) => {
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date;
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            };

            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editTripForm.reset();
            };

            editCloseBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);

            editTripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const tripId = Number(document.getElementById('edit-trip-id').value);
                const tripIndex = records.findIndex(r => r.id === tripId);
                
                if (tripIndex === -1) {
                    showNotification('Could not find trip to update.');
                    return;
                }

                const updatedTrip = {
                    ...records[tripIndex],
                    date: document.getElementById('edit-date').value,
                    departure: document.getElementById('edit-departure').value,
                    odometer: Number(document.getElementById('edit-odometer').value)
                };
                
                // Recalculate miles for the edited trip
                const endingOdometer = updatedTrip.odometer;
                const initialOdometer = updatedTrip.initialOdometer;

                if (endingOdometer > 0) {
                     if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer for this trip.');
                        return;
                    }
                    updatedTrip.miles = endingOdometer - initialOdometer;
                } else {
                    updatedTrip.miles = 0;
                }
                
                records[tripIndex] = updatedTrip;
                records.sort((a, b) => b.id - a.id); // Sort by creation timestamp

                renderTable();
                saveToLocalStorage();
                closeEditModal();
                showNotification('Trip updated successfully.', false);
            });


            generateReportBtn.addEventListener('click', async () => { 
                const checkedBoxes = document.querySelectorAll('.trip-checkbox:checked');
                const selectedIds = Array.from(checkedBoxes).map(cb => Number(cb.dataset.id));
                const selectedRecords = records.filter(r => selectedIds.includes(r.id));
                if (selectedRecords.length === 0) return;
                showModal('✨ Trip Report', true, true);
                const prompt = `Act as a professional logistics coordinator. Create a formal trip report based on the following data. Start with a title "Trip Report". Then, provide a brief summary including the total number of trips and total miles covered. Finally, list each trip clearly using markdown. The data is provided in JSON format. \n\nTRIP DATA:\n${JSON.stringify(selectedRecords, null, 2)}`;
                const report = await callGeminiApi(prompt);
                modalLoader.style.display = 'none';
                modalText.style.display = 'block';
                let htmlReport = report
                    .replace(/### (.*)/g, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
                    .replace(/## (.*)/g, '<h2 class="text-xl font-bold mt-6 mb-3">$1</h2>')
                    .replace(/# (.*)/g, '<h1 class="text-2xl font-bold mb-4">$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\* (.*)/g, '<li class="ml-4 list-disc">$1</li>')
                    .replace(/\n/g, '<br>');
                modalText.innerHTML = htmlReport;
             });
            copyReportBtn.addEventListener('click', () => { 
                const textToCopy = modalText.innerText;
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = textToCopy;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    copyReportBtn.textContent = 'Copied!';
                    setTimeout(() => { copyReportBtn.textContent = 'Copy to Clipboard'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    copyReportBtn.textContent = 'Copy Failed';
                }
                document.body.removeChild(tempTextarea);
            });
            
            modalCloseBtn.addEventListener('click', hideModal);

            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = Number(e.target.dataset.id);
                    records = records.filter(record => record.id !== idToDelete);
                    renderTable();
                } else if (e.target.classList.contains('edit-btn')) {
                    const idToEdit = Number(e.target.dataset.id);
                    const tripToEdit = records.find(r => r.id === idToEdit);
                    if (tripToEdit) {
                        openEditModal(tripToEdit);
                    }
                }
            });

            tableBody.addEventListener('change', (e) => {
                if (e.target.classList.contains('trip-checkbox')) { updateReportButtonState(); }
            });

            selectAllCheckbox.addEventListener('change', (e) => {
                document.querySelectorAll('.trip-checkbox').forEach(c => c.checked = e.target.checked);
                updateReportButtonState();
            });
            
            // --- Initial Load ---
            loadVehicleInfo();
            renderTable();
        });
    </script>

</body>
</html>

