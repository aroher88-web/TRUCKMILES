<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Mileage Tracker</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Crect x='55' y='10' width='240' height='55' rx='5' fill='%232D3748'/%3E%3Cpath d='M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z' fill='%234A5568'/%3E%3Crect x='5' y='65' width='290' height='5' fill='%231A202C'/%3E%3Cg%3E%3Ccircle cx='50' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='50' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='230' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='230' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='260' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='260' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Background gradient for glassmorphism effect */
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 100%);
            /* Prevent body scroll when modals are open */
            /* overflow: hidden; */ /* <-- REMOVED */
            min-height: 100vh; /* Ensure body takes at least full height */
        }
        /* REMOVED .main-container scrollbar styles, as the whole page will scroll now */
        


        /* Welcome screen animation */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        .welcome-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        /* Simple animation for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar for modal content */
        .modal-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .modal-scrollbar::-webkit-scrollbar-track {
            background: rgba(45, 55, 72, 0.5); /* gray-800 semi-transparent */
        }
        .modal-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.7); /* gray-600 semi-transparent */
            border-radius: 4px;
        }
       .modal-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(113, 128, 150, 0.8); /* gray-500 semi-transparent */
        }
        
        /* Class for Glassmorphism effect */
       .glass-effect {
            background-color: rgba(255, 255, 255, 0.05); /* Slightly white */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
       }

       /* Style for inputs with glass effect */
       .glass-input {
            background-color: rgba(17, 24, 39, 0.5); /* gray-900 semi-transparent */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
       }
       .glass-input::placeholder {
            color: rgba(209, 213, 219, 0.6); /* gray-300 semi-transparent */
       }
       .glass-input:focus {
            background-color: rgba(17, 24, 39, 0.7);
            border-color: rgba(59, 130, 246, 0.7); /* cyan-500 semi-transparent */
            --tw-ring-color: rgba(59, 130, 246, 0.5);
       }

       /* For the date picker text color */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Sticky Footer for Buttons */
        .sticky-footer {
            position: relative; /* Changed from sticky */
            /* bottom: -1rem; */ /* Removed */
            /* left: 0; */ /* Removed */
            width: 100%; 
            padding: 1rem; /* Consistent padding */
            margin-top: 2rem; /* Changed from auto to add space */
            /* Remove background/blur as it's no longer floating */
            /* background: linear-gradient(to top, rgba(30, 41, 59, 0.9), rgba(30, 41, 59, 0)); */ 
            /* backdrop-filter: blur(4px); */
            /* -webkit-backdrop-filter: blur(4px); */
            /* z-index: 40; */ /* Removed */
        }

         /* Container for the floating buttons inside sticky footer - REMOVED */
        /* .floating-buttons-container { ... } */
        
        /* Base styles for buttons to apply glass effect - ADJUSTED COLOR */
        .btn-liquid-glass {
            background-color: rgba(255, 255, 255, 0.05); /* Increased opacity */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08); /* Kept border subtle */
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .btn-liquid-glass:hover {
            background-color: rgba(255, 255, 255, 0.08); /* Increased hover opacity */
        }
        .btn-liquid-glass:active {
            transform: scale(0.98);
        }

        /* Specific colored buttons - INCREASED COLOR OPACITY */
        .btn-danger {
            background-color: rgba(239, 68, 68, 0.2); /* red-500 @ 20% */
            border-color: rgba(255, 100, 100, 0.08); 
        }
        .btn-danger:hover {
            background-color: rgba(220, 38, 38, 0.25); /* red-600 hover @ 25% */
        }
         .btn-edit {
            background-color: rgba(234, 179, 8, 0.2); /* yellow-500 @ 20% */
            border-color: rgba(255, 220, 100, 0.08); 
        }
        .btn-edit:hover {
            background-color: rgba(217, 119, 6, 0.25); /* yellow-600 hover @ 25% */
        }
        .btn-purple {
             background-color: rgba(147, 51, 234, 0.2); /* purple-600 @ 20% */
            border-color: rgba(160, 90, 240, 0.08); 
        }
        .btn-purple:hover{
            background-color: rgba(126, 34, 206, 0.25); /* purple-700 hover @ 25% */
        }
        .btn-success {
            background-color: rgba(34, 197, 94, 0.2); /* green-500 @ 20% */
            border-color: rgba(74, 222, 128, 0.08);
        }
        .btn-success:hover {
            background-color: rgba(22, 163, 74, 0.25); /* green-600 @ 25% */
        }
        .btn-primary {
            background-color: rgba(59, 130, 246, 0.2); /* blue-500 @ 20% */
            border-color: rgba(96, 165, 250, 0.08);
        }
        .btn-primary:hover {
            background-color: rgba(37, 99, 235, 0.25); /* blue-600 @ 25% */
        }
        .btn-accent {
            background-color: rgba(22, 163, 165, 0.2); /* cyan-600 @ 20% */
            border-color: rgba(56, 189, 248, 0.08);
        }
        .btn-accent:hover {
            background-color: rgba(8, 145, 178, 0.25); /* cyan-700 @ 25% */
        }
        
        /* Animación de aro de luz para el botón de agregar */
        @keyframes pulse-glow {
            0%, 100% {
                /* Usando el color de acento (cyan-400) para el brillo */
                box-shadow: 0 0 15px 0px rgba(34, 211, 238, 0.4); 
            }
            50% {
                box-shadow: 0 0 25px 8px rgba(34, 211, 238, 0.7);
            }
        }

        .pulse-glow-button {
            animation: pulse-glow 2.5s ease-in-out infinite;
            /* Asegura que la sombra base esté presente */
            box-shadow: 0 0 15px 0px rgba(34, 211, 238, 0.4);
        }
        
    </style>
</head>
<!-- Adjustments in body for mobile view: center content and add small padding --><body class="bg-gray-900 text-white min-h-screen flex justify-center p-2 md:p-4">

    <!-- Welcome Screen --><div id="welcome-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <svg id="welcome-truck-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 100" class="w-64 h-auto mb-8">
            <!-- Trailer --><rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
            <!-- Cab --><path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
            <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
            <!-- Wheels (removed animation for favicon) --><g>
                <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="50" cy="70" r="5" fill="#4A5568"/>
            </g>
            <g>
                <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="230" cy="70" r="5" fill="#4A5568"/>
            </g>
             <g>
                <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="260" cy="70" r="5" fill="#4A5568"/>
            </g>
        </svg>
        <h1 class="text-4xl font-bold text-cyan-400 welcome-animation">Hello Drivers, Stay safe.</h1>
    </div>

    <!-- Main Content Container --><!-- Removed pb-20 as footer is no longer sticky --><!-- REMOVED h-[95vh] to allow the container to grow with content --><div class="main-container w-[95%] max-w-7xl glass-effect rounded-2xl shadow-lg p-6 md:p-8 md:m-4 md:w-full md:h-auto md:max-w-7xl md:min-h-0 relative"> 
        <header class="mb-6 text-center">
            <svg id="company-logo-svg" viewBox="0 0 300 100" class="h-20 w-auto mx-auto" xmlns="http://www.w3.org/2000/svg">
                <!-- Static version of the truck for the header and PDF --><rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
                <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
                <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
                <g>
                    <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="50" cy="70" r="5" fill="#4A5568"/>
                </g>
                <g>
                    <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="230" cy="70" r="5" fill="#4A5568"/>
                </g>
                 <g>
                    <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="260" cy="70" r="5" fill="#4A5568"/>
                </g>
            </svg>
            <h1 class="text-3xl font-bold text-cyan-400 mt-2">Truck Mileage Tracker</h1>
            <p class="text-gray-300 mt-1">Log your trips and keep accurate track of your miles.</p>
            <!-- Button to show/edit info --><button id="show-info-section-btn" class="hidden mt-4 btn-liquid-glass font-bold py-2 px-4 rounded-lg">
                View/Edit Driver Info
            </button>
        </header>

        <!-- Driver & Vehicle Info Section (Collapsible) --><div id="driver-vehicle-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> <!-- Starts hidden --><div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold">Driver & Vehicle Info</h2>
            </div>
            <!-- Info Display Area (No longer used, form shown directly for editing) --><div id="vehicle-info-display" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-gray-300">
                    <p><strong>Driver:</strong> <span id="display-driverName"></span></p>
                    <p><strong>Company:</strong> <span id="display-company"></span></p>
                    <p><strong>Truck #:</strong> <span id="display-truckNumber"></span></p>
                    <p><strong>Trailer #:</strong> <span id="display-trailerNumber"></span></p>
                    <p><strong>Initial Odometer:</strong> <span id="display-initialOdometer"></span></p>
                    <p><strong>Rate per Mile:</strong> <span id="display-ratePerMile"></span></p>
                </div>
            </div>
            <!-- Info Edit Form --><form id="vehicle-info-form" class="hidden"> 
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                     <div>
                         <label for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1">Driver Name</label>
                         <input type="text" id="driverNameInfo" placeholder="Your Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                     <div>
                         <label for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
                         <input type="text" id="companyInfo" placeholder="Your Company Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                     <div>
                         <label for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Truck #</label>
                         <input type="text" id="truckNumberInfo" placeholder="e.g., T-123" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                      <div>
                         <label for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Trailer #</label>
                         <input type="text" id="trailerNumberInfo" placeholder="e.g., P-456" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                </div>
                <!-- Updated grid for Odometer and Rate --><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <div>
                         <label for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1">Initial Odometer</label>
                         <input type="text" inputmode="numeric" pattern="[0-9]*" id="initialOdometerInfo" placeholder="e.g., 150000" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                      <div>
                         <label for="ratePerMileInfo" class="block text-sm font-medium text-gray-300 mb-1">Rate per Mile</label>
                         <input type="text" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" id="ratePerMileInfo" placeholder="e.g., 0.70" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                     </div>
                </div>
                <div class="flex justify-end gap-4">
                     <button type="button" id="cancel-info-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg hidden">Cancel</button>
                    <button type="submit" class="btn-liquid-glass btn-accent font-bold py-2 px-4 rounded-lg">Save Info</button>
                </div>
            </form>
        </div>

        <!-- NEW: Last Trip Info Display Section --><div id="add-trip-btn-original-location" class="mb-8"> <!-- Removed hidden class --><div class="glass-effect p-4 rounded-xl text-center">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">Last Recorded Trip</h3>
                <!-- Updated grid to sm:grid-cols-2 --><div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-200">
                    <!-- REMOVED Date Paragraph --><p><strong class="text-cyan-400">City:</strong> <span id="last-trip-departure">N/A</span></p>
                    <p><strong class="text-cyan-400">Odometer:</strong> <span id="last-trip-odometer">N/A</span></p>
                </div>
             </div>
        </div>
        

        <!-- Add New Trip Section (Collapsible) --><div id="add-trip-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> <!-- Starts hidden --><h2 class="text-xl font-semibold mb-4">Add New Trip</h2>
            <form id="mileage-form">
                <!-- Grid changed to 8 columns for finer control --><div class="grid grid-cols-1 md:grid-cols-8 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label for="departure" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                        <input type="text" id="departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label for="odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <!-- NUEVO: Checkbox de Viaje Personal -->
                <div class="flex items-center justify-start mb-4">
                    <input id="personal-trip" type="checkbox" class="h-5 w-5 rounded glass-input text-cyan-600 focus:ring-cyan-500 border-white/10">
                    <label for="personal-trip" class="ml-2 block text-sm font-medium text-gray-300">Personal Trip (unpaid)</label>
                </div>
                <div class="flex justify-end gap-4">
                    <!-- Cancel Button --><button type="button" id="cancel-add-trip-btn" class="btn-liquid-glass font-bold py-2.5 px-6 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="w-full md:w-auto btn-liquid-glass btn-accent font-bold py-2.5 px-6 rounded-lg">
                        Add Trip
                    </button>
                </div>
            </form>
        </div>

        <!-- Trip History Section --><div>
            <!-- Control Buttons & Totals (Always Visible) --><!-- Cambiado a grid-cols-2 en móvil, y col-span-2 para el botón --><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center">
                    <span class="font-medium text-gray-300 text-sm">Total Miles</span>
                    <span id="total-miles" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center">
                    <span class="font-medium text-gray-300 text-sm">Amount to Charge</span>
                    <span id="total-amount" class="font-bold text-2xl text-green-400">$0.00</span>
                </div>
                 <!-- Añadido col-span-2 (para móvil) y md:col-span-1 (para tablet/desktop) --><button type="button" id="archive-reset-btn" class="w-full btn-liquid-glass btn-danger font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 col-span-2 md:col-span-1">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm1-4a1 1 0 000 2h10a1 1 0 100-2H5z" clip-rule="evenodd"></path></svg>
                     Archive &amp; Reset
                 </button>
            </div>

            <!-- ****** FIX: RE-INSERTED MISSING HTML ****** -->
            <!-- Collapsible Table Section Header -->
            <!-- CAMBIO: Quitado 'flex-col' y 'md:flex-row' para que siempre sea una fila -->
            <div class="flex flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Trip History</h2>
                <!-- NEW BUTTON AND CONTAINER DIV -->
                <div class="flex items-center gap-2">
                    <button id="view-current-report-btn" class="btn-liquid-glass btn-primary font-medium text-sm py-1 px-2 rounded-lg flex items-center gap-1" title="View Current Report">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm4 1a1 1 0 100 2h8a1 1 0 100-2H6zM6 11a1 1 0 100 2h8a1 1 0 100-2H6zM6 15a1 1 0 100 2h5a1 1 0 100-2H6z" clip-rule="evenodd" />
                        </svg>
                        View Report
                    </button>
                    <button id="toggle-history-table-btn" class="text-gray-300 hover:text-white p-2 rounded-full" title="Toggle History">
                        <svg id="history-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Collapsible Table Wrapper (Starts hidden) -->
            <div id="history-table-container" class="hidden">
                <div class="overflow-x-auto rounded-lg glass-effect border-none">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-cyan-300 uppercase bg-white/5">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">City</th>
                                <th scope="col" class="px-6 py-3">Initial Odometer</th>
                                <th scope="col" class="px-6 py-3">Ending Odometer</th>
                                <th scope="col" class="px-6 py-3">Miles</th>
                                <th scope="col" class="px-6 py-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mileage-table-body">
                            <tr id="empty-row" class="bg-white/5 border-b border-white/10">
                                <td colspan="6" class="text-center py-8 text-gray-400">No records yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- ****** END OF FIX ****** -->

        </div> <!-- This div closes the "Trip History Section" -->

        <!-- ****** FIX: RE-INSERTED BUTTON CONTAINER ****** -->
        <!-- Container for the bottom buttons -->
        <div class="sticky-footer flex justify-between items-center px-4 md:px-0 mt-8"> 
            <!-- Backup Button Container -->
            <div id="backup-btn-container" class="z-40"> 
                <button id="open-backup-modal-btn" class="btn-liquid-glass btn-success font-bold py-2.5 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" title="Backup & Restore">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
            </div>
            
            <!-- Add New Trip Button (Moved Here, Large & Round) -->
            <button id="show-add-trip-btn" class="btn-liquid-glass btn-accent text-white font-bold p-6 rounded-full transition-transform duration-300 ease-in-out flex items-center justify-center z-40 pulse-glow-button" title="Add New Trip">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                 </svg>
            </button>

            <!-- History Button Container -->
            <div id="history-btn-container" class="z-40"> 
                <button id="view-history-btn" class="btn-liquid-glass btn-primary font-bold py-2.5 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" title="View Archive History">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- ****** END OF FIX ****** -->


        <!-- Hidden input for file upload --><input type="file" id="upload-backup-input" class="hidden" accept=".json">


    </div> <!-- End Main Content Container --><!-- Modal for Editing a Trip --><div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="edit-modal-content">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-yellow-400">Edit Trip</h3>
                <button id="edit-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                        <input type="text" id="edit-departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="edit-odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <!-- NUEVO: Checkbox de Viaje Personal en Edición -->
                    <div class="flex items-center pt-2">
                        <input id="edit-personal-trip" type="checkbox" class="h-5 w-5 rounded glass-input text-cyan-600 focus:ring-cyan-500 border-white/10">
                        <label for="edit-personal-trip" class="ml-2 block text-sm font-medium text-gray-300">Personal Trip (unpaid)</label>
                    </div>
                </div>
                <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal (Archive & Reset) --><div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 class="text-lg font-semibold text-red-400">Confirm Action</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p>Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Archive & Reset</button>
            </div>
        </div>
    </div>

    <!-- Archive History Modal --><div id="history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-4xl flex flex-col" style="height: 80vh;"> <!-- Increased width --><div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-blue-400">Archive History</h3>
                <button id="history-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto modal-scrollbar" id="history-modal-content">
                <div class="overflow-x-auto rounded-lg border border-white/10">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-blue-300 uppercase bg-white/5 sticky top-0"> <!-- Added sticky --><tr>
                                <th scope="col" class="px-6 py-3">Archive Date</th>
                                <!-- REMOVED Period and Rate -->
                                <th scope="col" class="px-6 py-3">Total Miles</th>
                                <th scope="col" class="px-6 py-3">Total Amount</th>
                                <th scope="col" class="px-6 py-3 text-center">Actions</th> <!-- New Column --></tr>
                        </thead>
                        <tbody id="archive-history-table-body">
                            <!-- History rows will be injected here --><tr id="empty-history-row" class="bg-white/5 border-b border-white/10">
                                <td colspan="4" class="text-center py-8 text-gray-400">No archive history yet.</td> <!-- Updated colspan to 4 --></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center">
                <button type="button" id="clear-history-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Clear All History</button>
                <button type="button" id="close-history-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (Clear History) --><div id="confirm-clear-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300"> <!-- Higher z-index --><div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 class="text-lg font-semibold text-red-400">Clear Archive History?</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p>Are you sure you want to permanently delete all archive history? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-clear-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-clear-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Clear</button>
            </div>
        </div>
    </div>

    <!-- NEW Backup & Restore Modal --><div id="backup-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-3xl flex flex-col" style="height: 80vh;">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-green-400">Backup & Restore</h3>
                <button id="backup-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6 modal-scrollbar" id="backup-restore-modal-content">
                <!-- Manual Controls --><div>
                    <h4 class="text-md font-semibold text-gray-200 mb-3">Manual Actions</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <!-- Grid changed to 2 cols --><button id="btn-download-backup" class="btn-liquid-glass btn-success font-bold py-3 px-4 rounded-lg">Download Backup File</button>
                        <button id="btn-upload-backup" class="btn-liquid-glass btn-purple font-bold py-3 px-4 rounded-lg">Upload & Restore File</button>
                    </div>
                </div>

                <!-- Automatic Backups List --><div>
                    <h4 class="text-md font-semibold text-gray-200 mb-3">Recent Backups (Auto/Manual)</h4>
                    <div class="overflow-x-auto rounded-lg border border-white/10" style="max-height: 40vh; overflow-y: auto;">
                        <table class="w-full text-sm text-left text-gray-200">
                            <thead class="text-xs text-green-300 uppercase bg-white/5 sticky top-0"> <!-- Added sticky --><tr>
                                    <th scope="col" class="px-6 py-3">Backup Date</th>
                                    <th scope="col" class="px-6 py-3">Type</th>
                                    <th scope="col" class="px-6 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list-body">
                                <tr id="empty-backup-row" class="bg-white/5 border-b border-white/10">
                                    <td colspan="3" class="text-center py-8 text-gray-400">No backups yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center">
                <button type="button" id="clear-backups-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Clear All Backups</button>
                <button type="button" id="close-backup-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Restore) --><div id="confirm-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-restore-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 class="text-lg font-semibold text-yellow-400">Confirm Restore</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="confirm-restore-message">Are you sure you want to restore from this backup? All current data will be overwritten.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-restore-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-restore-yes-btn" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg">Yes, Restore</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Clear Backups) --><div id="confirm-clear-backups-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-backups-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 class="text-lg font-semibold text-red-400">Clear All Backups?</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p>Are you sure you want to delete all automatic and manual backups? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-clear-backups-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-clear-backups-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Clear</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Generic Delete) -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[70] transition-opacity duration-300"> <!-- Higher z-index -->
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-delete-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="confirm-delete-title" class="text-lg font-semibold text-red-400">Confirm Delete</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="confirm-delete-message">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-delete-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-delete-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Delete</button>
            </div>
        </div>
    </div>


    <!-- Notification Element --><div id="notification" class="fixed top-5 right-5 glass-effect text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =========================================================================
            //  ELEMENT SELECTORS
            // =========================================================================
            
            // --- General ---
            const welcomeScreen = document.getElementById('welcome-screen');
            
            // --- Forms ---
            const form = document.getElementById('mileage-form');
            const vehicleInfoForm = document.getElementById('vehicle-info-form');
            const editTripForm = document.getElementById('edit-trip-form');
            
            // --- Tables ---
            const tableBody = document.getElementById('mileage-table-body');
            const emptyRow = document.getElementById('empty-row');
            
            // --- Totals Display ---
            const totalMilesEl = document.getElementById('total-miles');
            const totalAmountEl = document.getElementById('total-amount');
            
            // --- Driver Info Section ---
            const driverVehicleSection = document.getElementById('driver-vehicle-section');
            const showInfoSectionBtn = document.getElementById('show-info-section-btn');
            const cancelInfoEditBtn = document.getElementById('cancel-info-edit-btn'); 
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display');
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const ratePerMileInfoInput = document.getElementById('ratePerMileInfo');
            
            // --- Driver Info Display Spans (for PDF) ---
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');
            const displayRatePerMile = document.getElementById('display-ratePerMile');

            // --- Last Trip Display ---
            const lastTripDateEl = document.getElementById('last-trip-date'); // Still exists in HTML, needed for JS logic below
            const lastTripDepartureEl = document.getElementById('last-trip-departure');
            const lastTripOdometerEl = document.getElementById('last-trip-odometer');

            // --- Add Trip Section ---
            const addTripSection = document.getElementById('add-trip-section');
            const showAddTripBtn = document.getElementById('show-add-trip-btn'); // Now in the footer
            const cancelAddTripBtn = document.getElementById('cancel-add-trip-btn');
            const departureInput = document.getElementById('departure');
            
            // --- Main Control Buttons ---
            const archiveResetBtn = document.getElementById('archive-reset-btn');

            // --- History Table Section ---
            const toggleHistoryTableBtn = document.getElementById('toggle-history-table-btn');
            const historyToggleIcon = document.getElementById('history-toggle-icon');
            const historyTableContainer = document.getElementById('history-table-container');
            const viewCurrentReportBtn = document.getElementById('view-current-report-btn'); // <-- NUEVA LÍNEA

            // --- Floating Buttons ---
            const backupBtnContainer = document.getElementById('backup-btn-container'); // Side button container
            const historyBtnContainer = document.getElementById('history-btn-container'); // Side button container
            const openBackupModalBtn = document.getElementById('open-backup-modal-btn'); // Side button
            const viewHistoryBtn = document.getElementById('view-history-btn'); // Side button

            // --- Edit Modal ---
            const editModal = document.getElementById('edit-modal');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // --- Confirm Archive Modal ---
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            // --- Archive History Modal ---
            const historyModal = document.getElementById('history-modal');
            const historyCloseBtn = document.getElementById('history-close-btn');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const archiveHistoryTableBody = document.getElementById('archive-history-table-body');
            const emptyHistoryRow = document.getElementById('empty-history-row');

            // --- Confirm Clear History Modal ---
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            const confirmClearYesBtn = document.getElementById('confirm-clear-yes-btn');
            const confirmClearNoBtn = document.getElementById('confirm-clear-no-btn');

            // --- Backup/Restore Modal ---
            const backupRestoreModal = document.getElementById('backup-restore-modal');
            const backupCloseBtn = document.getElementById('backup-close-btn');
            const closeBackupModalBtn = document.getElementById('close-backup-modal-btn');
            const btnDownloadBackup = document.getElementById('btn-download-backup');
            const btnUploadBackup = document.getElementById('btn-upload-backup');
            const uploadBackupInput = document.getElementById('upload-backup-input');
            const backupListBody = document.getElementById('backup-list-body');
            const emptyBackupRow = document.getElementById('empty-backup-row');
            const clearBackupsBtn = document.getElementById('clear-backups-btn');
            
            // --- Confirm Restore Modal ---
            const confirmRestoreModal = document.getElementById('confirm-restore-modal');
            const confirmRestoreMessage = document.getElementById('confirm-restore-message');
            const confirmRestoreYesBtn = document.getElementById('confirm-restore-yes-btn');
            const confirmRestoreNoBtn = document.getElementById('confirm-restore-no-btn');
            
            // --- Confirm Clear Backups Modal ---
            const confirmClearBackupsModal = document.getElementById('confirm-clear-backups-modal');
            const confirmClearBackupsYesBtn = document.getElementById('confirm-clear-backups-yes-btn');
            const confirmClearBackupsNoBtn = document.getElementById('confirm-clear-backups-no-btn');

            // --- NEW: Generic Delete Modal ---
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmDeleteTitle = document.getElementById('confirm-delete-title');
            const confirmDeleteMessage = document.getElementById('confirm-delete-message');
            const confirmDeleteYesBtn = document.getElementById('confirm-delete-yes-btn');
            const confirmDeleteNoBtn = document.getElementById('confirm-delete-no-btn');


            // =========================================================================
            //  STATE VARIABLES
            // =========================================================================
            
            // Load all data from localStorage or initialize as empty arrays/null
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || [];
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
            let archiveHistory = JSON.parse(localStorage.getItem('archiveHistory')) || [];
            let mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
            let isHistoryVisible = false; // UI state for table visibility

            // =========================================================================
            //  HELPER FUNCTIONS
            // =========================================================================

            /**
             * NEW: Formats a date string (YYYY-MM-DD or ISO), object, or timestamp to MM/DD/YY.
             * @param {string|Date|number} dateStringOrObject - The date to format.
             * @returns {string} The formatted date string (MM/DD/YY) or 'N/A'.
             */
            const formatDateToMMDDYY = (dateStringOrObject) => {
                if (!dateStringOrObject) return 'N/A';
                try {
                    let date;
                    if (dateStringOrObject instanceof Date) {
                        date = dateStringOrObject;
                    } else if (typeof dateStringOrObject === 'number') {
                        date = new Date(dateStringOrObject);
                    } else {
                        // Handle YYYY-MM-DD strings safely (for Safari)
                        const parts = String(dateStringOrObject).split('-');
                        if (parts.length === 3 && parts[0].length === 4) {
                            // new Date(YYYY, MM-1, DD)
                            date = new Date(parts[0], parts[1] - 1, parts[2]);
                        } else {
                            // Fallback for other strings like "MM/DD/YYYY" (from toLocaleDateString)
                            date = new Date(dateStringOrObject);
                        }
                    }

                    if (isNaN(date.getTime())) {
                        // If parsing failed, return original string
                        return String(dateStringOrObject); 
                    }
                    
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    return `${month}/${day}/${year}`;

                } catch (error) {
                    console.warn(`Could not format date: ${dateStringOrObject}`, error);
                    return String(dateStringOrObject); // Return original string if formatting fails
                }
            };

            /**
             * Shows a toast notification at the top right.
             * @param {string} message - The message to display.
             * @param {boolean} [isError=true] - True for red (error), false for green (success).
             */
            const showNotification = (message, isError = true) => {
                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                if (!notification || !notificationMessage) return;
                
                notificationMessage.textContent = message; 

                notification.classList.remove('bg-red-600/70', 'bg-green-500/70');
                notification.classList.add(isError ? 'bg-red-600/70' : 'bg-green-500/70');
                notification.classList.add('backdrop-blur-md');
                notification.classList.remove('opacity-0');
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                }, 4000);
            };

            /**
             * Converts an SVG element to a Base64 encoded PNG.
             * @param {SVGElement} svgElement - The <svg> element to convert.
             * @returns {Promise<string>} A promise that resolves with the data URL.
             */
            const getSvgAsImageBase64 = (svgElement) => {
                return new Promise((resolve, reject) => {
                    if (!svgElement) return reject("SVG element not provided");
                    // Clone the SVG to avoid modifying the original
                    const clone = svgElement.cloneNode(true);
                    // Remove any animations that might interfere
                    const animations = clone.querySelectorAll('animateTransform');
                    animations.forEach(anim => anim.remove());
                    
                    const svgString = new XMLSerializer().serializeToString(clone);
                    const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                    const url = URL.createObjectURL(svgBlob);
                    
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const viewBox = clone.getAttribute('viewBox').split(' ').map(Number);
                        const width = viewBox[2];
                        const height = viewBox[3];
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        URL.revokeObjectURL(url);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = (err) => {
                        URL.revokeObjectURL(url);
                        reject(err);
                    };
                    img.src = url;
                });
            };
            
            /**
             * Gathers all app data from localStorage into a single object.
             * @returns {object} An object containing vehicleInfo, records, and archiveHistory.
             */
            const getAllDataAsObject = () => {
                return {
                    vehicleInfo: JSON.parse(localStorage.getItem('vehicleInfo')) || null,
                    records: JSON.parse(localStorage.getItem('mileageRecords')) || [],
                    archiveHistory: JSON.parse(localStorage.getItem('archiveHistory')) || []
                };
            };

            // =========================================================================
            //  UI & MODAL LOGIC
            // =========================================================================

            /**
             * Checks if any modal or collapsible section is currently open.
             * @returns {boolean} True if a UI element is open.
             */
             const isUIElementOpen = () => {
                 return !editModal.classList.contains('hidden') ||
                        !confirmModal.classList.contains('hidden') ||
                        !historyModal.classList.contains('hidden') ||
                        !confirmClearModal.classList.contains('hidden') ||
                        !backupRestoreModal.classList.contains('hidden') ||
                        !confirmRestoreModal.classList.contains('hidden') ||
                        !confirmClearBackupsModal.classList.contains('hidden') ||
                        !confirmDeleteModal.classList.contains('hidden') || // <-- NUEVA LÍNEA
                        !driverVehicleSection.classList.contains('hidden') || 
                        !addTripSection.classList.contains('hidden') ||
                        isHistoryVisible;
             };

            /** Moves the large central Add Trip button down (out of view) */
             const moveButtonsDown = () => {
                 if (showAddTripBtn) {
                     showAddTripBtn.classList.add('translate-y-32'); // Adjust value if needed
                 }
             };

            /** Moves the large central Add Trip button up (into view) if no modals/sections are open */
             const moveButtonsUp = () => {
                 setTimeout(() => {
                     // Check specifically if the add trip SECTION is hidden
                     const addTripFormHidden = addTripSection.classList.contains('hidden');
                     if (!isUIElementOpen() && addTripFormHidden && showAddTripBtn) {
                         showAddTripBtn.classList.remove('translate-y-32');
                     }
                     // Keep button visible if add trip form is closed, even if other modals open/close
                     else if (addTripFormHidden && showAddTripBtn) {
                         showAddTripBtn.classList.remove('translate-y-32');
                     }
                 }, 150); // Small delay for animations
             };

            /** Opens the Edit Trip modal and populates it with trip data. */
            const openEditModal = (trip) => {
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date; // Value MUST be YYYY-MM-DD
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                document.getElementById('edit-personal-trip').checked = trip.isPersonal || false; // <--- NUEVA LÍNEA
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
                moveButtonsDown(); 
            };

            /** Closes the Edit Trip modal and resets the form. */
            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editTripForm.reset();
                moveButtonsUp(); 
            };
            
            /** Opens the Archive confirmation modal. */
            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
                moveButtonsDown(); 
            };

            /** Closes the Archive confirmation modal. */
            const closeConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            /** Opens the Archive History modal. */
            const openHistoryModal = () => {
                renderArchiveHistoryTable(); // Render the history table when opening
                historyModal.classList.remove('hidden');
                historyModal.classList.add('flex');
                moveButtonsDown(); 
            };

            /** Closes the Archive History modal. */
            const closeHistoryModal = () => {
                historyModal.classList.add('hidden');
                historyModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            /** Opens the Clear History confirmation modal. */
            const openConfirmClearModal = () => {
                confirmClearModal.classList.remove('hidden');
                confirmClearModal.classList.add('flex');
            };

            /** Closes the Clear History confirmation modal. */
            const closeConfirmClearModal = () => {
                confirmClearModal.classList.add('hidden');
                confirmClearModal.classList.remove('flex');
            };
            
            /** Opens the Backup & Restore modal. */
            const openBackupModal = () => {
                renderBackupList();
                backupRestoreModal.classList.remove('hidden');
                backupRestoreModal.classList.add('flex');
                moveButtonsDown(); 
            };

            /** Closes the Backup & Restore modal. */
            const closeBackupModal = () => {
                backupRestoreModal.classList.add('hidden');
                backupRestoreModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            /** Opens the Restore confirmation modal. */
            const openConfirmRestoreModal = (message) => {
                confirmRestoreMessage.textContent = message;
                confirmRestoreModal.classList.remove('hidden');
                confirmRestoreModal.classList.add('flex');
            };

            /** Closes the Restore confirmation modal. */
            const closeConfirmRestoreModal = () => {
                confirmRestoreModal.classList.add('hidden');
                confirmRestoreModal.classList.remove('flex');
                localStorage.removeItem('pendingRestoreData'); // Clear pending data
            };
            
            /** Opens the Clear Backups confirmation modal. */
            const openConfirmClearBackupsModal = () => {
                confirmClearBackupsModal.classList.remove('hidden');
                confirmClearBackupsModal.classList.add('flex');
            };

            /** Closes the Clear Backups confirmation modal. */
            const closeConfirmClearBackupsModal = () => {
                confirmClearBackupsModal.classList.add('hidden');
                confirmClearBackupsModal.classList.remove('flex');
            };

            /** NEW: Opens the Generic Delete confirmation modal. */
            const openConfirmDeleteModal = (title, message, deleteInfo) => {
                confirmDeleteTitle.textContent = title;
                confirmDeleteMessage.textContent = message;
                localStorage.setItem('pendingDelete', JSON.stringify(deleteInfo)); // Store what to delete
                confirmDeleteModal.classList.remove('hidden');
                confirmDeleteModal.classList.add('flex');
            };

            /** NEW: Closes the Generic Delete confirmation modal. */
            const closeConfirmDeleteModal = () => {
                confirmDeleteModal.classList.add('hidden');
                confirmDeleteModal.classList.remove('flex');
                localStorage.removeItem('pendingDelete'); // Clear pending delete info
            };


            // =========================================================================
            //  DATA & RENDER FUNCTIONS
            // =========================================================================

            /** Loads vehicle info from state and updates the UI. */
            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                if (vehicleInfo) {
                    // Info exists, show "View/Edit" button
                    driverVehicleSection.classList.add('hidden');
                    showInfoSectionBtn.classList.remove('hidden');
                    
                    // Populate display spans (used for PDF)
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();
                    displayRatePerMile.textContent = (parseFloat(vehicleInfo.ratePerMile) || 0.70).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                    
                    // Populate form fields for editing
                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    ratePerMileInfoInput.value = vehicleInfo.ratePerMile || '0.70';
                    
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.remove('hidden');
                } else {
                    // First time user, force info entry
                    driverVehicleSection.classList.remove('hidden');
                    showInfoSectionBtn.classList.add('hidden');
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.add('hidden');
                    ratePerMileInfoInput.value = '0.70';
                    moveButtonsDown(); // Keep buttons down if info section is open
                }
            };
            
            /** Renders the main trip history table from the `records` state. */
            const renderTable = () => {
                tableBody.innerHTML = '';
                if (records.length === 0) {
                    if (emptyRow) { // Check if emptyRow exists before appending
                        tableBody.appendChild(emptyRow.cloneNode(true));
                    }
                    // Disable archive button if no records
                    archiveResetBtn.disabled = true;
                    archiveResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    archiveResetBtn.disabled = false;
                    archiveResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10 hover:bg-white/10';
                        // Updated row content to remove columns
                        // CAMBIO: Se añade lógica para viajes personales
                        const milesText = Number(record.miles) === 0 ? '' : Number(record.miles).toLocaleString();
                        const milesClass = record.isPersonal ? 'text-gray-500 line-through' : 'text-cyan-400';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${formatDateToMMDDYY(record.date)}</td>
                            <td class="px-6 py-4">${record.departure}</td>
                            <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${Number(record.odometer) === 0 ? '' : Number(record.odometer).toLocaleString()}</td>
                            <td class="px-6 py-4 font-bold ${milesClass}">${milesText}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${record.id}" class="edit-btn btn-liquid-glass btn-edit font-medium mr-4 px-2 py-1 rounded-lg text-sm">Edit</button>
                                <button data-id="${record.id}" class="delete-btn btn-liquid-glass btn-danger font-medium px-2 py-1 rounded-lg text-sm">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                updateTotalMiles(); // Update totals whenever table renders
                updateLastTripDisplay(); // NEW: Update the last trip display
                saveToLocalStorage(); // Save changes to records
            };

            /** Calculates and displays total miles and amount. */
            const updateTotalMiles = () => {
                // CAMBIO: Filtrar viajes personales antes de sumar
                const payableRecords = records.filter(record => !record.isPersonal);
                const total = payableRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                totalMilesEl.textContent = total.toLocaleString();
                const rate = parseFloat(vehicleInfo?.ratePerMile || '0.70');
                const amount = total * rate;
                totalAmountEl.textContent = amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            /** Updates the display section showing the last recorded trip. */
            const updateLastTripDisplay = () => {
                if (records.length > 0) {
                    const lastTrip = records[records.length - 1];
                    // REMOVED: lastTripDateEl.textContent = lastTrip.date;
                    lastTripDepartureEl.textContent = lastTrip.departure;
                    // Only show odometer if it was entered (greater than 0)
                    lastTripOdometerEl.textContent = lastTrip.odometer > 0 ? Number(lastTrip.odometer).toLocaleString() : 'N/A';
                } else {
                    // Adjusted text when no trips
                    lastTripDepartureEl.textContent = 'No trips recorded'; 
                    lastTripOdometerEl.textContent = '';
                }
            };

            /** Saves the current `records` state to localStorage. */
            const saveToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            /** Generates and shares/downloads a PDF report. */
            const generateAndHandlePdf = async (recordsToExport, forSharing = true) => {
                 if (!recordsToExport || recordsToExport.length === 0) {
                     showNotification('No data to generate a report.');
                     return;
                 }
                 let logoBase64;
                 try {
                     logoBase64 = await getSvgAsImageBase64(document.getElementById('welcome-truck-svg')); 
                 } catch (error) {
                     console.warn('Could not load company logo for the PDF report.', error);
                 }
                 // Group records by driver (Although driver column is removed, keep logic for potential future use or PDF differentiation)
                 const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                 showNotification(`Generating ${uniqueDrivers.length} PDF report(s)...`, false);

                 for (const driver of uniqueDrivers) {
                     const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                      const driverInfo = {
                          driverName: driver,
                          company: driverRecords[0]?.company || vehicleInfo?.company || 'N/A',
                          truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber || 'N/A',
                          trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber || 'N/A',
                     };
                     const { jsPDF } = window.jspdf;
                     const doc = new jsPDF();
                     // CAMBIO: Calcular total solo de viajes pagables
                     const payableDriverRecords = driverRecords.filter(r => !r.isPersonal);
                     const totalMilesForDriver = payableDriverRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                     let startY = 15; // Top margin
                     
                     // Add logo if available
                     if(logoBase64) {
                         const imgWidth = 60;
                         const imgHeight = 20;
                         const pageWidth = doc.internal.pageSize.getWidth();
                         const x = (pageWidth - imgWidth) / 2;
                         doc.addImage(logoBase64, 'PNG', x, 15, imgWidth, imgHeight);
                         startY = 45; // Move content down
                     }
                     
                     // Add Title - Use Dark Gray
                     doc.setFontSize(22);
                     doc.setFont('helvetica', 'bold');
                     doc.setTextColor(50, 50, 50); // Dark Gray
                     doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                     startY += 8;
                     
                     // Add Sub-header - Use Medium/Dark Grays
                     const headerParts = [
                         { text: `Driver: `, style: 'normal', color: [100, 100, 100] }, // Medium Gray Label
                         { text: driverInfo.driverName, style: 'bold', size: 13, color: [50, 50, 50] }, // Dark Gray Value
                         { text: ` | Truck #: ${driverInfo.truckNumber} | Trailer #: ${driverInfo.trailerNumber}`, style: 'normal', color: [100, 100, 100] } // Medium Gray Rest
                     ];
                     let currentX = doc.internal.pageSize.getWidth() / 2;
                     // Calculate total width of sub-header to center it
                     const totalWidth = headerParts.reduce((sum, part) => {
                         doc.setFont('helvetica', part.style || 'normal');
                         doc.setFontSize(part.size || 11);
                         return sum + doc.getTextWidth(part.text);
                     }, 0);
                     currentX -= totalWidth / 2;
                     // doc.setTextColor(50); // Removed global setTextColor
                     headerParts.forEach(part => {
                         doc.setFont('helvetica', part.style || 'normal');
                         doc.setFontSize(part.size || 11);
                         doc.setTextColor(...(part.color || [50, 50, 50])); // Apply color per part
                         doc.text(part.text, currentX, startY);
                         currentX += doc.getTextWidth(part.text);
                     });
                     startY += 15;
                     
                     // Add Table - Use Cyan Header, Dark Gray Body
                     // CAMBIO: Se añade columna "Notes"
                     const tableColumn = ["Date", "City", "Initial Odo", "Ending Odo", "Miles", "Notes"];
                     const tableRows = driverRecords.map(r => [
                         formatDateToMMDDYY(r.date), // <-- DATE FORMAT CHANGE
                         r.departure, 
                         Number(r.initialOdometer).toLocaleString(),
                         Number(r.odometer) === 0 ? '' : Number(r.odometer).toLocaleString(), 
                         Number(r.miles) === 0 ? '' : Number(r.miles).toLocaleString(),
                         r.isPersonal ? 'Personal' : '' // <-- NUEVA LÍNEA
                     ]);
                     doc.autoTable(tableColumn, tableRows, { 
                         startY: startY,
                         headStyles: {
                             fillColor: [22, 163, 165], // Main app cyan color (darker shade for fill)
                             textColor: [255, 255, 255] // White text on cyan header
                         },
                         bodyStyles: {
                             textColor: [50, 50, 50] // Dark Gray for table body text
                         },
                         footStyles: { // Add footer styles
                             fillColor: [240, 240, 240], // Light gray background for footer
                             textColor: [50, 50, 50], // Dark Gray for "Total Miles:" label
                             fontStyle: 'bold'
                         },
                         foot: [ // Add the footer row data
                             // CAMBIO: Se ajusta el pie de página para la nueva columna y el texto
                             ['', '', '', '', 'Total Payable:', totalMilesForDriver.toLocaleString(), ''] 
                         ]
                     });
                     
                     // Add Footer - Keep muted gray
                     const today = formatDateToMMDDYY(new Date()); // <-- DATE FORMAT CHANGE
                     const pageWidth = doc.internal.pageSize.getWidth();
                     doc.setFontSize(10);
                     doc.setFont('helvetica', 'normal');
                     doc.setTextColor(150, 150, 150); // Muted Gray
                     doc.text("Developed for AROHER88", pageWidth - 14, doc.internal.pageSize.getHeight() - 15, { align: 'right' });
                     doc.text(`Date: ${today}`, pageWidth - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                     
                     // Share or Save
                     if(forSharing) {
                         const pdfBlob = doc.output('blob');
                         const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' });
                         const shareData = { files: [pdfFile], title: `Mileage Report for ${driverInfo.driverName}` };
                         if (navigator.canShare && navigator.canShare(shareData)) {
                             try { await navigator.share(shareData); } catch (err) {
                                 if (err.name !== 'AbortError') { showNotification(`Could not share report for ${driverInfo.driverName}.`);}
                             }
                         } else {
                             showNotification(`Browser doesn't support sharing. Downloading report for ${driverInfo.driverName}.`, false);
                             doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                         }
                     } else {
                          doc.save(`ARCHIVED_mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                     }
                 }
            };
            
            /** Renders the archive history table from `archiveHistory` state. */
            const renderArchiveHistoryTable = () => {
                archiveHistoryTableBody.innerHTML = '';
                if (archiveHistory.length === 0) {
                    if (emptyHistoryRow) { // Check if emptyHistoryRow exists
                        archiveHistoryTableBody.appendChild(emptyHistoryRow.cloneNode(true));
                    }
                    clearHistoryBtn.disabled = true;
                    clearHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearHistoryBtn.disabled = false;
                    clearHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveHistory.forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';

                        // Format the period string (REMOVED, BUT KEPT FOR REFERENCE)
                        // const periodParts = entry.period.split(' to ');
                        // const formattedPeriod = periodParts.length === 2
                        //     ? `${formatDateToMMDDYY(periodParts[0])} to ${formatDateToMMDDYY(periodParts[1])}`
                        //     : formatDateToMMDDYY(entry.period);

                        // CAMBIO: Se eliminan 'formattedPeriod' y 'ratePerMile'
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${formatDateToMMDDYY(entry.archiveDate)}</td>
                            <td class="px-6 py-4">${entry.totalMiles.toLocaleString()}</td>
                            <td class="px-6 py-4 font-medium text-green-400">${entry.totalAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${entry.id}" class="generate-history-pdf-btn btn-liquid-glass btn-purple font-medium text-sm py-1 px-2 rounded-lg mr-2">
                                    PDF
                                </button>
                                <button data-id="${entry.id}" class="delete-archive-btn btn-liquid-glass btn-danger font-medium text-sm py-1 px-2 rounded-lg">
                                    Delete
                                </button>
                            </td>
                        `;
                        archiveHistoryTableBody.appendChild(row);
                    });
                }
            };
            
            /** Renders the backup list from `mileageBackups` state. */
            const renderBackupList = () => {
                mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
                backupListBody.innerHTML = '';
                if (mileageBackups.length === 0) {
                    if (emptyBackupRow) { // Check if emptyBackupRow exists
                        backupListBody.appendChild(emptyBackupRow.cloneNode(true));
                    }
                    clearBackupsBtn.disabled = true;
                    clearBackupsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearBackupsBtn.disabled = false;
                    clearBackupsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    mileageBackups.forEach(backup => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';
                        const backupDate = formatDateToMMDDYY(backup.timestamp); // <-- DATE FORMAT CHANGE
                        const type = backup.type === 'auto' ? 'Automatic' : 'Manual';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${backupDate}</td>
                            <td class="px-6 py-4">${type}</td>
                            <td class="px-6 py-4 text-center space-x-2">
                                <button data-timestamp="${backup.timestamp}" class="restore-backup-btn btn-liquid-glass btn-edit font-medium text-sm py-1 px-2 rounded-lg">
                                    Restore
                                </button>
                                <button data-timestamp="${backup.timestamp}" class="delete-backup-btn btn-liquid-glass btn-danger font-medium text-sm py-1 px-2 rounded-lg">
                                    Delete
                                </button>
                            </td>
                        `;
                        backupListBody.appendChild(row);
                    });
                }
            };
            
            /** Runs hourly to create an automatic backup in localStorage. */
            const checkAndRunAutoBackup = () => {
                const lastBackupTime = parseInt(localStorage.getItem('lastAutoBackupTime') || '0', 10);
                const now = Date.now();
                const oneHour = 60 * 60 * 1000; 

                if (now - lastBackupTime > oneHour) {
                    const backupData = getAllDataAsObject(); 
                    
                    // Don't back up if there's no data
                    if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) {
                        console.log('No data to back up automatically.');
                        return; 
                    }

                    const newBackup = {
                        timestamp: now,
                        type: 'auto',
                        data: backupData 
                    };
                    
                    let currentBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
                    currentBackups.unshift(newBackup); // Add new backup to the top

                    // Keep only the last 3 automatic backups
                    const autoBackups = currentBackups.filter(b => b.type === 'auto');
                    if (autoBackups.length > 3) { // <-- CAMBIO A 3
                        const timestamps = autoBackups.map(b => b.timestamp).sort((a,b) => a - b); // Sort oldest first
                        const oldestTimestamp = timestamps[0];
                        // Find the index of the oldest auto backup in the main array
                        const indexToRemove = currentBackups.findIndex(b => b.timestamp === oldestTimestamp && b.type === 'auto');
                        if (indexToRemove > -1) {
                            currentBackups.splice(indexToRemove, 1);
                        }
                    }

                    localStorage.setItem('mileageBackups', JSON.stringify(currentBackups));
                    localStorage.setItem('lastAutoBackupTime', now.toString());
                    console.log('Automatic backup created (hourly).');
                }
            };

            // =========================================================================
            //  EVENT LISTENERS
            // =========================================================================

            // --- Welcome Screen ---
            setTimeout(() => {
                welcomeScreen.classList.add('opacity-0');
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                }, 500);
            }, 2000); // Hide after 2 seconds

            // --- Driver Info Form ---
            vehicleInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newInfo = {
                    driverName: driverNameInfoInput.value,
                    company: companyInfoInput.value,
                    truckNumber: truckNumberInfoInput.value,
                    trailerNumber: trailerNumberInfoInput.value,
                    initialOdometer: initialOdometerInfoInput.value,
                    ratePerMile: ratePerMileInfoInput.value || '0.70',
                };
                localStorage.setItem('vehicleInfo', JSON.stringify(newInfo));
                vehicleInfo = newInfo; // Update state
                driverVehicleSection.classList.add('hidden');
                showInfoSectionBtn.classList.remove('hidden');
                loadVehicleInfo(); // Reload to update display spans
                updateTotalMiles(); // Recalculate totals with new rate
                showNotification('Driver Info saved successfully.', false);
                moveButtonsUp(); 
            });

            showInfoSectionBtn.addEventListener('click', () => {
                driverVehicleSection.classList.remove('hidden');
                showInfoSectionBtn.classList.add('hidden');
                moveButtonsDown(); 
            });

             cancelInfoEditBtn.addEventListener('click', () => {
                 if (vehicleInfo) { // Only allow cancel if info was already saved
                     driverVehicleSection.classList.add('hidden');
                     showInfoSectionBtn.classList.remove('hidden');
                     // Reset form fields to saved values
                     driverNameInfoInput.value = vehicleInfo.driverName;
                     companyInfoInput.value = vehicleInfo.company;
                     truckNumberInfoInput.value = vehicleInfo.truckNumber;
                     trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                     initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                     ratePerMileInfoInput.value = vehicleInfo.ratePerMile || '0.70';
                     moveButtonsUp(); 
                 } 
             });

            // --- Add Trip Form ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!vehicleInfo || vehicleInfo.initialOdometer === undefined) {
                    showNotification('Please save driver & vehicle info, including an initial odometer, before adding a trip.');
                    return;
                }
                const initialOdometer = Number(vehicleInfo.initialOdometer);
                const endingOdometerInput = document.getElementById('odometer').value;
                const endingOdometer = endingOdometerInput ? Number(endingOdometerInput) : 0;
                let tripMiles = 0;
                let shouldUpdateOdometer = false;

                if (endingOdometer > 0) {
                    if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer.');
                        return;
                    }
                    tripMiles = endingOdometer - initialOdometer;
                    shouldUpdateOdometer = true;
                }

                // CAMBIO: Leer el valor del checkbox
                const isPersonal = document.getElementById('personal-trip').checked;

                const newRecord = {
                    id: Date.now(),
                    date: document.getElementById('date').value, // Stored as YYYY-MM-DD
                    departure: departureInput.value,
                    driverName: vehicleInfo.driverName, // Still store this data even if not shown
                    company: vehicleInfo.company,       // Still store this data even if not shown
                    truckNumber: vehicleInfo.truckNumber, // Still store this data even if not shown
                    trailerNumber: vehicleInfo.trailerNumber, // Still store this data even if not shown
                    initialOdometer: initialOdometer,
                    odometer: endingOdometer,
                    miles: tripMiles,
                    isPersonal: isPersonal // <-- NUEVA PROPIEDAD
                };

                records.push(newRecord);
                records.sort((a, b) => a.id - b.id); // Sort by ID (timestamp)
                
                if (shouldUpdateOdometer) {
                    vehicleInfo.initialOdometer = endingOdometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }
                
                form.reset();
                renderTable(); // Renders, calculates totals, and saves
                loadVehicleInfo(); // Reload info in case odometer changed
                addTripSection.classList.add('hidden');
                showAddTripBtn.classList.remove('hidden'); // Show button in footer
                moveButtonsUp(); 
            });

            // Listener for the BIG Add Trip button in the footer
            showAddTripBtn.addEventListener('click', () => {
                addTripSection.classList.remove('hidden'); // Show the form section
                showAddTripBtn.classList.add('hidden'); // Hide the button itself
                moveButtonsDown(); // Move button down (it hides itself anyway)
            });

            // Listener for the Cancel button within the Add Trip form
            cancelAddTripBtn.addEventListener('click', () => {
                addTripSection.classList.add('hidden'); // Hide the form section
                showAddTripBtn.classList.remove('hidden'); // Show the button in the footer
                form.reset();
                moveButtonsUp(); // Move button back up
            });
            
            // --- Edit Trip Form ---
            editTripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const tripId = Number(document.getElementById('edit-trip-id').value);
                const tripIndex = records.findIndex(r => r.id === tripId);
                if (tripIndex === -1) {
                    showNotification('Could not find trip to update.');
                    return;
                }
                
                // Create updated trip object
                // CAMBIO: Leer el checkbox de edición
                const updatedIsPersonal = document.getElementById('edit-personal-trip').checked;
                const updatedTrip = {
                    ...records[tripIndex], // Keep existing data like driverName etc.
                    date: document.getElementById('edit-date').value, // Stored as YYYY-MM-DD
                    departure: document.getElementById('edit-departure').value,
                    odometer: Number(document.getElementById('edit-odometer').value),
                    isPersonal: updatedIsPersonal // <-- NUEVA PROPIEDAD
                };

                // Recalculate miles for this trip
                const endingOdometer = updatedTrip.odometer;
                const initialOdometer = updatedTrip.initialOdometer;
                if (endingOdometer > 0) {
                     if (endingOdometer < initialOdometer) {
                         showNotification('Ending odometer cannot be less than the initial odometer for this trip.');
                         return;
                    }
                    updatedTrip.miles = endingOdometer - initialOdometer;
                } else {
                    updatedTrip.miles = 0; // If odometer is cleared, miles are 0
                }
                
                // Update the records array
                records[tripIndex] = updatedTrip;
                records.sort((a, b) => a.id - b.id); // Re-sort by ID after edit
                
                // --- ODOMETER FIX ---
                // Check if this was the LAST record in the list
                if (tripIndex === records.length - 1 && updatedTrip.odometer > 0) {
                    // It is the last record, update the main vehicle info
                    vehicleInfo.initialOdometer = updatedTrip.odometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                    loadVehicleInfo(); // Refresh driver info display
                }
                // --- END ODOMETER FIX ---
                
                renderTable(); // Renders, calculates totals, and saves
                closeEditModal();
                showNotification('Trip updated successfully.', false);
            });

            editCloseBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);

            // --- Trip History Table (Toggling & Actions) ---
            // ****** FIX: Check if button exists before adding listener ******
            if (toggleHistoryTableBtn) {
                toggleHistoryTableBtn.addEventListener('click', () => {
                    isHistoryVisible = !isHistoryVisible;
                    if (isHistoryVisible) {
                        historyTableContainer.classList.remove('hidden');
                        historyToggleIcon.classList.remove('rotate-180');
                        moveButtonsDown(); 
                    } else {
                        historyTableContainer.classList.add('hidden');
                        historyToggleIcon.classList.add('rotate-180');
                        moveButtonsUp(); 
                    }
                });
            } else {
                console.error("Could not find 'toggle-history-table-btn'.");
            }

            // --- NEW: View Current Report Button ---
            if (viewCurrentReportBtn) {
                viewCurrentReportBtn.addEventListener('click', async () => {
                    if (records.length === 0) {
                        showNotification('No trips to show in a report yet.');
                        return;
                    }
                    await generateAndHandlePdf(records, true); // true = forSharing
                });
            } else {
                console.error("Could not find 'view-current-report-btn'.");
            }

            // ****** FIX: Check if tableBody exists ******
            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    // Handle Delete
                    if (e.target.classList.contains('delete-btn')) {
                        const idToDelete = Number(e.target.dataset.id);
                        // NUEVO: Abrir modal de confirmación en lugar de borrar directamente
                        openConfirmDeleteModal(
                            'Delete Trip', 
                            'Are you sure you want to delete this trip? This cannot be undone.', 
                            { type: 'trip', id: idToDelete }
                        );
                    } 
                    // Handle Edit
                    else if (e.target.classList.contains('edit-btn')) {
                        const idToEdit = Number(e.target.dataset.id);
                        const tripToEdit = records.find(r => r.id === idToEdit);
                        if (tripToEdit) {
                            openEditModal(tripToEdit);
                        }
                    }
                });
            } else {
                console.error("Could not find 'mileage-table-body'.");
            }
            
            // --- Archive & Reset Workflow ---
            archiveResetBtn.addEventListener('click', openConfirmModal);
            confirmNoBtn.addEventListener('click', closeConfirmModal);
            confirmYesBtn.addEventListener('click', async () => {
                if (records.length === 0) {
                    showNotification('No trips to archive.');
                    closeConfirmModal();
                    return;
                }
                
                // 1. Generate PDF for download (forSharing=false)
                await generateAndHandlePdf(records, false); 

                // 2. Create archive summary
                // CAMBIO: Calcular totales solo de viajes pagables
                const rate = parseFloat(vehicleInfo?.ratePerMile || '0.70');
                const payableRecords = records.filter(record => !record.isPersonal);
                const totalMiles = payableRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                const totalAmount = totalMiles * rate;
                const firstDate = records[0]?.date; // YYYY-MM-DD
                const lastDate = records[records.length - 1]?.date; // YYYY-MM-DD
                const period = firstDate === lastDate ? firstDate : `${firstDate} to ${lastDate}`;
                
                const newArchiveEntry = {
                    id: Date.now(),
                    archiveDate: new Date().toLocaleDateString(), // Stored in local format (e.g., MM/DD/YYYY)
                    period: period, // Stored as "YYYY-MM-DD to YYYY-MM-DD"
                    totalMiles: totalMiles,
                    totalAmount: totalAmount,
                    detailedRecords: [...records], // Store a snapshot of the records
                    ratePerMile: rate
                };

                archiveHistory.unshift(newArchiveEntry); // Add to beginning of history
                localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));

                // 3. Update initial odometer
                const lastValidRecord = [...records].reverse().find(r => r.odometer > 0);
                if (lastValidRecord && vehicleInfo) {
                    vehicleInfo.initialOdometer = lastValidRecord.odometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }

                // 4. Clear current records
                records = []; 
                localStorage.setItem('mileageRecords', JSON.stringify(records));
                
                // 5. Refresh UI
                renderTable(); 
                loadVehicleInfo(); 
                closeConfirmModal();
                showNotification('Trips have been archived and reset.', false);
            });
            
            // --- Archive History Modal Workflow ---
            viewHistoryBtn.addEventListener('click', openHistoryModal);
            historyCloseBtn.addEventListener('click', closeHistoryModal);
            closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
            clearHistoryBtn.addEventListener('click', openConfirmClearModal);
            confirmClearNoBtn.addEventListener('click', closeConfirmClearModal);
            
            confirmClearYesBtn.addEventListener('click', () => {
                archiveHistory = [];
                localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
                renderArchiveHistoryTable(); // Update the table in the modal
                closeConfirmClearModal();
                showNotification('Archive history has been cleared.', false);
            });

            // ****** FIX: Check if archiveHistoryTableBody exists ******
            if (archiveHistoryTableBody) {
                archiveHistoryTableBody.addEventListener('click', async (e) => {
                    // Generate PDF from archived data
                    if (e.target.classList.contains('generate-history-pdf-btn')) {
                        const id = Number(e.target.dataset.id);
                        const entry = archiveHistory.find(item => item.id === id);
                        if (entry && entry.detailedRecords) {
                            showNotification('Generating PDF for archived period...', false);
                            await generateAndHandlePdf(entry.detailedRecords, false); // CAMBIO: 'true' cambiado a 'false'
                        } else {
                            showNotification('Could not find detailed records for this archive entry.');
                        }
                    }
                    // CAMBIO: Añadir listener para el botón de borrar archivo
                    else if (e.target.classList.contains('delete-archive-btn')) {
                        const idToDelete = Number(e.target.dataset.id);
                        openConfirmDeleteModal(
                            'Delete Archive Entry', 
                            'Are you sure you want to delete this archive entry? This cannot be undone.', 
                            { type: 'archive', id: idToDelete }
                        );
                    }
                });
            } else {
                console.error("Could not find 'archive-history-table-body'.");
            }
            
            // --- Backup & Restore Modal Workflow ---
            openBackupModalBtn.addEventListener('click', openBackupModal);
            backupCloseBtn.addEventListener('click', closeBackupModal);
            closeBackupModalBtn.addEventListener('click', closeBackupModal);

            btnDownloadBackup.addEventListener('click', () => {
                const backupData = getAllDataAsObject();
                // Check if there is actually data to backup
                if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) {
                    showNotification('No data to back up.');
                    return; 
                }
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `truck_mileage_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            btnUploadBackup.addEventListener('click', () => {
                uploadBackupInput.click(); // Trigger hidden file input
            });

            uploadBackupInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        // Validate file structure
                        if (data.hasOwnProperty('vehicleInfo') && data.hasOwnProperty('records') && data.hasOwnProperty('archiveHistory')) {
                            localStorage.setItem('pendingRestoreData', JSON.stringify(data));
                            openConfirmRestoreModal('Are you sure you want to restore from this file? All current data will be overwritten.');
                        } else {
                            showNotification('Invalid backup file format.');
                        }
                    } catch (err) {
                        showNotification('Could not read backup file.');
                    }
                    e.target.value = null; // Reset input to allow same file upload again
                };
                reader.readAsText(file);
            });

            // --- Restore Confirmation Workflow ---
            confirmRestoreNoBtn.addEventListener('click', closeConfirmRestoreModal);
            confirmRestoreYesBtn.addEventListener('click', () => {
                const dataToRestoreJSON = localStorage.getItem('pendingRestoreData');
                if (!dataToRestoreJSON) return;
                
                const dataToRestore = JSON.parse(dataToRestoreJSON);
                
                // Overwrite all data in localStorage
                localStorage.setItem('vehicleInfo', JSON.stringify(dataToRestore.vehicleInfo));
                localStorage.setItem('mileageRecords', JSON.stringify(dataToRestore.records));
                localStorage.setItem('archiveHistory', JSON.stringify(dataToRestore.archiveHistory));
                
                localStorage.removeItem('pendingRestoreData');
                closeConfirmRestoreModal();
                closeBackupModal(); // Close the main backup modal too
                
                showNotification('Data restored successfully. Reloading...', false);
                
                // Reload the page to apply all changes
                setTimeout(() => {
                    location.reload();
                }, 1500); 
            });
            
            // --- Backup List Actions (Delete/Restore) ---
            // ****** FIX: Check if backupListBody exists ******
            if (backupListBody) {
                backupListBody.addEventListener('click', (e) => {
                    const timestamp = e.target.dataset.timestamp;
                    if (!timestamp) return;

                    // Restore from a backup in the list
                    if (e.target.classList.contains('restore-backup-btn')) {
                        const backup = mileageBackups.find(b => b.timestamp == timestamp);
                        if (backup) {
                            localStorage.setItem('pendingRestoreData', JSON.stringify(backup.data));
                            openConfirmRestoreModal(`Are you sure you want to restore the backup from ${formatDateToMMDDYY(Number(backup.timestamp))}? All current data will be overwritten.`);
                        }
                    }

                    // Delete a backup from the list
                    if (e.target.classList.contains('delete-backup-btn')) {
                        const timestamp = e.target.dataset.timestamp; // Get timestamp (ID)
                        // NUEVO: Abrir modal de confirmación en lugar de borrar directamente
                        openConfirmDeleteModal(
                            'Delete Backup', 
                            'Are you sure you want to delete this backup? This cannot be undone.', 
                            { type: 'backup', id: timestamp }
                        );
                    }
                });
            } else {
                console.error("Could not find 'backup-list-body'.");
            }

            // --- Clear Backups Workflow ---
            clearBackupsBtn.addEventListener('click', openConfirmClearBackupsModal);
            confirmClearBackupsNoBtn.addEventListener('click', closeConfirmClearBackupsModal);
            confirmClearBackupsYesBtn.addEventListener('click', () => {
                mileageBackups = [];
                localStorage.setItem('mileageBackups', JSON.stringify(mileageBackups));
                localStorage.removeItem('lastAutoBackupTime'); // Reset auto-backup timer
                 renderBackupList(); 
                closeConfirmClearBackupsModal();
                showNotification('All backups cleared.', false);
            });

            // --- NEW: Generic Delete Confirmation Workflow ---
            confirmDeleteNoBtn.addEventListener('click', closeConfirmDeleteModal);
            confirmDeleteYesBtn.addEventListener('click', () => {
                const pendingDeleteJSON = localStorage.getItem('pendingDelete');
                if (!pendingDeleteJSON) return;

                const pendingDelete = JSON.parse(pendingDeleteJSON);

                if (pendingDelete.type === 'trip') {
                    // Logic to delete a trip
                    records = records.filter(record => record.id !== pendingDelete.id);
                    renderTable(); // Re-render table after deleting
                    showNotification('Trip deleted.', false);
                } else if (pendingDelete.type === 'backup') {
                    // Logic to delete a backup
                    const timestamp = pendingDelete.id;
                    mileageBackups = mileageBackups.filter(b => b.timestamp != timestamp);
                    localStorage.setItem('mileageBackups', JSON.stringify(mileageBackups));
                    renderBackupList(); // Refresh the list
                    showNotification('Backup deleted.', false);
                }
                // CAMBIO: Añadir lógica para borrar archivos
                else if (pendingDelete.type === 'archive') {
                    const idToDelete = Number(pendingDelete.id);
                    archiveHistory = archiveHistory.filter(entry => entry.id !== idToDelete);
                    localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
                    renderArchiveHistoryTable(); // Refresh the list in the modal
                    showNotification('Archive entry deleted.', false);
                }

                closeConfirmDeleteModal(); // Cierra el modal y limpia 'pendingDelete'
            });
            
            
            // =========================================================================
            //  INITIALIZATION
            // =========================================================================
            
            loadVehicleInfo();
            renderTable(); // This will also call updateLastTripDisplay
            checkAndRunAutoBackup(); // Run the auto-backup check on page load

            // Initially hide the large Add button if the Add Trip section is hidden (default state)
            if (addTripSection.classList.contains('hidden')) {
                 showAddTripBtn.classList.remove('hidden'); // Ensure button is visible initially
            } else {
                 showAddTripBtn.classList.add('hidden'); // Ensure button is hidden if section starts open (unlikely)
                 moveButtonsDown(); // Keep button down if section starts open
            }
             moveButtonsUp(); // Make sure buttons are up initially if nothing is open


        });
    </script>

</body>
</html>

