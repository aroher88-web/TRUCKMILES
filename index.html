<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Mileage Tracker</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fondo degradado para el efecto glassmorphism */
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 100%);
        }
        /* Welcome screen animation */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        .welcome-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        /* Simple animation for the loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar for modal content */
        #edit-modal-content::-webkit-scrollbar, #confirm-modal-content::-webkit-scrollbar, #history-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #edit-modal-content::-webkit-scrollbar-track, #confirm-modal-content::-webkit-scrollbar-track, #history-modal-content::-webkit-scrollbar-track {
            background: rgba(45, 55, 72, 0.5); /* gray-800 semi-transparente */
        }
        #edit-modal-content::-webkit-scrollbar-thumb, #confirm-modal-content::-webkit-scrollbar-thumb, #history-modal-content::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.7); /* gray-600 semi-transparente */
            border-radius: 4px;
        }
       #edit-modal-content::-webkit-scrollbar-thumb:hover, #confirm-modal-content::-webkit-scrollbar-thumb:hover, #history-modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(113, 128, 150, 0.8); /* gray-500 semi-transparente */
        }
       
       /* Clase para el efecto Glassmorphism */
       .glass-effect {
            background-color: rgba(255, 255, 255, 0.05); /* Ligeramente blanco */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
       }

       /* Estilo para los inputs con efecto glass */
       .glass-input {
            background-color: rgba(17, 24, 39, 0.5); /* gray-900 semi-transparente */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
       }
       .glass-input::placeholder {
            color: rgba(209, 213, 219, 0.6); /* gray-300 semi-transparente */
       }
       .glass-input:focus {
            background-color: rgba(17, 24, 39, 0.7);
            border-color: rgba(59, 130, 246, 0.7); /* cyan-500 semi-transparente */
            --tw-ring-color: rgba(59, 130, 246, 0.5);
       }

       /* Para el color del texto del date picker */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 flex items-center justify-center">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <svg id="welcome-truck-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 100" class="w-64 h-auto mb-8">
            <!-- Trailer -->
            <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
            <!-- Cab -->
            <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
            <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
            <!-- Wheels with native SVG animation -->
            <g>
                <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="50" cy="70" r="5" fill="#4A5568"/>
                <animateTransform attributeName="transform" type="rotate" from="0 50 70" to="360 50 70" dur="1s" repeatCount="indefinite"/>
            </g>
            <g>
                <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="230" cy="70" r="5" fill="#4A5568"/>
                <animateTransform attributeName="transform" type="rotate" from="0 230 70" to="360 230 70" dur="1s" repeatCount="indefinite"/>
            </g>
             <g>
                <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="260" cy="70" r="5" fill="#4A5568"/>
                <animateTransform attributeName="transform" type="rotate" from="0 260 70" to="360 260 70" dur="1s" repeatCount="indefinite"/>
            </g>
        </svg>
        <h1 class="text-4xl font-bold text-cyan-400 welcome-animation">Hello Drivers, Stay safe.</h1>
    </div>

    <!-- Main Content Container -->
    <div class="w-full max-w-7xl glass-effect rounded-2xl shadow-lg p-6 md:p-8 m-4">
        
        <header class="mb-6 text-center">
            <svg id="company-logo-svg" viewBox="0 0 300 100" class="h-20 w-auto mx-auto" xmlns="http://www.w3.org/2000/svg">
                <!-- Static version of the truck for the header and PDF -->
                <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
                <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
                <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
                <g>
                    <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="50" cy="70" r="5" fill="#4A5568"/>
                </g>
                <g>
                    <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="230" cy="70" r="5" fill="#4A5568"/>
                </g>
                 <g>
                    <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="260" cy="70" r="5" fill="#4A5568"/>
                </g>
            </svg>
            <h1 class="text-3xl font-bold text-cyan-400 mt-2">Truck Mileage Tracker</h1>
            <p class="text-gray-300 mt-1">Log your trips and keep accurate track of your miles.</p>
            <!-- Button to show/edit info -->
            <button id="show-info-section-btn" class="hidden mt-4 glass-effect hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                View/Edit Driver Info
            </button>
        </header>

        <!-- Driver & Vehicle Info Section (Collapsible) -->
        <div id="driver-vehicle-section" class="glass-effect p-6 rounded-xl mb-8">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Driver & Vehicle Info</h2>
            </div>
            <!-- Info Display Area (No longer used, form shown directly for editing) -->
            <div id="vehicle-info-display" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 text-gray-300">
                    <p><strong>Driver:</strong> <span id="display-driverName"></span></p>
                    <p><strong>Company:</strong> <span id="display-company"></span></p>
                    <p><strong>Truck #:</strong> <span id="display-truckNumber"></span></p>
                    <p><strong>Trailer #:</strong> <span id="display-trailerNumber"></span></p>
                    <p><strong>Initial Odometer:</strong> <span id="display-initialOdometer"></span></p>
                </div>
            </div>
            <!-- Info Edit Form -->
            <form id="vehicle-info-form" class="hidden"> 
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1">Driver Name</label>
                        <input type="text" id="driverNameInfo" placeholder="Your Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
                        <input type="text" id="companyInfo" placeholder="Your Company Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Truck #</label>
                        <input type="text" id="truckNumberInfo" placeholder="e.g., T-123" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                     <div>
                        <label for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Trailer #</label>
                        <input type="text" id="trailerNumberInfo" placeholder="e.g., P-456" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="mb-4">
                     <label for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1">Initial Odometer</label>
                     <input type="text" inputmode="numeric" pattern="[0-9]*" id="initialOdometerInfo" placeholder="e.g., 150000" required class="w-full md:w-1/4 glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="flex justify-end gap-4">
                     <button type="button" id="cancel-info-edit-btn" class="glass-effect hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hidden">Cancel</button>
                    <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Save Info</button>
                </div>
            </form>
        </div>

        <!-- Add New Trip Section -->
        <div class="glass-effect p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Trip</h2>
            <form id="mileage-form">
                <!-- Grid changed to 8 columns for finer control -->
                <div class="grid grid-cols-1 md:grid-cols-8 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label for="departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label for="odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300">
                        Add Trip
                    </button>
                </div>
            </form>
        </div>

        <!-- Trip History Section -->
        <div>
            <!-- Control Buttons & Totals (Always Visible) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 <button type="button" id="share-pdf-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                    Share PDF
                </button>
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm">Total Miles</span>
                    <span id="total-miles" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center h-full">
                    <span class="font-medium text-gray-300 text-sm">Amount to Charge</span>
                    <span id="total-amount" class="font-bold text-2xl text-green-400">$0.00</span>
                </div>
                 <button type="button" id="archive-reset-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm1-4a1 1 0 000 2h10a1 1 0 100-2H5z" clip-rule="evenodd"></path></svg>
                    Archive &amp; Reset
                </button>
            </div>

            <!-- Collapsible Table Section Header -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Trip History</h2>
                <button id="toggle-history-table-btn" class="text-gray-300 hover:text-white p-2 rounded-full" title="Toggle History">
                    <svg id="history-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
            </div>
            
            <!-- Collapsible Table Wrapper (Starts hidden) -->
            <div id="history-table-container" class="hidden">
                <div class="overflow-x-auto rounded-lg glass-effect border-none">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-cyan-300 uppercase bg-white/5">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Driver</th>
                                <th scope="col" class="px-6 py-3">Departure</th>
                                <th scope="col" class="px-6 py-3">Initial Odometer</th>
                                <th scope="col" class="px-6 py-3">Ending Odometer</th>
                                <th scope="col" class="px-6 py-3">Company</th>
                                <th scope="col" class="px-6 py-3">Truck #</th>
                                <th scope="col" class="px-6 py-3">Trailer #</th>
                                <th scope="col" class="px-6 py-3">Miles</th>
                                <th scope="col" class="px-6 py-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mileage-table-body">
                            <!-- Filas de ejemplo con efecto glass -->
                            <tr id="empty-row" class="bg-white/5 border-b border-white/10">
                               <td colspan="10" class="text-center py-8 text-gray-400">No records yet.</td>
                            </tr>
                            <!-- Las filas se añadirán aquí, tendrán bg-white/5 y border-white/10 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Last Archive Summary (Restored) -->
            <div id="last-archive-summary" class="hidden mt-8 md:w-2/5">
                <h3 class="text-lg font-semibold mb-3 text-gray-300">Last Archive Summary</h3>
                <div class="glass-effect rounded-lg p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300 text-sm">Period</span>
                        <span id="last-archive-period" class="font-bold text-sm text-white"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300 text-sm">Total Miles</span>
                        <span id="last-archive-miles" class="font-bold text-lg text-cyan-400">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300 text-sm">Total Amount</span>
                        <span id="last-archive-amount" class="font-bold text-lg text-green-400">$0.00</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- New "View Archive History" Button -->
        <div class="fixed bottom-6 right-6 z-40">
            <button id="view-history-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-colors duration-300 flex items-center justify-center gap-2" title="View Archive History">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </button>
        </div>

    </div> <!-- End Main Content Container -->
    
    <!-- Modal for Editing a Trip -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg" id="edit-modal-content">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-yellow-400">Edit Trip</h3>
                <button id="edit-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1">Departure</label>
                        <input type="text" id="edit-departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="edit-odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>
                <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-btn" class="glass-effect hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg" id="confirm-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 class="text-lg font-semibold text-red-400">Confirm Action</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p>Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-no-btn" class="glass-effect hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Archive & Reset</button>
            </div>
        </div>
    </div>

    <!-- New Archive History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-4xl flex flex-col" style="height: 80vh;"> <!-- Increased width -->
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-blue-400">Archive History</h3>
                <button id="history-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto" id="history-modal-content">
                <div class="overflow-x-auto rounded-lg border border-white/10">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-blue-300 uppercase bg-white/5">
                            <tr>
                                <th scope="col" class="px-6 py-3">Archive Date</th>
                                <th scope="col" class="px-6 py-3">Period</th>
                                <th scope="Two">Total Miles</th>
                                <th scope="col" class="px-6 py-3">Total Amount</th>
                                <th scope="col" class="px-6 py-3 text-center">Actions</th> <!-- New Column -->
                            </tr>
                        </thead>
                        <tbody id="archive-history-table-body">
                            <!-- History rows will be injected here -->
                            <tr id="empty-history-row" class="bg-white/5 border-b border-white/10">
                               <td colspan="5" class="text-center py-8 text-gray-400">No archive history yet.</td> <!-- Updated colspan -->
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button type="button" id="clear-history-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Clear History</button>
                <button type="button" id="close-history-modal-btn" class="glass-effect hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>


    <!-- Notification Element -->
    <div id="notification" class="fixed top-5 right-5 glass-effect text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>


    <script>
        // --- Global Notification Function ---
        const showNotification = (message, isError = true) => {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');
            if (!notification || !notificationMessage) return;

            notificationMessage.textContent = message;
            notification.classList.remove('bg-red-600', 'bg-green-500');
            // Remove glass-effect base, apply colored glass
            notification.classList.add(isError ? 'bg-red-600/70' : 'bg-green-500/70');
            notification.classList.add('backdrop-blur-md');
            notification.classList.remove('opacity-0');
            setTimeout(() => {
                notification.classList.add('opacity-0');
            }, 4000);
        };
        
        const getSvgAsImageBase64 = (svgElement) => {
            return new Promise((resolve, reject) => {
                if (!svgElement) return reject("SVG element not provided");
                const clone = svgElement.cloneNode(true);
                const animations = clone.querySelectorAll('animateTransform');
                animations.forEach(anim => anim.remove());
                const svgString = new XMLSerializer().serializeToString(clone);
                const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                const url = URL.createObjectURL(svgBlob);
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const viewBox = clone.getAttribute('viewBox').split(' ').map(Number);
                    const width = viewBox[2];
                    const height = viewBox[3];
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = (err) => {
                    URL.revokeObjectURL(url);
                    reject(err);
                };
                img.src = url;
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Welcome Screen Logic ---
            const welcomeScreen = document.getElementById('welcome-screen');
            setTimeout(() => {
                welcomeScreen.classList.add('opacity-0');
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                }, 500);
            }, 3000);

            // --- Element Selectors ---
            const form = document.getElementById('mileage-form');
            const tableBody = document.getElementById('mileage-table-body');
            const totalMilesEl = document.getElementById('total-miles');
            const totalAmountEl = document.getElementById('total-amount');
            const emptyRow = document.getElementById('empty-row');
            const departureInput = document.getElementById('departure');
            
            // Driver Info Section
            const vehicleInfoForm = document.getElementById('vehicle-info-form');
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display');
            const driverVehicleSection = document.getElementById('driver-vehicle-section');
            const showInfoSectionBtn = document.getElementById('show-info-section-btn');
            const cancelInfoEditBtn = document.getElementById('cancel-info-edit-btn'); 
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');

            // Control Buttons
            const sharePdfBtn = document.getElementById('share-pdf-btn');
            const archiveResetBtn = document.getElementById('archive-reset-btn');

            // History Table Section
            const toggleHistoryTableBtn = document.getElementById('toggle-history-table-btn');
            const historyToggleIcon = document.getElementById('history-toggle-icon');
            const historyTableContainer = document.getElementById('history-table-container');

            // Last Archive Summary
            const lastArchiveSummary = document.getElementById('last-archive-summary');
            const lastArchivePeriod = document.getElementById('last-archive-period');
            const lastArchiveMiles = document.getElementById('last-archive-miles');
            const lastArchiveAmount = document.getElementById('last-archive-amount');

            // Edit Modal
            const editModal = document.getElementById('edit-modal');
            const editTripForm = document.getElementById('edit-trip-form');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Confirm Modal
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            // Archive History Modal
            const historyModal = document.getElementById('history-modal');
            const viewHistoryBtn = document.getElementById('view-history-btn');
            const historyCloseBtn = document.getElementById('history-close-btn');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const archiveHistoryTableBody = document.getElementById('archive-history-table-body');
            const emptyHistoryRow = document.getElementById('empty-history-row');

            // --- State Variables ---
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || [];
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
            let archiveHistory = JSON.parse(localStorage.getItem('archiveHistory')) || [];
            let isHistoryVisible = false; // Table starts hidden

            // --- Driver Info Logic ---
            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                if (vehicleInfo) {
                    driverVehicleSection.classList.add('hidden');
                    showInfoSectionBtn.classList.remove('hidden');
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();
                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.remove('hidden');
                } else {
                    driverVehicleSection.classList.remove('hidden');
                    showInfoSectionBtn.classList.add('hidden');
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.add('hidden');
                }
            };
            
            showInfoSectionBtn.addEventListener('click', () => {
                driverVehicleSection.classList.remove('hidden');
                showInfoSectionBtn.classList.add('hidden');
            });

             cancelInfoEditBtn.addEventListener('click', () => {
                if (vehicleInfo) {
                    driverVehicleSection.classList.add('hidden');
                    showInfoSectionBtn.classList.remove('hidden');
                } 
            });

            vehicleInfoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newInfo = {
                    driverName: driverNameInfoInput.value,
                    company: companyInfoInput.value,
                    truckNumber: truckNumberInfoInput.value,
                    trailerNumber: trailerNumberInfoInput.value,
                    initialOdometer: initialOdometerInfoInput.value,
                };
                localStorage.setItem('vehicleInfo', JSON.stringify(newInfo));
                vehicleInfo = newInfo;
                driverVehicleSection.classList.add('hidden');
                showInfoSectionBtn.classList.remove('hidden');
                loadVehicleInfo(); 
                showNotification('Driver Info saved successfully.', false);
            });
            
            // --- Trip Table Logic ---
            const renderTable = () => {
                tableBody.innerHTML = '';
                if (records.length === 0) {
                    tableBody.appendChild(emptyRow.cloneNode(true));
                    sharePdfBtn.disabled = true;
                    archiveResetBtn.disabled = true;
                    sharePdfBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    archiveResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    sharePdfBtn.disabled = false;
                    archiveResetBtn.disabled = false;
                    sharePdfBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => {
                        const row = document.createElement('tr');
                        // Glass effect for table rows
                        row.className = 'bg-white/5 border-b border-white/10 hover:bg-white/10';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${record.date}</td>
                            <td class="px-6 py-4">${record.driverName}</td>
                            <td class="px-6 py-4">${record.departure}</td>
                            <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${Number(record.odometer) === 0 ? '' : Number(record.odometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${record.company}</td>
                            <td class="px-6 py-4">${record.truckNumber}</td>
                            <td class="px-6 py-4">${record.trailerNumber}</td>
                            <td class="px-6 py-4 font-bold text-cyan-400">${Number(record.miles) === 0 ? '' : Number(record.miles).toLocaleString()}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${record.id}" class="edit-btn text-yellow-500 hover:text-yellow-400 font-medium mr-4">Edit</button>
                                <button data-id="${record.id}" class="delete-btn text-red-500 hover:text-red-400 font-medium">Delete</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                updateTotalMiles();
                saveToLocalStorage();
            };

            const updateTotalMiles = () => {
                const total = records.reduce((sum, record) => sum + Number(record.miles), 0);
                totalMilesEl.textContent = total.toLocaleString();
                const amount = total * 0.70;
                totalAmountEl.textContent = amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            const saveToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!vehicleInfo || vehicleInfo.initialOdometer === undefined) {
                    showNotification('Please save driver & vehicle info, including an initial odometer, before adding a trip.');
                    return;
                }
                const initialOdometer = Number(vehicleInfo.initialOdometer);
                const endingOdometerInput = document.getElementById('odometer').value;
                const endingOdometer = endingOdometerInput ? Number(endingOdometerInput) : 0;
                let tripMiles = 0;
                let shouldUpdateOdometer = false;
                if (endingOdometer > 0) {
                    if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer.');
                        return;
                    }
                    tripMiles = endingOdometer - initialOdometer;
                    shouldUpdateOdometer = true;
                }
                const newRecord = {
                    id: Date.now(),
                    date: document.getElementById('date').value,
                    departure: departureInput.value,
                    driverName: vehicleInfo.driverName,
                    company: vehicleInfo.company,
                    truckNumber: vehicleInfo.truckNumber,
                    trailerNumber: vehicleInfo.trailerNumber,
                    initialOdometer: initialOdometer,
                    odometer: endingOdometer,
                    miles: tripMiles,
                };
                records.push(newRecord);
                records.sort((a, b) => a.id - b.id);
                if (shouldUpdateOdometer) {
                    vehicleInfo.initialOdometer = endingOdometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }
                form.reset();
                renderTable();
                loadVehicleInfo();
            });
            
            // --- History Table Toggle Logic ---
            toggleHistoryTableBtn.addEventListener('click', () => {
                isHistoryVisible = !isHistoryVisible;
                if (isHistoryVisible) {
                    historyTableContainer.classList.remove('hidden');
                    historyToggleIcon.classList.remove('rotate-180');
                } else {
                    historyTableContainer.classList.add('hidden');
                    historyToggleIcon.classList.add('rotate-180');
                }
            });

            // --- PDF Generation Logic ---
            const generateAndHandlePdf = async (recordsToExport, forSharing = true) => {
                 if (!recordsToExport || recordsToExport.length === 0) {
                    showNotification('No data to generate a report.');
                    return;
                }
                let logoBase64;
                try {
                    logoBase64 = await getSvgAsImageBase64(document.getElementById('welcome-truck-svg')); 
                } catch (error) {
                    showNotification('Could not load company logo for the PDF report.');
                }
                const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                showNotification(`Generating ${uniqueDrivers.length} PDF report(s)...`, false);
                for (const driver of uniqueDrivers) {
                    const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                     const driverInfo = {
                        driverName: driver,
                        company: driverRecords[0]?.company || vehicleInfo?.company || 'N/A',
                        truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber || 'N/A',
                        trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber || 'N/A',
                    };
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const totalMilesForDriver = driverRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                    let startY = 15;
                    if(logoBase64) {
                        const imgWidth = 60;
                        const imgHeight = 20;
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const x = (pageWidth - imgWidth) / 2;
                        doc.addImage(logoBase64, 'PNG', x, 15, imgWidth, imgHeight);
                        startY = 45;
                    }
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                    startY += 8;
                    const headerParts = [
                        { text: `Driver: `, style: 'normal' },
                        { text: driverInfo.driverName, style: 'bold', size: 13 },
                        { text: ` | Truck #: ${driverInfo.truckNumber} | Trailer #: ${driverInfo.trailerNumber}`, style: 'normal' }
                    ];
                    let currentX = doc.internal.pageSize.getWidth() / 2;
                    const totalWidth = headerParts.reduce((sum, part) => {
                        doc.setFont('helvetica', part.style || 'normal');
                        doc.setFontSize(part.size || 11);
                        return sum + doc.getTextWidth(part.text);
                    }, 0);
                    currentX -= totalWidth / 2;
                    doc.setTextColor(50);
                    headerParts.forEach(part => {
                        doc.setFont('helvetica', part.style || 'normal');
                        doc.setFontSize(part.size || 11);
                        doc.text(part.text, currentX, startY);
                        currentX += doc.getTextWidth(part.text);
                    });
                    startY += 15;
                    const tableColumn = ["Date", "City", "Odometer", "Miles"];
                    const tableRows = driverRecords.map(r => [
                        r.date, 
                        r.departure, 
                        Number(r.odometer) === 0 ? '' : Number(r.odometer).toLocaleString(), 
                        Number(r.miles) === 0 ? '' : Number(r.miles).toLocaleString()
                    ]);
                    doc.autoTable(tableColumn, tableRows, { startY: startY });
                    const finalY = doc.lastAutoTable.finalY || startY;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Total Miles: ${totalMilesForDriver.toLocaleString()}`, 14, finalY + 15);
                    const today = new Date().toLocaleDateString();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(150);
                    doc.text("Developed for AROHER88", pageWidth - 14, doc.internal.pageSize.getHeight() - 15, { align: 'right' });
                    doc.text(`Date: ${today}`, pageWidth - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                    if(forSharing) {
                        const pdfBlob = doc.output('blob');
                        const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' });
                        const shareData = { files: [pdfFile], title: `Mileage Report for ${driverInfo.driverName}` };
                        if (navigator.canShare && navigator.canShare(shareData)) {
                            try { await navigator.share(shareData); } catch (err) {
                                if (err.name !== 'AbortError') { showNotification(`Could not share report for ${driverInfo.driverName}.`);}
                            }
                        } else {
                            showNotification(`Browser doesn't support sharing. Downloading report for ${driverInfo.driverName}.`, false);
                            doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                        }
                    } else {
                         doc.save(`ARCHIVED_mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                    }
                }
            };

            sharePdfBtn.addEventListener('click', () => {
                if (records.length === 0) {
                    showNotification('No trip data to share.');
                    return;
                }
                generateAndHandlePdf(records, true);
            });

            // --- Edit Modal Logic ---
            const openEditModal = (trip) => {
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date;
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            };

            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editTripForm.reset();
            };

            editCloseBtn.addEventListener('click', closeEditModal);
            cancelEditBtn.addEventListener('click', closeEditModal);

            editTripForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const tripId = Number(document.getElementById('edit-trip-id').value);
                const tripIndex = records.findIndex(r => r.id === tripId);
                if (tripIndex === -1) {
                    showNotification('Could not find trip to update.');
                    return;
                }
                const updatedTrip = {
                    ...records[tripIndex],
                    date: document.getElementById('edit-date').value,
                    departure: document.getElementById('edit-departure').value,
                    odometer: Number(document.getElementById('edit-odometer').value)
                };
                const endingOdometer = updatedTrip.odometer;
                const initialOdometer = updatedTrip.initialOdometer;
                if (endingOdometer > 0) {
                     if (endingOdometer < initialOdometer) {
                        showNotification('Ending odometer cannot be less than the initial odometer for this trip.');
                        return;
                    }
                    updatedTrip.miles = endingOdometer - initialOdometer;
                } else {
                    updatedTrip.miles = 0;
                }
                records[tripIndex] = updatedTrip;
                records.sort((a, b) => a.id - b.id);
                renderTable();
                saveToLocalStorage();
                closeEditModal();
                showNotification('Trip updated successfully.', false);
            });
            
            // --- Last Archive Summary Logic ---
            const loadLastArchiveSummary = () => {
                const summary = JSON.parse(localStorage.getItem('lastArchiveSummary')) || null;
                if (summary) {
                    lastArchivePeriod.textContent = summary.period;
                    lastArchiveMiles.textContent = summary.totalMiles.toLocaleString();
                    lastArchiveAmount.textContent = summary.totalAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                    lastArchiveSummary.classList.remove('hidden');
                } else {
                    lastArchiveSummary.classList.add('hidden');
                }
            };

            // --- Archive & Reset Logic ---
            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
            };
            const closeConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            };

            archiveResetBtn.addEventListener('click', openConfirmModal);
            confirmNoBtn.addEventListener('click', closeConfirmModal);
            
            confirmYesBtn.addEventListener('click', async () => {
                if (records.length === 0) {
                    showNotification('No trips to archive.');
                    closeConfirmModal();
                    return;
                }
                
                await generateAndHandlePdf(records, false);

                // --- Archive History Logic ---
                const totalMiles = records.reduce((sum, record) => sum + Number(record.miles), 0);
                const totalAmount = totalMiles * 0.70;
                const firstDate = records[0]?.date;
                const lastDate = records[records.length - 1]?.date;
                const period = firstDate === lastDate ? firstDate : `${firstDate} to ${lastDate}`;
                
                const newArchiveEntry = {
                    id: Date.now(),
                    archiveDate: new Date().toLocaleDateString(),
                    period: period,
                    totalMiles: totalMiles,
                    totalAmount: totalAmount,
                    detailedRecords: [...records] // Save a copy of the detailed records
                };

                // Save to full archive history
                archiveHistory.unshift(newArchiveEntry); // Add to the beginning
                localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));

                // Save to last archive summary
                localStorage.setItem('lastArchiveSummary', JSON.stringify(newArchiveEntry));
                loadLastArchiveSummary(); // Update the UI
                // --- End Archive History Logic ---

                const lastValidRecord = [...records].reverse().find(r => r.odometer > 0);
                if (lastValidRecord) {
                    vehicleInfo.initialOdometer = lastValidRecord.odometer;
                    localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                }
                records = [];
                localStorage.setItem('mileageRecords', JSON.stringify(records));
                renderTable();
                loadVehicleInfo();
                closeConfirmModal();
                showNotification('Trips have been archived and reset.', false);
            });
            
            // --- Table Event Listeners (Edit/Delete) ---
            tableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = Number(e.target.dataset.id);
                    records = records.filter(record => record.id !== idToDelete);
                    renderTable();
                } else if (e.target.classList.contains('edit-btn')) {
                    const idToEdit = Number(e.target.dataset.id);
                    const tripToEdit = records.find(r => r.id === idToEdit);
                    if (tripToEdit) {
                        openEditModal(tripToEdit);
                    }
                }
            });
            
            // --- Archive History Modal Logic ---
            const renderArchiveHistoryTable = () => {
                archiveHistoryTableBody.innerHTML = '';
                if (archiveHistory.length === 0) {
                    archiveHistoryTableBody.appendChild(emptyHistoryRow.cloneNode(true));
                    clearHistoryBtn.disabled = true;
                    clearHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearHistoryBtn.disabled = false;
                    clearHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveHistory.forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${entry.archiveDate}</td>
                            <td class="px-6 py-4">${entry.period}</td>
                            <td class="px-6 py-4">${entry.totalMiles.toLocaleString()}</td>
                            <td class="px-6 py-4 font-medium text-green-400">${entry.totalAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                            <td class="px-6 py-4 text-center">
                                <button data-id="${entry.id}" class="generate-history-pdf-btn text-purple-400 hover:text-purple-300 font-medium text-sm py-1 px-2 rounded-lg bg-white/10 hover:bg-white/20">
                                    Generate PDF
                                </button>
                            </td>
                        `;
                        archiveHistoryTableBody.appendChild(row);
                    });
                }
            };

            const openHistoryModal = () => {
                renderArchiveHistoryTable();
                historyModal.classList.remove('hidden');
                historyModal.classList.add('flex');
            };

            const closeHistoryModal = () => {
                historyModal.classList.add('hidden');
                historyModal.classList.remove('flex');
            };

            viewHistoryBtn.addEventListener('click', openHistoryModal);
            historyCloseBtn.addEventListener('click', closeHistoryModal);
            closeHistoryModalBtn.addEventListener('click', closeHistoryModal);

            clearHistoryBtn.addEventListener('click', () => {
                // You can add a custom confirmation modal here later if you want
                archiveHistory = [];
                localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
                localStorage.removeItem('lastArchiveSummary'); // Also clear the summary box
                loadLastArchiveSummary(); // Update UI
                renderArchiveHistoryTable();
                showNotification('Archive history has been cleared.', false);
            });

            // New listener for generating PDFs from history
            archiveHistoryTableBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('generate-history-pdf-btn')) {
                    const id = Number(e.target.dataset.id);
                    const entry = archiveHistory.find(item => item.id === id);
                    if (entry && entry.detailedRecords) {
                        showNotification('Generating PDF for archived period...', false);
                        await generateAndHandlePdf(entry.detailedRecords, true);
                    } else {
                        showNotification('Could not find detailed records for this archive entry.');
                    }
                }
            });
            
            // --- Initial Load ---
            loadVehicleInfo();
            renderTable();
            loadLastArchiveSummary(); // Load the summary on startup
        });
    </script>

</body>
</html>

