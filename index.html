<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Truck Mileage Tracker</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Crect x='55' y='10' width='240' height='55' rx='5' fill='%232D3748'/%3E%3Cpath d='M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z' fill='%234A5568'/%3E%3Crect x='5' y='65' width='290' height='5' fill='%231A202C'/%3E%3Cg%3E%3Ccircle cx='50' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='50' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='230' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='230' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='260' cy='70' r='12' fill='%231A202C' stroke='%234A5568' stroke-width='2'/%3E%3Ccircle cx='260' cy='70' r='5' fill='%234A5568'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(120deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh; 
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        .welcome-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .modal-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .modal-scrollbar::-webkit-scrollbar-track {
            background: rgba(45, 55, 72, 0.5); 
        }
        .modal-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(74, 85, 104, 0.7); 
            border-radius: 4px;
        }
       .modal-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(113, 128, 150, 0.8); 
        }
        
       .glass-effect {
            background-color: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
       }

       .glass-input {
            background-color: rgba(17, 24, 39, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
       }
       .glass-input::placeholder {
            color: rgba(209, 213, 219, 0.6); 
       }
       .glass-input:focus {
            background-color: rgba(17, 24, 39, 0.7);
            border-color: rgba(59, 130, 246, 0.7); 
            --tw-ring-color: rgba(59, 130, 246, 0.5);
       }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .sticky-footer {
            position: relative; 
            width: 100%; 
            padding: 1rem; 
            margin-top: 2rem; 
        }
        
       .btn-liquid-glass {
            background-color: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            color: white;
            transition: background-color 0.3s ease, transform 0.1s ease;
       }
       .btn-liquid-glass:hover {
            background-color: rgba(255, 255, 255, 0.08); 
       }
       .btn-liquid-glass:active {
            transform: scale(0.98);
       }

       .btn-danger {
            background-color: rgba(239, 68, 68, 0.2); 
            border-color: rgba(255, 100, 100, 0.08); 
       }
       .btn-danger:hover {
            background-color: rgba(220, 38, 38, 0.25); 
       }
        .btn-edit {
            background-color: rgba(234, 179, 8, 0.2); 
            border-color: rgba(255, 220, 100, 0.08); 
       }
       .btn-edit:hover {
            background-color: rgba(217, 119, 6, 0.25); 
       }
       .btn-purple {
            background-color: rgba(147, 51, 234, 0.2); 
            border-color: rgba(160, 90, 240, 0.08); 
       }
       .btn-purple:hover{
            background-color: rgba(126, 34, 206, 0.25); 
       }
       .btn-success {
            background-color: rgba(34, 197, 94, 0.2); 
            border-color: rgba(74, 222, 128, 0.08);
       }
       .btn-success:hover {
            background-color: rgba(22, 163, 74, 0.25); 
       }
       .btn-primary {
            background-color: rgba(59, 130, 246, 0.2); 
            border-color: rgba(96, 165, 250, 0.08);
       }
       .btn-primary:hover {
            background-color: rgba(37, 99, 235, 0.25); 
       }
       .btn-accent {
            background-color: rgba(22, 163, 165, 0.2); 
            border-color: rgba(56, 189, 248, 0.08);
       }
       .btn-accent:hover {
            background-color: rgba(8, 145, 178, 0.25); 
       }
       
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 15px 0px rgba(34, 211, 238, 0.4); 
            }
            50% {
                box-shadow: 0 0 25px 8px rgba(34, 211, 238, 0.7);
            }
        }

        .pulse-glow-button {
            animation: pulse-glow 2.5s ease-in-out infinite;
            box-shadow: 0 0 15px 0px rgba(34, 211, 238, 0.4);
        }
        
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex justify-center p-2 md:p-4">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-50 transition-opacity duration-500 p-4">
        <svg id="welcome-truck-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 100" class="w-64 h-auto mb-8">
            <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
            <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
            <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
            <g>
                <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="50" cy="70" r="5" fill="#4A5568"/>
            </g>
            <g>
                <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="230" cy="70" r="5" fill="#4A5568"/>
            </g>
             <g>
                <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                <circle cx="260" cy="70" r="5" fill="#4A5568"/>
            </g>
        </svg>
        <h1 id="welcome-title" class="text-4xl font-bold text-cyan-400 welcome-animation text-center">Truck Mileage Tracker</h1>
        <p id="welcome-slogan" class="text-lg text-gray-300 mt-2 text-center">Log your trips and keep accurate track of your miles.</p>
    </div>

    <!-- Main Content Container -->
    <div class="main-container w-[95%] max-w-7xl glass-effect rounded-2xl shadow-lg p-6 md:p-8 md:m-4 md:w-full md:h-auto md:max-w-7xl md:min-h-0 relative"> 
        
        <!-- ***** BOTÓN DE IDIOMA (AHORA MÁS GRANDE) ***** -->
        <button id="lang-toggle" class="absolute top-4 right-4 z-50 btn-liquid-glass text-xs font-bold py-2 px-4 rounded-full">EN / ES</button>
        
        <header class="mb-6 text-center mt-8">
            <svg id="company-logo-svg" viewBox="0 0 300 100" class="h-20 w-auto mx-auto" xmlns="http://www.w3.org/2000/svg">
                <rect x="55" y="10" width="240" height="55" rx="5" fill="#2D3748"/>
                <path d="M55 25 L55 65 L20 65 L20 40 Q20 25 35 25 Z" fill="#4A5568"/>
                <rect x="5" y="65" width="290" height="5" fill="#1A202C"/>
                <g>
                    <circle cx="50" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="50" cy="70" r="5" fill="#4A5568"/>
                </g>
                <g>
                    <circle cx="230" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="230" cy="70" r="5" fill="#4A5568"/>
                </g>
                 <g>
                    <circle cx="260" cy="70" r="12" fill="#1A202C" stroke="#4A5568" stroke-width="2"/>
                    <circle cx="260" cy="70" r="5" fill="#4A5568"/>
                </g>
            </svg>
            
            <h1 id="driver-welcome-message" class="text-3xl font-bold text-cyan-400 mt-2">Welcome</h1>
            
            <button id="show-info-section-btn" class="hidden mt-4 btn-liquid-glass font-bold py-2 px-4 rounded-lg">
                View/Edit Driver Info
            </button>
        </header>

        <!-- Driver & Vehicle Info Section (Collapsible) -->
        <div id="driver-vehicle-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> 
            <div class="flex justify-between items-center mb-4">
                <h2 id="title-driver-info" class="text-xl font-semibold">Driver & Vehicle Info</h2>
            </div>
            <!-- Info Display Area (No longer used, form shown directly for editing) -->
            <div id="vehicle-info-display" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-gray-300">
                    <p><strong>Driver:</strong> <span id="display-driverName"></span></p>
                    <p><strong>Company:</strong> <span id="display-company"></span></p>
                    <p><strong>Truck #:</strong> <span id="display-truckNumber"></span></p>
                    <p><strong>Trailer #:</strong> <span id="display-trailerNumber"></span></p>
                    <p><strong>Initial Odometer:</strong> <span id="display-initialOdometer"></span></p>
                    <p><strong>Rate per Mile:</strong> <span id="display-ratePerMile"></span></p>
                </div>
            </div>
            <!-- Info Edit Form -->
            <form id="vehicle-info-form" class="hidden"> 
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label id="label-driverName" for="driverNameInfo" class="block text-sm font-medium text-gray-300 mb-1">Driver Name</label>
                        <input type="text" id="driverNameInfo" placeholder="Your Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label id="label-company" for="companyInfo" class="block text-sm font-medium text-gray-300 mb-1">Company</label>
                        <input type="text" id="companyInfo" placeholder="Your Company Name" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label id="label-truckNum" for="truckNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Truck #</label>
                        <input type="text" id="truckNumberInfo" placeholder="e.g., T-123" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label id="label-trailerNum" for="trailerNumberInfo" class="block text-sm font-medium text-gray-300 mb-1">Trailer #</label>
                        <input type="text" id="trailerNumberInfo" placeholder="e.g., P-456" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label id="label-initialOdo" for="initialOdometerInfo" class="block text-sm font-medium text-gray-300 mb-1">Initial Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="initialOdometerInfo" placeholder="e.g., 150000" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div>
                        <label id="label-ratePerMile" for="ratePerMileInfo" class="block text-sm font-medium text-gray-300 mb-1">Rate per Mile</label>
                        <input type="text" inputmode="decimal" pattern="[0-9]*\.?[0-9]*" id="ratePerMileInfo" placeholder="e.g., 0.70" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-info-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg hidden">Cancel</button>
                    <button type="submit" id="btn-save-info" class="btn-liquid-glass btn-accent font-bold py-2 px-4 rounded-lg">Save Info</button>
                </div>
            </form>
        </div>

        <!-- NEW: Last Trip Info Display Section -->
        <div id="add-trip-btn-original-location" class="mb-8"> 
            <div class="glass-effect p-4 rounded-xl text-center">
                <h3 id="title-last-trip" class="text-lg font-semibold text-gray-300 mb-2">Last Recorded Trip</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-200">
                    <p><strong id="label-last-city" class="text-cyan-400">City:</strong> <span id="last-trip-departure">N/A</span></p>
                    <p><strong id="label-last-odometer" class="text-cyan-400">Odometer:</strong> <span id="last-trip-odometer">N/A</span></p>
                </div>
            </div>
        </div>
        
        <!-- Add New Trip Section (Collapsible) -->
        <div id="add-trip-section" class="glass-effect p-6 rounded-xl mb-8 hidden"> 
            <h2 id="title-add-trip" class="text-xl font-semibold mb-4">Add New Trip</h2>
            <form id="mileage-form">
                <div class="grid grid-cols-1 md:grid-cols-8 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label id="label-date" for="date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label id="label-city" for="departure" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                        <input type="text" id="departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                    <div class="md:col-span-3">
                        <label id="label-ending-odo" for="odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
                <div class="flex items-center justify-start mb-4">
                    <input id="personal-trip" type="checkbox" class="h-5 w-5 rounded glass-input text-cyan-600 focus:ring-cyan-500 border-white/10">
                    <label id="label-personal-trip" for="personal-trip" class="ml-2 block text-sm font-medium text-gray-300">Personal Trip (unpaid)</label>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-add-trip-btn" class="btn-liquid-glass font-bold py-2.5 px-6 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" id="btn-add-trip" class="w-full md:w-auto btn-liquid-glass btn-accent font-bold py-2.5 px-6 rounded-lg">
                        Add Trip
                    </button>
                </div>
            </form>
        </div>

        <!-- Trip History Section -->
        <div>
            <!-- Control Buttons & Totals (Always Visible) -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center">
                    <span id="label-total-miles" class="font-medium text-gray-300 text-sm">Total Miles</span>
                    <span id="total-miles" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div class="glass-effect rounded-lg p-3 flex flex-col items-center justify-center text-center">
                    <span id="label-total-amount" class="font-medium text-gray-300 text-sm">Amount to Charge</span>
                    <span id="total-amount" class="font-bold text-2xl text-green-400">$0.00</span>
                </div>
                <button type="button" id="archive-reset-btn" class="w-full btn-liquid-glass btn-danger font-bold py-2.5 px-4 rounded-lg flex items-center justify-center gap-2 col-span-2 md:col-span-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4a3 3 0 00-3 3v6a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3H5zm-1 9v-1h12v1a1 1 0 01-1 1H6a1 1 0 01-1-1zm1-4a1 1 0 000 2h10a1 1 0 100-2H5z" clip-rule="evenodd"></path></svg>
                    Archive &amp; Reset
                 </button>
            </div>

            <!-- Collapsible Table Section Header -->
            <div class="flex flex-row justify-between items-center mb-4">
                <h2 id="title-trip-history" class="text-xl font-semibold">Trip History</h2>
                <div class="flex items-center gap-2">
                    <button id="view-current-report-btn" class="btn-liquid-glass btn-primary font-medium text-sm py-1 px-2 rounded-lg flex items-center gap-1" title="View Current Report">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm4 1a1 1 0 100 2h8a1 1 0 100-2H6zM6 11a1 1 0 100 2h8a1 1 0 100-2H6zM6 15a1 1 0 100 2h5a1 1 0 100-2H6z" clip-rule="evenodd" />
                        </svg>
                        View Report
                    </button>
                    <button id="toggle-history-table-btn" class="text-gray-300 hover:text-white p-2 rounded-full" title="Toggle History">
                        <svg id="history-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300 transform rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Collapsible Table Wrapper (Starts hidden) -->
            <div id="history-table-container" class="hidden">
                <div class="overflow-x-auto rounded-lg glass-effect border-none">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-cyan-300 uppercase bg-white/5">
                            <tr>
                                <th id="th-date" scope="col" class="px-6 py-3">Date</th>
                                <th id="th-city" scope="col" class="px-6 py-3">City</th>
                                <th id="th-initial-odo" scope="col" class="px-6 py-3">Initial Odometer</th>
                                <th id="th-ending-odo" scope="col" class="px-6 py-3">Ending Odometer</th>
                                <th id="th-miles" scope="col" class="px-6 py-3">Miles</th>
                                <th id="th-action" scope="col" class="px-6 py-3 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="mileage-table-body">
                            <tr id="empty-row" class="bg-white/5 border-b border-white/10">
                                <td id="empty-row-text" colspan="6" class="text-center py-8 text-gray-400">No records yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div> 

        <!-- Container for the bottom buttons -->
        <div class="sticky-footer flex justify-between items-center px-4 md:px-0 mt-8"> 
            <!-- Backup Button Container -->
            <div id="backup-btn-container" class="z-40"> 
                <button id="open-backup-modal-btn" class="btn-liquid-glass btn-success font-bold py-2.5 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" title="Backup & Restore">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
            </div>
            
            <!-- Add New Trip Button (Moved Here, Large & Round) -->
            <button id="show-add-trip-btn" class="btn-liquid-glass btn-accent text-white font-bold p-6 rounded-full transition-transform duration-300 ease-in-out flex items-center justify-center z-40 pulse-glow-button" title="Add New Trip">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
            </button>

            <!-- History Button Container -->
            <div id="history-btn-container" class="z-40"> 
                <button id="view-history-btn" class="btn-liquid-glass btn-primary font-bold py-2.5 px-4 rounded-full shadow-lg flex items-center justify-center gap-2" title="View Archive History">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Hidden input for file upload -->
        <input type="file" id="upload-backup-input" class="hidden" accept=".json">

    </div> <!-- End Main Content Container -->

    <!-- Modal for Editing a Trip -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="edit-modal-content">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 id="title-edit-trip" class="text-lg font-semibold text-yellow-400">Edit Trip</h3>
                <button id="edit-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="edit-trip-form">
                <div class="p-6 space-y-4">
                    <input type="hidden" id="edit-trip-id">
                    <div>
                        <label id="label-edit-date" for="edit-date" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                        <input type="date" id="edit-date" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label id="label-edit-city" for="edit-departure" class="block text-sm font-medium text-gray-300 mb-1">City</label>
                        <input type="text" id="edit-departure" placeholder="City, State" required class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label id="label-edit-odo" for="edit-odometer" class="block text-sm font-medium text-gray-300 mb-1">Ending Odometer</label>
                        <input type="text" inputmode="numeric" pattern="[0-9]*" id="edit-odometer" placeholder="e.g., 150200" class="w-full glass-input rounded-lg p-2.5 focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div class="flex items-center pt-2">
                        <input id="edit-personal-trip" type="checkbox" class="h-5 w-5 rounded glass-input text-cyan-600 focus:ring-cyan-500 border-white/10">
                        <label id="label-edit-personal-trip" for="edit-personal-trip" class="ml-2 block text-sm font-medium text-gray-300">Personal Trip (unpaid)</label>
                    </div>
                </div>
                <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                    <button type="button" id="cancel-edit-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="btn-save-changes" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal (Archive & Reset) -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="title-confirm-archive" class="text-lg font-semibold text-red-400">Confirm Action</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="msg-confirm-archive">Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Archive & Reset</button>
            </div>
        </div>
    </div>

    <!-- Archive History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-4xl flex flex-col" style="height: 80vh;"> 
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 id="title-archive-history" class="text-lg font-semibold text-blue-400">Archive History</h3>
                <button id="history-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto modal-scrollbar" id="history-modal-content">
                <div class="overflow-x-auto rounded-lg border border-white/10">
                    <table class="w-full text-sm text-left text-gray-200">
                        <thead class="text-xs text-blue-300 uppercase bg-white/5 sticky top-0"> 
                            <tr>
                                <th id="th-archive-date" scope="col" class="px-6 py-3">Archive Date</th>
                                <th id="th-archive-miles" scope="col" class="px-6 py-3">Total Miles</th>
                                <th id="th-archive-amount" scope="col" class="px-6 py-3">Total Amount</th>
                                <th id="th-archive-actions" scope="col" class="px-6 py-3 text-center">Actions</th> 
                            </tr>
                        </thead>
                        <tbody id="archive-history-table-body">
                            <tr id="empty-history-row" class="bg-white/5 border-b border-white/10">
                                <td id="empty-history-text" colspan="4" class="text-center py-8 text-gray-400">No archive history yet.</td> 
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center">
                <button type="button" id="clear-history-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Clear All History</button>
                <button type="button" id="close-history-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (Clear History) -->
    <div id="confirm-clear-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300"> 
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="title-confirm-clear-history" class="text-lg font-semibold text-red-400">Clear Archive History?</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="msg-confirm-clear-history">Are you sure you want to permanently delete all archive history? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-clear-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-clear-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Clear</button>
            </div>
        </div>
    </div>

    <!-- NEW Backup & Restore Modal -->
    <div id="backup-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-3xl flex flex-col" style="height: 80vh;">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 id="title-backup-restore-modal" class="text-lg font-semibold text-green-400">Backup & Restore</h3>
                <button id="backup-close-btn" class="text-gray-300 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6 modal-scrollbar" id="backup-restore-modal-content">
                <div>
                    <h4 id="title-manual-actions" class="text-md font-semibold text-gray-200 mb-3">Manual Actions</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
                        <button id="btn-download-backup" class="btn-liquid-glass btn-success font-bold py-3 px-4 rounded-lg">Download Backup File</button>
                        <button id="btn-upload-backup" class="btn-liquid-glass btn-purple font-bold py-3 px-4 rounded-lg">Upload & Restore File</button>
                    </div>
                </div>

                <div>
                    <h4 id="title-recent-backups" class="text-md font-semibold text-gray-200 mb-3">Recent Backups (Auto/Manual)</h4>
                    <div class="overflow-x-auto rounded-lg border border-white/10" style="max-height: 40vh; overflow-y: auto;">
                        <table class="w-full text-sm text-left text-gray-200">
                            <thead class="text-xs text-green-300 uppercase bg-white/5 sticky top-0"> 
                                <tr>
                                    <th id="th-backup-date" scope="col" class="px-6 py-3">Backup Date</th>
                                    <th id="th-backup-type" scope="col" class="px-6 py-3">Type</th>
                                    <th id="th-backup-actions" scope="col" class="px-6 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-list-body">
                                <tr id="empty-backup-row" class="bg-white/5 border-b border-white/10">
                                    <td id="empty-backup-text" colspan="3" class="text-center py-8 text-gray-400">No backups yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-between items-center">
                <button type="button" id="clear-backups-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Clear All Backups</button>
                <button type="button" id="close-backup-modal-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Restore) -->
    <div id="confirm-restore-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-restore-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="title-confirm-restore" class="text-lg font-semibold text-yellow-400">Confirm Restore</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="confirm-restore-message">Are you sure you want to restore from this backup? All current data will be overwritten.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-restore-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-restore-yes-btn" class="btn-liquid-glass btn-edit font-bold py-2 px-4 rounded-lg">Yes, Restore</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Clear Backups) -->
    <div id="confirm-clear-backups-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[60] transition-opacity duration-300">
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-clear-backups-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="title-confirm-clear-backups" class="text-lg font-semibold text-red-400">Clear All Backups?</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="msg-confirm-clear-backups">Are you sure you want to delete all automatic and manual backups? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-clear-backups-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-clear-backups-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Clear</button>
            </div>
        </div>
    </div>

    <!-- NEW Confirmation Modal (Generic Delete) -->
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-[70] transition-opacity duration-300"> 
        <div class="glass-effect rounded-2xl shadow-xl w-full max-w-lg modal-scrollbar" id="confirm-delete-modal-content">
            <div class="p-4 border-b border-white/10">
                <h3 id="confirm-delete-title" class="text-lg font-semibold text-red-400">Confirm Delete</h3>
            </div>
            <div class="p-6 text-gray-200">
                <p id="confirm-delete-message">Are you sure you want to delete this item? This action cannot be undone.</p>
            </div>
            <div class="p-4 border-t border-white/10 flex justify-end gap-4">
                <button id="confirm-delete-no-btn" class="btn-liquid-glass font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirm-delete-yes-btn" class="btn-liquid-glass btn-danger font-bold py-2 px-4 rounded-lg">Yes, Delete</button>
            </div>
        </div>
    </div>


    <!-- Notification Element -->
    <div id="notification" class="fixed top-5 right-5 glass-effect text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-[1100]">
        <p id="notification-message"></p>
    </div>


    <script>
        // =========================================================================
        //                     *** NUEVA SECCIÓN DE IDIOMAS ***
        // =========================================================================
        
        const translations = {
            en: {
                // Títulos y Bienvenida
                app_title: "Truck Mileage Tracker",
                welcome_title: "Truck Mileage Tracker",
                welcome_slogan: "Log your trips and keep accurate track of your miles.",
                welcome_driver: "Welcome",
                welcome_driver_name: "Welcome {name}",
                
                // Botones principales
                btn_view_edit_info: "View/Edit Driver Info",
                btn_archive_reset: "Archive & Reset",
                btn_view_report: "View Report",
                
                // Tooltips Botones Flotantes
                tooltip_backup: "Backup & Restore",
                tooltip_add_trip: "Add New Trip",
                tooltip_view_archive: "View Archive History",
                
                // Sección Info Conductor
                title_driver_info: "Driver & Vehicle Info",
                label_driverName: "Driver Name",
                ph_driverName: "Your Name",
                label_company: "Company",
                ph_company: "Your Company Name",
                label_truckNum: "Truck #",
                ph_truckNum: "e.g., T-123",
                label_trailerNum: "Trailer #",
                ph_trailerNum: "e.g., P-456",
                label_initialOdo: "Initial Odometer",
                ph_initialOdo: "e.g., 150000",
                label_ratePerMile: "Rate per Mile",
                ph_ratePerMile: "e.g., 0.70",
                btn_save_info: "Save Info",
                btn_cancel: "Cancel", // Botón genérico

                // Sección Último Viaje
                title_last_trip: "Last Recorded Trip",
                label_last_city: "City:",
                label_last_odometer: "Odometer:",
                last_trip_empty: "No trips recorded",

                // Sección Añadir Viaje
                title_add_trip: "Add New Trip",
                label_date: "Date",
                label_city: "City",
                ph_city: "City, State",
                label_ending_odo: "Ending Odometer",
                ph_ending_odo: "e.g., 150200",
                label_personal_trip: "Personal Trip (unpaid)",
                btn_add_trip: "Add Trip",

                // Sección Totales
                label_total_miles: "Total Miles",
                label_total_amount: "Amount to Charge",

                // Sección Historial de Viajes (Tabla)
                title_trip_history: "Trip History",
                th_date: "Date",
                th_city: "City",
                th_initial_odo: "Initial Odometer",
                th_ending_odo: "Ending Odometer",
                th_miles: "Miles",
                th_action: "Action",
                empty_row_text: "No records yet.",
                btn_edit: "Edit",
                btn_delete: "Delete",

                // Modal: Editar Viaje
                title_edit_trip: "Edit Trip",
                label_edit_date: "Date",
                label_edit_city: "City",
                label_edit_odo: "Ending Odometer",
                label_edit_personal_trip: "Personal Trip (unpaid)",
                btn_save_changes: "Save Changes",

                // Modal: Confirmar Archivar
                title_confirm_archive: "Confirm Action",
                msg_confirm_archive: "Are you sure you want to archive all trips? This will download a PDF report, add a summary to the archive history, clear all records, and update the initial odometer. This action cannot be undone.",
                btn_confirm_yes_archive: "Yes, Archive & Reset",

                // Modal: Historial de Archivos
                title_archive_history: "Archive History",
                th_archive_date: "Archive Date",
                th_archive_miles: "Total Miles",
                th_archive_amount: "Total Amount",
                th_archive_actions: "Actions",
                empty_history_text: "No archive history yet.",
                btn_clear_history: "Clear All History",
                btn_close: "Close", // Botón genérico
                btn_pdf: "PDF",

                // Modal: Confirmar Borrar Historial
                title_confirm_clear_history: "Clear Archive History?",
                msg_confirm_clear_history: "Are you sure you want to permanently delete all archive history? This action cannot be undone.",
                btn_confirm_yes_clear: "Yes, Clear",

                // Modal: Backup & Restore
                title_backup_restore_modal: "Backup & Restore",
                title_manual_actions: "Manual Actions",
                btn_download_backup: "Download Backup File",
                btn_upload_backup: "Upload & Restore File",
                title_recent_backups: "Recent Backups (Auto/Manual)",
                th_backup_date: "Backup Date",
                th_backup_type: "Type",
                th_backup_actions: "Actions",
                empty_backup_text: "No backups yet.",
                btn_clear_backups: "Clear All Backups",
                backup_type_auto: "Automatic",
                backup_type_manual: "Manual",
                btn_restore: "Restore",

                // Modal: Confirmar Restaurar
                title_confirm_restore: "Confirm Restore",
                msg_confirm_restore_file: "Are you sure you want to restore from this file? All current data will be overwritten.",
                msg_confirm_restore_prefix: "Are you sure you want to restore the backup from",
                msg_confirm_restore_suffix: "? All current data will be overwritten.",
                btn_restore_yes: "Yes, Restore",
                
                // Modal: Confirmar Borrar Backups
                title_confirm_clear_backups: "Clear All Backups?",
                msg_confirm_clear_backups: "Are you sure you want to delete all automatic and manual backups? This action cannot be undone.",

                // Modal: Confirmar Borrado Genérico
                title_delete_default: "Confirm Delete",
                msg_delete_default: "Are you sure you want to delete this item? This action cannot be undone.",
                btn_delete_yes: "Yes, Delete",

                title_delete_trip: "Delete Trip",
                msg_delete_trip: "Are you sure you want to delete this trip? This cannot be undone.",
                title_delete_backup: "Delete Backup",
                msg_delete_backup: "Are you sure you want to delete this backup? This cannot be undone.",
                title_delete_archive: "Delete Archive Entry",
                msg_delete_archive: "Are you sure you want to delete this archive entry? This cannot be undone.",

                // Notificaciones (Alertas)
                notify_generating_pdf: "Generating {count} PDF report(s)...",
                notify_share_error: "Could not share report for {name}.",
                notify_share_not_supported: "Browser doesn't support sharing. Downloading report for {name}.",
                notify_no_data_report: "No data to generate a report.",
                notify_no_trips_archive: "No trips to archive.",
                notify_archive_success: "Trips have been archived and reset.",
                notify_archive_history_cleared: "Archive history has been cleared.",
                notify_generating_archive_pdf: "Generating PDF for archived period...",
                notify_archive_pdf_error: "Could not find detailed records for this archive entry.",
                notify_no_data_backup: "No data to back up.",
                notify_invalid_backup_file: "Invalid backup file format.",
                notify_read_backup_error: "Could not read backup file.",
                notify_restore_success: "Data restored successfully. Reloading...",
                notify_backup_deleted: "Backup deleted.",
                notify_backups_cleared: "All backups cleared.",
                notify_trip_deleted: "Trip deleted.",
                notify_archive_deleted: "Archive entry deleted.",
                notify_trip_updated: "Trip updated successfully.",
                notify_info_saved: "Driver Info saved successfully.",
                notify_trip_added: "Trip added successfully.", // <-- NUEVA
                notify_save_driver_info_first: "Please save driver & vehicle info, including an initial odometer, before adding a trip.",
                notify_odometer_low: "Ending odometer cannot be less than the initial odometer.",
                notify_odometer_low_edit: "Ending odometer cannot be less than the initial odometer for this trip.",
                notify_update_error: "Could not find trip to update."
            },
            es: {
                // Títulos y Bienvenida
                app_title: "Rastreador de Millaje",
                welcome_title: "Rastreador de Millaje",
                welcome_slogan: "Registre sus viajes y mantenga un seguimiento preciso de sus millas.",
                welcome_driver: "Bienvenido",
                welcome_driver_name: "Bienvenido {name}",

                // Botones principales
                btn_view_edit_info: "Ver/Editar Info. de Conductor",
                btn_archive_reset: "Archivar y Reiniciar",
                btn_view_report: "Ver Reporte",

                // Tooltips Botones Flotantes
                tooltip_backup: "Copia de Seguridad y Restaurar",
                tooltip_add_trip: "Añadir Nuevo Viaje",
                tooltip_view_archive: "Ver Historial de Archivos",

                // Sección Info Conductor
                title_driver_info: "Info. de Conductor y Vehículo",
                label_driverName: "Nombre del Conductor",
                ph_driverName: "Tu Nombre",
                label_company: "Compañía",
                ph_company: "Nombre de tu Compañía",
                label_truckNum: "Nro. de Camión",
                ph_truckNum: "Ej: T-123",
                label_trailerNum: "Nro. de Tráiler",
                ph_trailerNum: "Ej: P-456",
                label_initialOdo: "Odómetro Inicial",
                ph_initialOdo: "Ej: 150000",
                label_ratePerMile: "Tarifa por Milla",
                ph_ratePerMile: "Ej: 0.70",
                btn_save_info: "Guardar Info",
                btn_cancel: "Cancelar", // Botón genérico

                // Sección Último Viaje
                title_last_trip: "Último Viaje Registrado",
                label_last_city: "Ciudad:",
                label_last_odometer: "Odómetro:",
                last_trip_empty: "No hay viajes registrados",

                // Sección Añadir Viaje
                title_add_trip: "Añadir Nuevo Viaje",
                label_date: "Fecha",
                label_city: "Ciudad",
                ph_city: "Ciudad, Estado",
                label_ending_odo: "Odómetro Final",
                ph_ending_odo: "Ej: 150200",
                label_personal_trip: "Viaje Personal (no pagado)",
                btn_add_trip: "Añadir Viaje",

                // Sección Totales
                label_total_miles: "Millas Totales",
                label_total_amount: "Monto a Cobrar",

                // Sección Historial de Viajes (Tabla)
                title_trip_history: "Historial de Viajes",
                th_date: "Fecha",
                th_city: "Ciudad",
                th_initial_odo: "Odómetro Inicial",
                th_ending_odo: "Odómetro Final",
                th_miles: "Millas",
                th_action: "Acción",
                empty_row_text: "Aún no hay registros.",
                btn_edit: "Editar",
                btn_delete: "Borrar",

                // Modal: Editar Viaje
                title_edit_trip: "Editar Viaje",
                label_edit_date: "Fecha",
                label_edit_city: "Ciudad",
                label_edit_odo: "Odómetro Final",
                label_edit_personal_trip: "Viaje Personal (no pagado)",
                btn_save_changes: "Guardar Cambios",

                // Modal: Confirmar Archivar
                title_confirm_archive: "Confirmar Acción",
                msg_confirm_archive: "¿Seguro que quieres archivar todos los viajes? Esto descargará un reporte PDF, añadirá un resumen al historial de archivos, borrará todos los registros y actualizará el odómetro inicial. Esta acción no se puede deshacer.",
                btn_confirm_yes_archive: "Sí, Archivar y Reiniciar",

                // Modal: Historial de Archivos
                title_archive_history: "Historial de Archivos",
                th_archive_date: "Fecha de Archivo",
                th_archive_miles: "Millas Totales",
                th_archive_amount: "Monto Total",
                th_archive_actions: "Acciones",
                empty_history_text: "Aún no hay historial de archivos.",
                btn_clear_history: "Borrar Todo el Historial",
                btn_close: "Cerrar", // Botón genérico
                btn_pdf: "PDF",

                // Modal: Confirmar Borrar Historial
                title_confirm_clear_history: "¿Borrar Historial de Archivos?",
                msg_confirm_clear_history: "¿Seguro que quieres borrar permanentemente todo el historial de archivos? Esta acción no se puede deshacer.",
                btn_confirm_yes_clear: "Sí, Borrar",

                // Modal: Backup & Restore
                title_backup_restore_modal: "Copia de Seguridad y Restaurar",
                title_manual_actions: "Acciones Manuales",
                btn_download_backup: "Descargar Archivo de Respaldo",
                btn_upload_backup: "Subir y Restaurar Archivo",
                title_recent_backups: "Respaldos Recientes (Auto/Manual)",
                th_backup_date: "Fecha de Respaldo",
                th_backup_type: "Tipo",
                th_backup_actions: "Acciones",
                empty_backup_text: "Aún no hay respaldos.",
                btn_clear_backups: "Borrar Todos los Respaldos",
                backup_type_auto: "Automático",
                backup_type_manual: "Manual",
                btn_restore: "Restaurar",

                // Modal: Confirmar Restaurar
                title_confirm_restore: "Confirmar Restauración",
                msg_confirm_restore_file: "¿Seguro que quieres restaurar desde este archivo? Todos los datos actuales se sobrescribirán.",
                msg_confirm_restore_prefix: "¿Seguro que quieres restaurar la copia de",
                msg_confirm_restore_suffix: "? Todos los datos actuales se sobrescribirán.",
                btn_restore_yes: "Sí, Restaurar",

                // Modal: Confirmar Borrar Backups
                title_confirm_clear_backups: "¿Borrar Todos los Respaldos?",
                msg_confirm_clear_backups: "¿Seguro que quieres borrar todos los respaldos automáticos y manuales? Esta acción no se puede deshacer.",

                // Modal: Confirmar Borrado Genérico
                title_delete_default: "Confirmar Borrado",
                msg_delete_default: "¿Seguro que quieres borrar este elemento? Esta acción no se puede deshacer.",
                btn_delete_yes: "Sí, Borrar",

                title_delete_trip: "Borrar Viaje",
                msg_delete_trip: "¿Seguro que quieres borrar este viaje? Esta acción no se puede deshacer.",
                title_delete_backup: "Borrar Respaldo",
                msg_delete_backup: "¿Seguro que quieres borrar este respaldo? Esta acción no se puede deshacer.",
                title_delete_archive: "Borrar Entrada de Archivo",
                msg_delete_archive: "¿Seguro que quieres borrar esta entrada de archivo? Esta acción no se puede deshacer.",

                // Notificaciones (Alertas)
                notify_generating_pdf: "Generando {count} reporte(s) PDF...",
                notify_share_error: "No se pudo compartir el reporte para {name}.",
                notify_share_not_supported: "El navegador no soporta compartir. Descargando reporte para {name}.",
                notify_no_data_report: "No hay datos para generar un reporte.",
                notify_no_trips_archive: "No hay viajes que archivar.",
                notify_archive_success: "Viajes archivados y reiniciados.",
                notify_archive_history_cleared: "Historial de archivos borrado.",
                notify_generating_archive_pdf: "Generando PDF del periodo archivado...",
                notify_archive_pdf_error: "No se encontraron registros detallados para esta entrada de archivo.",
                notify_no_data_backup: "No hay datos para respaldar.",
                notify_invalid_backup_file: "Formato de archivo de respaldo inválido.",
                notify_read_backup_error: "No se pudo leer el archivo de respaldo.",
                notify_restore_success: "Datos restaurados con éxito. Recargando...",
                notify_backup_deleted: "Respaldo borrado.",
                notify_backups_cleared: "Todos los respaldos borrados.",
                notify_trip_deleted: "Viaje borrado.",
                notify_archive_deleted: "Entrada de archivo borrada.",
                notify_trip_updated: "Viaje actualizado con éxito.",
                notify_info_saved: "Información del conductor guardada.",
                notify_trip_added: "Viaje añadido con éxito.",
                notify_save_driver_info_first: "Por favor, guarde la información del conductor y del vehículo, incluido el odómetro inicial, antes de añadir un viaje.",
                notify_odometer_low: "El odómetro final no puede ser menor que el odómetro inicial.",
                notify_odometer_low_edit: "El odómetro final no puede ser menor que el odómetro inicial de este viaje.",
                notify_update_error: "No se pudo encontrar el viaje para actualizar."
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'en';
        
        function updateUI(lang) {
            const t = translations[lang];
            if (!t) return;

            document.documentElement.lang = lang;

            // Función auxiliar para establecer texto o placeholder
            const setText = (id, key, type = 'innerText') => {
                const el = document.getElementById(id);
                if (el && t[key]) {
                    if (type === 'placeholder') el.placeholder = t[key];
                    else if (type === 'title') el.title = t[key];
                    else el.innerText = t[key];
                }
            };

            // Títulos y Bienvenida
            setText('app-title', 'app_title');
            setText('welcome-title', 'welcome_title');
            setText('welcome-slogan', 'welcome_slogan');
            // El mensaje de bienvenida se maneja en loadVehicleInfo()

            // Botones principales
            setText('show-info-section-btn', 'btn_view_edit_info');
            setText('archive-reset-btn', 'btn_archive_reset');
            setText('view-current-report-btn', 'btn_view_report');

            // Tooltips Botones Flotantes
            setText('open-backup-modal-btn', 'tooltip_backup', 'title');
            setText('show-add-trip-btn', 'tooltip_add_new_trip', 'title');
            setText('view-history-btn', 'tooltip_view_archive', 'title');

            // Sección Info Conductor
            setText('title-driver-info', 'title_driver_info');
            setText('label-driverName', 'label_driverName');
            setText('driverNameInfo', 'ph_driverName', 'placeholder');
            setText('label-company', 'label_company');
            setText('companyInfo', 'ph_company', 'placeholder');
            setText('label-truckNum', 'label_truckNum');
            setText('truckNumberInfo', 'ph_truckNum', 'placeholder');
            setText('label-trailerNum', 'label_trailerNum');
            setText('trailerNumberInfo', 'ph_trailerNum', 'placeholder');
            setText('label-initialOdo', 'label_initialOdo');
            setText('initialOdometerInfo', 'ph_initialOdo', 'placeholder');
            setText('label-ratePerMile', 'label_ratePerMile');
            setText('ratePerMileInfo', 'ph_ratePerMile', 'placeholder');
            setText('btn-save-info', 'btn_save_info');
            setText('cancel-info-edit-btn', 'btn_cancel');

            // Sección Último Viaje
            setText('title-last-trip', 'title_last_trip');
            setText('label-last-city', 'label_last_city');
            setText('label-last-odometer', 'label_last_odometer');

            // Sección Añadir Viaje
            setText('title-add-trip', 'title_add_trip');
            setText('label-date', 'label_date');
            setText('label-city', 'label_city');
            setText('departure', 'ph_city', 'placeholder');
            setText('label-ending-odo', 'label_ending_odo');
            setText('odometer', 'ph_ending_odo', 'placeholder');
            setText('label-personal-trip', 'label_personal_trip');
            setText('cancel-add-trip-btn', 'btn_cancel');
            setText('btn-add-trip', 'btn_add_trip');

            // Sección Totales
            setText('label-total-miles', 'label_total_miles');
            setText('label-total-amount', 'label_total_amount');

            // Sección Historial de Viajes (Tabla)
            setText('title-trip-history', 'title_trip_history');
            setText('th-date', 'th_date');
            setText('th-city', 'th_city');
            setText('th-initial-odo', 'th_initial_odo');
            setText('th-ending-odo', 'th_ending_odo');
            setText('th-miles', 'th_miles');
            setText('th-action', 'th_action');
            setText('empty-row-text', 'empty_row_text');
            // Botones de tabla (Edit/Delete) se actualizan en renderTable()

            // Modal: Editar Viaje
            setText('title-edit-trip', 'title_edit_trip');
            setText('label-edit-date', 'label_edit_date');
            setText('label-edit-city', 'label_edit_city');
            setText('edit-departure', 'ph_city', 'placeholder');
            setText('label-edit-odo', 'label_edit_odo');
            setText('edit-odometer', 'ph_ending_odo', 'placeholder');
            setText('label-edit-personal-trip', 'label_edit_personal_trip');
            setText('cancel-edit-btn', 'btn_cancel');
            setText('btn-save-changes', 'btn_save_changes');

            // Modal: Confirmar Archivar
            setText('title-confirm-archive', 'title_confirm_archive');
            setText('msg-confirm-archive', 'msg_confirm_archive');
            setText('confirm-no-btn', 'btn_cancel');
            setText('confirm-yes-btn', 'btn_confirm_yes_archive');

            // Modal: Historial de Archivos
            setText('title-archive-history', 'title_archive_history');
            setText('th-archive-date', 'th_archive_date');
            setText('th-archive-miles', 'th_archive_miles');
            setText('th-archive-amount', 'th_archive_amount');
            setText('th-archive-actions', 'th_archive_actions');
            setText('empty-history-text', 'empty_history_text');
            setText('clear-history-btn', 'btn_clear_history');
            setText('close-history-modal-btn', 'btn_close');
            // Botones de tabla (PDF/Delete) se actualizan en renderArchiveHistoryTable()

            // Modal: Confirmar Borrar Historial
            setText('title-confirm-clear-history', 'title_confirm_clear_history');
            setText('msg-confirm-clear-history', 'msg_confirm_clear_history');
            setText('confirm-clear-no-btn', 'btn_cancel');
            setText('confirm-clear-yes-btn', 'btn_confirm_yes_clear');

            // Modal: Backup & Restore
            setText('title-backup-restore-modal', 'title_backup_restore_modal');
            setText('title-manual-actions', 'title_manual_actions');
            setText('btn-download-backup', 'btn_download_backup');
            setText('btn-upload-backup', 'btn_upload_backup');
            setText('title-recent-backups', 'title_recent_backups');
            setText('th-backup-date', 'th_backup_date');
            setText('th-backup-type', 'th_backup_type');
            setText('th-backup-actions', 'th_backup_actions');
            setText('empty-backup-text', 'empty_backup_text');
            setText('clear-backups-btn', 'btn_clear_backups');
            setText('close-backup-modal-btn', 'btn_close');
            // Botones de tabla (Restore/Delete) se actualizan en renderBackupList()

            // Modal: Confirmar Restaurar
            setText('title-confirm-restore', 'title_confirm_restore');
            // El mensaje es dinámico, se actualiza al abrir
            setText('confirm-restore-no-btn', 'btn_cancel');
            setText('confirm-restore-yes-btn', 'btn_restore_yes');
            
            // Modal: Confirmar Borrar Backups
            setText('title-confirm-clear-backups', 'title_confirm_clear_backups');
            setText('msg-confirm-clear-backups', 'msg_confirm_clear_backups');
            setText('confirm-clear-backups-no-btn', 'btn_cancel');
            setText('confirm-clear-backups-yes-btn', 'btn_confirm_yes_clear');

            // Modal: Confirmar Borrado Genérico
            // Título y mensaje son dinámicos
            setText('confirm-delete-no-btn', 'btn_cancel');
            setText('confirm-delete-yes-btn', 'btn_delete_yes');
        }

        // =========================================================================
        //                 *** FIN DE LA SECCIÓN DE IDIOMAS ***
        // =========================================================================


        document.addEventListener('DOMContentLoaded', () => {
            // *** INICIO: CÓDIGO DE IDIOMA ***
            const langToggleBtn = document.getElementById('lang-toggle');
            if (langToggleBtn) {
                langToggleBtn.addEventListener('click', () => {
                    currentLanguage = currentLanguage === 'en' ? 'es' : 'en';
                    localStorage.setItem('appLanguage', currentLanguage);
                    updateUI(currentLanguage);
                    // Forzar recarga de elementos dinámicos
                    // CAMBIO: Se llama a la nueva función específica en lugar de a todo loadVehicleInfo()
                    updateWelcomeMessage(); 
                    renderTable(); // Para botones Edit/Delete
                    renderArchiveHistoryTable(); // Para botones PDF/Delete
                    renderBackupList(); // Para botones Restore/Delete y tipo
                });
            }
            // *** FIN: CÓDIGO DE IDIOMA ***

            
            // =========================================================================
            //  ELEMENT SELECTORS
            // =========================================================================
            
            // --- General ---
            const welcomeScreen = document.getElementById('welcome-screen');
            
            // --- Forms ---
            const form = document.getElementById('mileage-form');
            const vehicleInfoForm = document.getElementById('vehicle-info-form');
            const editTripForm = document.getElementById('edit-trip-form');
            
            // --- Tables ---
            const tableBody = document.getElementById('mileage-table-body');
            const emptyRow = document.getElementById('empty-row');
            
            // --- Totals Display ---
            const totalMilesEl = document.getElementById('total-miles');
            const totalAmountEl = document.getElementById('total-amount');
            
            // --- Driver Info Section ---
            const driverVehicleSection = document.getElementById('driver-vehicle-section');
            const showInfoSectionBtn = document.getElementById('show-info-section-btn');
            const cancelInfoEditBtn = document.getElementById('cancel-info-edit-btn'); 
            const vehicleInfoDisplay = document.getElementById('vehicle-info-display');
            const driverNameInfoInput = document.getElementById('driverNameInfo');
            const companyInfoInput = document.getElementById('companyInfo');
            const truckNumberInfoInput = document.getElementById('truckNumberInfo');
            const trailerNumberInfoInput = document.getElementById('trailerNumberInfo');
            const initialOdometerInfoInput = document.getElementById('initialOdometerInfo');
            const ratePerMileInfoInput = document.getElementById('ratePerMileInfo');
            
            // --- Driver Info Display Spans (for PDF) ---
            const displayDriverName = document.getElementById('display-driverName');
            const displayCompany = document.getElementById('display-company');
            const displayTruckNumber = document.getElementById('display-truckNumber');
            const displayTrailerNumber = document.getElementById('display-trailerNumber');
            const displayInitialOdometer = document.getElementById('display-initialOdometer');
            const displayRatePerMile = document.getElementById('display-ratePerMile');

            const driverWelcomeMessage = document.getElementById('driver-welcome-message');

            // --- Last Trip Display ---
            const lastTripDateEl = document.getElementById('last-trip-date'); 
            const lastTripDepartureEl = document.getElementById('last-trip-departure');
            const lastTripOdometerEl = document.getElementById('last-trip-odometer');

            // --- Add Trip Section ---
            const addTripSection = document.getElementById('add-trip-section');
            const showAddTripBtn = document.getElementById('show-add-trip-btn'); 
            const cancelAddTripBtn = document.getElementById('cancel-add-trip-btn');
            const departureInput = document.getElementById('departure');
            
            // --- Main Control Buttons ---
            const archiveResetBtn = document.getElementById('archive-reset-btn');

            // --- History Table Section ---
            const toggleHistoryTableBtn = document.getElementById('toggle-history-table-btn');
            const historyToggleIcon = document.getElementById('history-toggle-icon');
            const historyTableContainer = document.getElementById('history-table-container');
            const viewCurrentReportBtn = document.getElementById('view-current-report-btn'); 

            // --- Floating Buttons ---
            const backupBtnContainer = document.getElementById('backup-btn-container'); 
            const historyBtnContainer = document.getElementById('history-btn-container'); 
            const openBackupModalBtn = document.getElementById('open-backup-modal-btn'); 
            const viewHistoryBtn = document.getElementById('view-history-btn'); 

            // --- Edit Modal ---
            const editModal = document.getElementById('edit-modal');
            const editCloseBtn = document.getElementById('edit-close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // --- Confirm Archive Modal ---
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            // --- Archive History Modal ---
            const historyModal = document.getElementById('history-modal');
            const historyCloseBtn = document.getElementById('history-close-btn');
            const closeHistoryModalBtn = document.getElementById('close-history-modal-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const archiveHistoryTableBody = document.getElementById('archive-history-table-body');
            const emptyHistoryRow = document.getElementById('empty-history-row');

            // --- Confirm Clear History Modal ---
            const confirmClearModal = document.getElementById('confirm-clear-modal');
            const confirmClearYesBtn = document.getElementById('confirm-clear-yes-btn');
            const confirmClearNoBtn = document.getElementById('confirm-clear-no-btn');

            // --- Backup/Restore Modal ---
            const backupRestoreModal = document.getElementById('backup-restore-modal');
            const backupCloseBtn = document.getElementById('backup-close-btn');
            const closeBackupModalBtn = document.getElementById('close-backup-modal-btn');
            const btnDownloadBackup = document.getElementById('btn-download-backup');
            const btnUploadBackup = document.getElementById('btn-upload-backup');
            const uploadBackupInput = document.getElementById('upload-backup-input');
            const backupListBody = document.getElementById('backup-list-body');
            const emptyBackupRow = document.getElementById('empty-backup-row');
            const clearBackupsBtn = document.getElementById('clear-backups-btn');
            
            // --- Confirm Restore Modal ---
            const confirmRestoreModal = document.getElementById('confirm-restore-modal');
            const confirmRestoreMessage = document.getElementById('confirm-restore-message');
            const confirmRestoreYesBtn = document.getElementById('confirm-restore-yes-btn');
            const confirmRestoreNoBtn = document.getElementById('confirm-restore-no-btn');
            
            // --- Confirm Clear Backups Modal ---
            const confirmClearBackupsModal = document.getElementById('confirm-clear-backups-modal');
            const confirmClearBackupsYesBtn = document.getElementById('confirm-clear-backups-yes-btn');
            const confirmClearBackupsNoBtn = document.getElementById('confirm-clear-backups-no-btn');

            // --- Generic Delete Modal ---
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmDeleteTitle = document.getElementById('confirm-delete-title');
            const confirmDeleteMessage = document.getElementById('confirm-delete-message');
            const confirmDeleteYesBtn = document.getElementById('confirm-delete-yes-btn');
            const confirmDeleteNoBtn = document.getElementById('confirm-delete-no-btn');


            // =========================================================================
            //  STATE VARIABLES
            // =========================================================================
            
            let records = JSON.parse(localStorage.getItem('mileageRecords')) || [];
            let vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
            let archiveHistory = JSON.parse(localStorage.getItem('archiveHistory')) || [];
            let mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
            let isHistoryVisible = false; 

            // =========================================================================
            //  HELPER FUNCTIONS
            // =========================================================================

            const formatDateToMMDDYY = (dateStringOrObject) => {
                if (!dateStringOrObject) return 'N/A';
                try {
                    let date;
                    if (dateStringOrObject instanceof Date) {
                        date = dateStringOrObject;
                    } else if (typeof dateStringOrObject === 'number') {
                        date = new Date(dateStringOrObject);
                    } else {
                        const parts = String(dateStringOrObject).split('-');
                        if (parts.length === 3 && parts[0].length === 4) {
                            date = new Date(parts[0], parts[1] - 1, parts[2]);
                        } else {
                            date = new Date(dateStringOrObject);
                        }
                    }
                    if (isNaN(date.getTime())) {
                        return String(dateStringOrObject); 
                    }
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    return `${month}/${day}/${year}`;
                } catch (error) {
                    console.warn(`Could not format date: ${dateStringOrObject}`, error);
                    return String(dateStringOrObject); 
                }
            };

            /**
             * NUEVA FUNCIÓN: Actualiza el mensaje de bienvenida basado en el idioma y vehicleInfo.
             */
            const updateWelcomeMessage = () => {
                const t = translations[currentLanguage];
                if (driverWelcomeMessage) { 
                    if (vehicleInfo && vehicleInfo.driverName && vehicleInfo.driverName.trim() !== "") {
                        const firstName = vehicleInfo.driverName.split(' ')[0];
                        driverWelcomeMessage.textContent = t.welcome_driver_name.replace('{name}', firstName);
                    } else {
                        driverWelcomeMessage.textContent = t.welcome_driver;
                    }
                }
            };

            /**
             * Muestra una notificación.
             * @param {string} messageKey - La *clave* del objeto de traducción (ej: 'notify_trip_added').
             * @param {boolean} [isError=true] - True para error, false para éxito.
             */
            const showNotification = (messageKey, isError = true) => {
                const t = translations[currentLanguage];
                const message = t[messageKey] || messageKey; // Obtiene el mensaje traducido o usa la clave

                const notification = document.getElementById('notification');
                const notificationMessage = document.getElementById('notification-message');
                if (!notification || !notificationMessage) return;
                
                notificationMessage.textContent = message; 

                notification.classList.remove('bg-red-600/70', 'bg-green-500/70');
                notification.classList.add(isError ? 'bg-red-600/70' : 'bg-green-500/70');
                notification.classList.add('backdrop-blur-md');
                notification.classList.remove('opacity-0');
                setTimeout(() => {
                    notification.classList.add('opacity-0');
                }, 4000);
            };

            const getSvgAsImageBase64 = (svgElement) => {
                return new Promise((resolve, reject) => {
                    if (!svgElement) return reject("SVG element not provided");
                    const clone = svgElement.cloneNode(true);
                    const animations = clone.querySelectorAll('animateTransform');
                    animations.forEach(anim => anim.remove());
                    
                    const svgString = new XMLSerializer().serializeToString(clone);
                    const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
                    const url = URL.createObjectURL(svgBlob);
                    
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const viewBox = clone.getAttribute('viewBox').split(' ').map(Number);
                        const width = viewBox[2];
                        const height = viewBox[3];
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        URL.revokeObjectURL(url);
                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.onerror = (err) => {
                        URL.revokeObjectURL(url);
                        reject(err);
                    };
                    img.src = url;
                });
            };
            
            const getAllDataAsObject = () => {
                return {
                    vehicleInfo: JSON.parse(localStorage.getItem('vehicleInfo')) || null,
                    records: JSON.parse(localStorage.getItem('mileageRecords')) || [],
                    archiveHistory: JSON.parse(localStorage.getItem('archiveHistory')) || []
                };
            };

            // =========================================================================
            //  UI & MODAL LOGIC
            // =========================================================================

             const isUIElementOpen = () => {
                 return !editModal.classList.contains('hidden') ||
                        !confirmModal.classList.contains('hidden') ||
                        !historyModal.classList.contains('hidden') ||
                        !confirmClearModal.classList.contains('hidden') ||
                        !backupRestoreModal.classList.contains('hidden') ||
                        !confirmRestoreModal.classList.contains('hidden') ||
                        !confirmClearBackupsModal.classList.contains('hidden') ||
                        !confirmDeleteModal.classList.contains('hidden') || 
                        !driverVehicleSection.classList.contains('hidden') || 
                        !addTripSection.classList.contains('hidden') ||
                        isHistoryVisible;
             };

             const moveButtonsDown = () => {
                 if (showAddTripBtn) {
                     showAddTripBtn.classList.add('translate-y-32'); 
                 }
             };

             const moveButtonsUp = () => {
                 setTimeout(() => {
                    const addTripFormHidden = addTripSection.classList.contains('hidden');
                    if (!isUIElementOpen() && addTripFormHidden && showAddTripBtn) {
                        showAddTripBtn.classList.remove('translate-y-32');
                    }
                    else if (addTripFormHidden && showAddTripBtn) {
                        showAddTripBtn.classList.remove('translate-y-32');
                    }
                 }, 150); 
             };

            const openEditModal = (trip) => {
                document.getElementById('edit-trip-id').value = trip.id;
                document.getElementById('edit-date').value = trip.date; 
                document.getElementById('edit-departure').value = trip.departure;
                document.getElementById('edit-odometer').value = trip.odometer;
                document.getElementById('edit-personal-trip').checked = trip.isPersonal || false; 
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
                moveButtonsDown(); 
            };

            const closeEditModal = () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                editTripForm.reset();
                moveButtonsUp(); 
            };
            
            const openConfirmModal = () => {
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
                moveButtonsDown(); 
            };

            const closeConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            const openHistoryModal = () => {
                renderArchiveHistoryTable(); 
                historyModal.classList.remove('hidden');
                historyModal.classList.add('flex');
                moveButtonsDown(); 
            };

            const closeHistoryModal = () => {
                historyModal.classList.add('hidden');
                historyModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            const openConfirmClearModal = () => {
                confirmClearModal.classList.remove('hidden');
                confirmClearModal.classList.add('flex');
            };

            const closeConfirmClearModal = () => {
                confirmClearModal.classList.add('hidden');
                confirmClearModal.classList.remove('flex');
            };
            
            const openBackupModal = () => {
                renderBackupList();
                backupRestoreModal.classList.remove('hidden');
                backupRestoreModal.classList.add('flex');
                moveButtonsDown(); 
            };

            const closeBackupModal = () => {
                backupRestoreModal.classList.add('hidden');
                backupRestoreModal.classList.remove('flex');
                moveButtonsUp(); 
            };
            
            const openConfirmRestoreModal = (messageKey) => {
                const t = translations[currentLanguage];
                let message = t[messageKey] || messageKey;
                
                // Manejar mensaje dinámico
                if (messageKey === 'msg_confirm_restore_dynamic') {
                    const date = localStorage.getItem('pendingRestoreDate');
                    message = `${t.msg_confirm_restore_prefix} ${date} ${t.msg_confirm_restore_suffix}`;
                }

                confirmRestoreMessage.textContent = message;
                confirmRestoreModal.classList.remove('hidden');
                confirmRestoreModal.classList.add('flex');
            };

            const closeConfirmRestoreModal = () => {
                confirmRestoreModal.classList.add('hidden');
                confirmRestoreModal.classList.remove('flex');
                localStorage.removeItem('pendingRestoreData'); 
                localStorage.removeItem('pendingRestoreDate'); // Limpiar fecha
            };
            
            const openConfirmClearBackupsModal = () => {
                confirmClearBackupsModal.classList.remove('hidden');
                confirmClearBackupsModal.classList.add('flex');
            };

            const closeConfirmClearBackupsModal = () => {
                confirmClearBackupsModal.classList.add('hidden');
                confirmClearBackupsModal.classList.remove('flex');
            };

            const openConfirmDeleteModal = (titleKey, messageKey, deleteInfo) => {
                const t = translations[currentLanguage];
                confirmDeleteTitle.textContent = t[titleKey] || t.title_delete_default;
                confirmDeleteMessage.textContent = t[messageKey] || t.msg_delete_default;
                localStorage.setItem('pendingDelete', JSON.stringify(deleteInfo)); 
                confirmDeleteModal.classList.remove('hidden');
                confirmDeleteModal.classList.add('flex');
            };

            const closeConfirmDeleteModal = () => {
                confirmDeleteModal.classList.add('hidden');
                confirmDeleteModal.classList.remove('flex');
                localStorage.removeItem('pendingDelete'); 
            };


            // =========================================================================
            //  DATA & RENDER FUNCTIONS
            // =========================================================================

            const loadVehicleInfo = () => {
                vehicleInfo = JSON.parse(localStorage.getItem('vehicleInfo')) || null;
                
                // *** CAMBIO: Llamar a la nueva función ***
                updateWelcomeMessage(); 
                // *** FIN DEL CAMBIO ***

                if (vehicleInfo) {
                    driverVehicleSection.classList.add('hidden');
                    showInfoSectionBtn.classList.remove('hidden');
                    
                    displayDriverName.textContent = vehicleInfo.driverName;
                    displayCompany.textContent = vehicleInfo.company;
                    displayTruckNumber.textContent = vehicleInfo.truckNumber;
                    displayTrailerNumber.textContent = vehicleInfo.trailerNumber;
                    displayInitialOdometer.textContent = Number(vehicleInfo.initialOdometer).toLocaleString();
                    displayRatePerMile.textContent = (parseFloat(vehicleInfo.ratePerMile) || 0.70).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
                    
                    driverNameInfoInput.value = vehicleInfo.driverName;
                    companyInfoInput.value = vehicleInfo.company;
                    truckNumberInfoInput.value = vehicleInfo.truckNumber;
                    trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                    initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                    ratePerMileInfoInput.value = vehicleInfo.ratePerMile || '0.70';
                    
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.remove('hidden');
                } else {
                    driverVehicleSection.classList.remove('hidden');
                    showInfoSectionBtn.classList.add('hidden');
                    vehicleInfoDisplay.classList.add('hidden');
                    vehicleInfoForm.classList.remove('hidden'); 
                    cancelInfoEditBtn.classList.add('hidden');
                    ratePerMileInfoInput.value = '0.70';
                    moveButtonsDown(); 
                }
            };
            
            const renderTable = () => {
                const t = translations[currentLanguage];
                tableBody.innerHTML = '';
                if (records.length === 0) {
                    if (emptyRow) { 
                        const clonedEmptyRow = emptyRow.cloneNode(true);
                        clonedEmptyRow.querySelector('td').innerText = t.empty_row_text;
                        tableBody.appendChild(clonedEmptyRow);
                    }
                    archiveResetBtn.disabled = true;
                    archiveResetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    archiveResetBtn.disabled = false;
                    archiveResetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                     records.forEach(record => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10 hover:bg-white/10';
                        const milesText = Number(record.miles) === 0 ? '' : Number(record.miles).toLocaleString();
                        const milesClass = record.isPersonal ? 'text-gray-500 line-through' : 'text-cyan-400';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${formatDateToMMDDYY(record.date)}</td>
                            <td class="px-6 py-4">${record.departure}</td>
                            <td class="px-6 py-4">${Number(record.initialOdometer).toLocaleString()}</td>
                            <td class="px-6 py-4">${Number(record.odometer) === 0 ? '' : Number(record.odometer).toLocaleString()}</td>
                            <td class="px-6 py-4 font-bold ${milesClass}">${milesText}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${record.id}" class="edit-btn btn-liquid-glass btn-edit font-medium mr-4 px-2 py-1 rounded-lg text-sm">${t.btn_edit}</button>
                                <button data-id="${record.id}" class="delete-btn btn-liquid-glass btn-danger font-medium px-2 py-1 rounded-lg text-sm">${t.btn_delete}</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
                updateTotalMiles(); 
                updateLastTripDisplay(); 
                saveToLocalStorage(); 
            };

            const updateTotalMiles = () => {
                const payableRecords = records.filter(record => !record.isPersonal);
                const total = payableRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                totalMilesEl.textContent = total.toLocaleString();
                const rate = parseFloat(vehicleInfo?.ratePerMile || '0.70');
                const amount = total * rate;
                totalAmountEl.textContent = amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };

            const updateLastTripDisplay = () => {
                const t = translations[currentLanguage];
                if (records.length > 0) {
                    const lastTrip = records[records.length - 1];
                    lastTripDepartureEl.textContent = lastTrip.departure;
                    lastTripOdometerEl.textContent = lastTrip.odometer > 0 ? Number(lastTrip.odometer).toLocaleString() : 'N/A';
                } else {
                    lastTripDepartureEl.textContent = t.last_trip_empty; 
                    lastTripOdometerEl.textContent = '';
                }
            };

            const saveToLocalStorage = () => {
                localStorage.setItem('mileageRecords', JSON.stringify(records));
            };

            const generateAndHandlePdf = async (recordsToExport, forSharing = true) => {
                const t = translations[currentLanguage];
                 if (!recordsToExport || recordsToExport.length === 0) {
                     showNotification('notify_no_data_report');
                     return;
                 }
                 let logoBase64;
                 try {
                     logoBase64 = await getSvgAsImageBase64(document.getElementById('welcome-truck-svg')); 
                 } catch (error) {
                     console.warn('Could not load company logo for the PDF report.', error);
                 }
                 const uniqueDrivers = [...new Set(recordsToExport.map(r => r.driverName))];
                 showNotification(t.notify_generating_pdf.replace('{count}', uniqueDrivers.length), false);

                 for (const driver of uniqueDrivers) {
                     const driverRecords = recordsToExport.filter(r => r.driverName === driver);
                      const driverInfo = {
                          driverName: driver,
                          company: driverRecords[0]?.company || vehicleInfo?.company || 'N/A',
                          truckNumber: driverRecords[0]?.truckNumber || vehicleInfo?.truckNumber || 'N/A',
                          trailerNumber: driverRecords[0]?.trailerNumber || vehicleInfo?.trailerNumber || 'N/A',
                     };
                     const { jsPDF } = window.jspdf;
                     const doc = new jsPDF();
                     const payableDriverRecords = driverRecords.filter(r => !r.isPersonal);
                     const totalMilesForDriver = payableDriverRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                     let startY = 15; 
                     
                     if(logoBase64) {
                         const imgWidth = 60;
                         const imgHeight = 20;
                         const pageWidth = doc.internal.pageSize.getWidth();
                         const x = (pageWidth - imgWidth) / 2;
                         doc.addImage(logoBase64, 'PNG', x, 15, imgWidth, imgHeight);
                         startY = 45; 
                     }
                     
                     doc.setFontSize(22);
                     doc.setFont('helvetica', 'bold');
                     doc.setTextColor(50, 50, 50); 
                     doc.text(driverInfo.company, doc.internal.pageSize.getWidth() / 2, startY, { align: 'center' });
                     startY += 8;
                     
                     const headerParts = [
                         { text: `Driver: `, style: 'normal', color: [100, 100, 100] }, 
                         { text: driverInfo.driverName, style: 'bold', size: 13, color: [50, 50, 50] }, 
                         { text: ` | Truck #: ${driverInfo.truckNumber} | Trailer #: ${driverInfo.trailerNumber}`, style: 'normal', color: [100, 100, 100] } 
                     ];
                     let currentX = doc.internal.pageSize.getWidth() / 2;
                     const totalWidth = headerParts.reduce((sum, part) => {
                         doc.setFont('helvetica', part.style || 'normal');
                         doc.setFontSize(part.size || 11);
                         return sum + doc.getTextWidth(part.text);
                     }, 0);
                     currentX -= totalWidth / 2;
                     headerParts.forEach(part => {
                         doc.setFont('helvetica', part.style || 'normal');
                         doc.setFontSize(part.size || 11);
                         doc.setTextColor(...(part.color || [50, 50, 50])); 
                         doc.text(part.text, currentX, startY);
                         currentX += doc.getTextWidth(part.text);
                     });
                     startY += 15;
                     
                     const tableColumn = ["Date", "City", "Initial Odo", "Ending Odo", "Miles", "Notes"];
                     const tableRows = driverRecords.map(r => [
                         formatDateToMMDDYY(r.date), 
                         r.departure, 
                         Number(r.initialOdometer).toLocaleString(),
                         Number(r.odometer) === 0 ? '' : Number(r.odometer).toLocaleString(), 
                         Number(r.miles) === 0 ? '' : Number(r.miles).toLocaleString(),
                         r.isPersonal ? 'Personal' : '' 
                     ]);
                     doc.autoTable(tableColumn, tableRows, { 
                         startY: startY,
                         headStyles: {
                             fillColor: [22, 163, 165], 
                             textColor: [255, 255, 255] 
                         },
                         bodyStyles: {
                             textColor: [50, 50, 50] 
                         },
                         footStyles: { 
                             fillColor: [240, 240, 240], 
                             textColor: [50, 50, 50], 
                             fontStyle: 'bold'
                         },
                         foot: [ 
                             ['', '', '', '', 'Total Payable:', totalMilesForDriver.toLocaleString(), ''] 
                         ],
                         
                         willDrawCell: (data) => {
                             if (data.section === 'body') {
                                 const record = driverRecords[data.row.index];
                                 if (record && record.isPersonal) {
                                     doc.setTextColor(150, 150, 150); 
                                 }
                             }
                         },
                         didDrawCell: (data) => {
                             if (data.section === 'body') {
                                 const record = driverRecords[data.row.index];
                                 if (record && record.isPersonal) {
                                     const cell = data.cell;
                                     const textPos = cell.textPos;
                                     const textWidth = Math.min(
                                         doc.getTextWidth(cell.text[0] || ''),
                                         cell.width - cell.padding('horizontal') 
                                     );
                                     
                                     const lineY = textPos.y + (doc.internal.getFontSize() / 3); 

                                     doc.setDrawColor(150, 150, 150); 
                                     doc.setLineWidth(0.3);
                                     doc.line(textPos.x, lineY, textPos.x + textWidth, lineY);
                                     
                                     doc.setTextColor(50, 50, 50); 
                                 }
                             }
                         }
                     });
                     
                     const today = formatDateToMMDDYY(new Date()); 
                     const pageWidth = doc.internal.pageSize.getWidth();
                     doc.setFontSize(10);
                     doc.setFont('helvetica', 'normal');
                     doc.setTextColor(150, 150, 150); 
                     doc.text("Developed for AROHER88", pageWidth - 14, doc.internal.pageSize.getHeight() - 15, { align: 'right' });
                     doc.text(`Date: ${today}`, pageWidth - 14, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
                     
                     if(forSharing) {
                         const pdfBlob = doc.output('blob');
                         const pdfFile = new File([pdfBlob], `mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`, { type: 'application/pdf' });
                         const shareData = { files: [pdfFile], title: `Mileage Report for ${driverInfo.driverName}` };
                         if (navigator.canShare && navigator.canShare(shareData)) {
                             try { await navigator.share(shareData); } catch (err) {
                                 if (err.name !== 'AbortError') { showNotification(t.notify_share_error.replace('{name}', driverInfo.driverName));}
                             }
                         } else {
                             showNotification(t.notify_share_not_supported.replace('{name}', driverInfo.driverName), false);
                             doc.save(`mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                         }
                     } else {
                          doc.save(`ARCHIVED_mileage_report_${driverInfo.driverName.replace(/\s+/g, '_')}.pdf`);
                     }
                 }
            };
            
            const renderArchiveHistoryTable = () => {
                const t = translations[currentLanguage];
                archiveHistoryTableBody.innerHTML = '';
                if (archiveHistory.length === 0) {
                    if (emptyHistoryRow) { 
                        const clonedEmptyRow = emptyHistoryRow.cloneNode(true);
                        clonedEmptyRow.querySelector('td').innerText = t.empty_history_text;
                        archiveHistoryTableBody.appendChild(clonedEmptyRow);
                    }
                    clearHistoryBtn.disabled = true;
                    clearHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearHistoryBtn.disabled = false;
                    clearHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    archiveHistory.forEach(entry => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';

                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${formatDateToMMDDYY(entry.archiveDate)}</td>
                            <td class="px-6 py-4">${entry.totalMiles.toLocaleString()}</td>
                            <td class="px-6 py-4 font-medium text-green-400">${entry.totalAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <button data-id="${entry.id}" class="generate-history-pdf-btn btn-liquid-glass btn-purple font-medium text-sm py-1 px-2 rounded-lg mr-2">
                                    ${t.btn_pdf}
                                </button>
                                <button data-id="${entry.id}" class="delete-archive-btn btn-liquid-glass btn-danger font-medium text-sm py-1 px-2 rounded-lg">
                                    ${t.btn_delete}
                                </button>
                            </td>
                        `;
                        archiveHistoryTableBody.appendChild(row);
                    });
                }
            };
            
            const renderBackupList = () => {
                const t = translations[currentLanguage];
                mileageBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
                backupListBody.innerHTML = '';
                if (mileageBackups.length === 0) {
                    if (emptyBackupRow) { 
                        const clonedEmptyRow = emptyBackupRow.cloneNode(true);
                        clonedEmptyRow.querySelector('td').innerText = t.empty_backup_text;
                        backupListBody.appendChild(clonedEmptyRow);
                    }
                    clearBackupsBtn.disabled = true;
                    clearBackupsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearBackupsBtn.disabled = false;
                    clearBackupsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    mileageBackups.forEach(backup => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white/5 border-b border-white/10';
                        const backupDate = formatDateToMMDDYY(backup.timestamp); 
                        const type = backup.type === 'auto' ? t.backup_type_auto : t.backup_type_manual;
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium whitespace-nowrap">${backupDate}</td>
                            <td class="px-6 py-4">${type}</td>
                            <td class="px-6 py-4 text-center space-x-2">
                                <button data-timestamp="${backup.timestamp}" class="restore-backup-btn btn-liquid-glass btn-edit font-medium text-sm py-1 px-2 rounded-lg">
                                    ${t.btn_restore}
                                </button>
                                <button data-timestamp="${backup.timestamp}" class="delete-backup-btn btn-liquid-glass btn-danger font-medium text-sm py-1 px-2 rounded-lg">
                                    ${t.btn_delete}
                                </button>
                            </td>
                        `;
                        backupListBody.appendChild(row);
                    });
                }
            };
            
            const checkAndRunAutoBackup = () => {
                const lastBackupTime = parseInt(localStorage.getItem('lastAutoBackupTime') || '0', 10);
                const now = Date.now();
                const oneHour = 60 * 60 * 1000; 

                if (now - lastBackupTime > oneHour) {
                    const backupData = getAllDataAsObject(); 
                    
                    if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) {
                        console.log('No data to back up automatically.');
                        return; 
                    }

                    const newBackup = {
                        timestamp: now,
                        type: 'auto',
                        data: backupData 
                    };
                    
                    let currentBackups = JSON.parse(localStorage.getItem('mileageBackups')) || [];
                    currentBackups.unshift(newBackup); 

                    const autoBackups = currentBackups.filter(b => b.type === 'auto');
                    if (autoBackups.length > 3) { 
                        const timestamps = autoBackups.map(b => b.timestamp).sort((a,b) => a - b); 
                        const oldestTimestamp = timestamps[0];
                        const indexToRemove = currentBackups.findIndex(b => b.timestamp === oldestTimestamp && b.type === 'auto');
                        if (indexToRemove > -1) {
                            currentBackups.splice(indexToRemove, 1);
                        }
                    }

                    localStorage.setItem('mileageBackups', JSON.stringify(currentBackups));
                    localStorage.setItem('lastAutoBackupTime', now.toString());
                    console.log('Automatic backup created (hourly).');
                }
            };

            // =========================================================================
            //  EVENT LISTENERS
            // =========================================================================

            setTimeout(() => {
                welcomeScreen.classList.add('opacity-0');
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                }, 500);
            }, 2000); 

            if (vehicleInfoForm) {
                vehicleInfoForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newInfo = {
                        driverName: driverNameInfoInput.value,
                        company: companyInfoInput.value,
                        truckNumber: truckNumberInfoInput.value,
                        trailerNumber: trailerNumberInfoInput.value,
                        initialOdometer: initialOdometerInfoInput.value,
                        ratePerMile: ratePerMileInfoInput.value || '0.70',
                    };
                    localStorage.setItem('vehicleInfo', JSON.stringify(newInfo));
                    vehicleInfo = newInfo; 
                    driverVehicleSection.classList.add('hidden');
                    showInfoSectionBtn.classList.remove('hidden');
                    loadVehicleInfo(); 
                    updateTotalMiles(); 
                    showNotification('notify_info_saved', false);
                    moveButtonsUp(); 
                });
            }

            if (showInfoSectionBtn) {
                showInfoSectionBtn.addEventListener('click', () => {
                    driverVehicleSection.classList.remove('hidden');
                    showInfoSectionBtn.classList.add('hidden');
                    moveButtonsDown(); 
                });
            }

            if (cancelInfoEditBtn) {
                cancelInfoEditBtn.addEventListener('click', () => {
                    if (vehicleInfo) { 
                        driverVehicleSection.classList.add('hidden');
                        showInfoSectionBtn.classList.remove('hidden');
                        driverNameInfoInput.value = vehicleInfo.driverName;
                        companyInfoInput.value = vehicleInfo.company;
                        truckNumberInfoInput.value = vehicleInfo.truckNumber;
                        trailerNumberInfoInput.value = vehicleInfo.trailerNumber;
                        initialOdometerInfoInput.value = vehicleInfo.initialOdometer;
                        ratePerMileInfoInput.value = vehicleInfo.ratePerMile || '0.70';
                        moveButtonsUp(); 
                    } 
                });
            }

            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (!vehicleInfo || vehicleInfo.initialOdometer === undefined) {
                        showNotification('notify_save_driver_info_first');
                        return;
                    }
                    const initialOdometer = Number(vehicleInfo.initialOdometer);
                    const endingOdometerInput = document.getElementById('odometer').value;
                    const endingOdometer = endingOdometerInput ? Number(endingOdometerInput) : 0;
                    let tripMiles = 0;
                    let shouldUpdateOdometer = false;

                    if (endingOdometer > 0) {
                        if (endingOdometer < initialOdometer) {
                            showNotification('notify_odometer_low');
                            return;
                        }
                        tripMiles = endingOdometer - initialOdometer;
                        shouldUpdateOdometer = true;
                    }

                    const isPersonal = document.getElementById('personal-trip').checked;

                    const newRecord = {
                        id: Date.now(),
                        date: document.getElementById('date').value, 
                        departure: departureInput.value,
                        driverName: vehicleInfo.driverName, 
                        company: vehicleInfo.company, 
                        truckNumber: vehicleInfo.truckNumber, 
                        trailerNumber: vehicleInfo.trailerNumber, 
                        initialOdometer: initialOdometer,
                        odometer: endingOdometer,
                        miles: tripMiles,
                        isPersonal: isPersonal 
                    };

                    records.push(newRecord);
                    records.sort((a, b) => a.id - b.id); 
                    
                    if (shouldUpdateOdometer) {
                        vehicleInfo.initialOdometer = endingOdometer;
                        localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                    }
                    
                    form.reset();
                    renderTable(); 
                    loadVehicleInfo(); 
                    addTripSection.classList.add('hidden');
                    showAddTripBtn.classList.remove('hidden'); 
                    moveButtonsUp(); 
                    showNotification('notify_trip_added', false); // <-- NUEVA NOTIFICACIÓN
                });
            }

            if (showAddTripBtn) {
                showAddTripBtn.addEventListener('click', () => {
                    addTripSection.classList.remove('hidden'); 
                    showAddTripBtn.classList.add('hidden'); 
                    moveButtonsDown(); 
                });
            }

            if (cancelAddTripBtn) {
                cancelAddTripBtn.addEventListener('click', () => {
                    addTripSection.classList.add('hidden'); 
                    showAddTripBtn.classList.remove('hidden'); 
                    form.reset();
                    moveButtonsUp(); 
                });
            }
            
            if (editTripForm) {
                editTripForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const tripId = Number(document.getElementById('edit-trip-id').value);
                    const tripIndex = records.findIndex(r => r.id === tripId);
                    if (tripIndex === -1) {
                        showNotification('notify_update_error');
                        return;
                    }
                    
                    const updatedIsPersonal = document.getElementById('edit-personal-trip').checked;
                    const updatedTrip = {
                        ...records[tripIndex], 
                        date: document.getElementById('edit-date').value, 
                        departure: document.getElementById('edit-departure').value,
                        odometer: Number(document.getElementById('edit-odometer').value),
                        isPersonal: updatedIsPersonal 
                    };

                    const endingOdometer = updatedTrip.odometer;
                    const initialOdometer = updatedTrip.initialOdometer;
                    if (endingOdometer > 0) {
                        if (endingOdometer < initialOdometer) {
                            showNotification('notify_odometer_low_edit');
                            return;
                        }
                        updatedTrip.miles = endingOdometer - initialOdometer;
                    } else {
                        updatedTrip.miles = 0; 
                    }
                    
                    records[tripIndex] = updatedTrip;
                    records.sort((a, b) => a.id - b.id); 
                    
                    if (tripIndex === records.length - 1 && updatedTrip.odometer > 0) {
                        vehicleInfo.initialOdometer = updatedTrip.odometer;
                        localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                        loadVehicleInfo(); 
                    }
                    
                    renderTable(); 
                    closeEditModal();
                    showNotification('notify_trip_updated', false);
                });
            }

            if (editCloseBtn) editCloseBtn.addEventListener('click', closeEditModal);
            if (cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditModal);

            if (toggleHistoryTableBtn) {
                toggleHistoryTableBtn.addEventListener('click', () => {
                    isHistoryVisible = !isHistoryVisible;
                    if (isHistoryVisible) {
                        historyTableContainer.classList.remove('hidden');
                        historyToggleIcon.classList.remove('rotate-180');
                        moveButtonsDown(); 
                    } else {
                        historyTableContainer.classList.add('hidden');
                        historyToggleIcon.classList.add('rotate-180');
                        moveButtonsUp(); 
                    }
                });
            }

            if (viewCurrentReportBtn) {
                viewCurrentReportBtn.addEventListener('click', async () => {
                    if (records.length === 0) {
                        showNotification('notify_no_data_report');
                        return;
                    }
                    await generateAndHandlePdf(records, false); 
                });
            }

            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) {
                        const idToDelete = Number(e.target.dataset.id);
                        openConfirmDeleteModal(
                            'title_delete_trip', 
                            'msg_delete_trip', 
                            { type: 'trip', id: idToDelete }
                        );
                    } 
                    else if (e.target.classList.contains('edit-btn')) {
                        const idToEdit = Number(e.target.dataset.id);
                        const tripToEdit = records.find(r => r.id === idToEdit);
                        if (tripToEdit) {
                            openEditModal(tripToEdit);
                        }
                    }
                });
            }
            
            if (archiveResetBtn) archiveResetBtn.addEventListener('click', openConfirmModal);
            if (confirmNoBtn) confirmNoBtn.addEventListener('click', closeConfirmModal);
            if (confirmYesBtn) {
                confirmYesBtn.addEventListener('click', async () => {
                    if (records.length === 0) {
                        showNotification('notify_no_trips_archive');
                        closeConfirmModal();
                        return;
                    }
                    
                    await generateAndHandlePdf(records, false); 

                    const rate = parseFloat(vehicleInfo?.ratePerMile || '0.70');
                    const payableRecords = records.filter(record => !record.isPersonal);
                    const totalMiles = payableRecords.reduce((sum, record) => sum + Number(record.miles), 0);
                    const totalAmount = totalMiles * rate;
                    const firstDate = records[0]?.date; 
                    const lastDate = records[records.length - 1]?.date; 
                    const period = firstDate === lastDate ? firstDate : `${firstDate} to ${lastDate}`;
                    
                    const newArchiveEntry = {
                        id: Date.now(),
                        archiveDate: new Date().toLocaleDateString(), 
                        period: period, 
                        totalMiles: totalMiles,
                        totalAmount: totalAmount,
                        detailedRecords: [...records], 
                        ratePerMile: rate
                    };

                    archiveHistory.unshift(newArchiveEntry); 
                    localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));

                    const lastValidRecord = [...records].reverse().find(r => r.odometer > 0);
                    if (lastValidRecord && vehicleInfo) {
                        vehicleInfo.initialOdometer = lastValidRecord.odometer;
                        localStorage.setItem('vehicleInfo', JSON.stringify(vehicleInfo));
                    }

                    records = []; 
                    localStorage.setItem('mileageRecords', JSON.stringify(records));
                    
                    renderTable(); 
                    loadVehicleInfo(); 
                    closeConfirmModal();
                    showNotification('notify_archive_success', false);
                });
            }
            
            if (viewHistoryBtn) viewHistoryBtn.addEventListener('click', openHistoryModal);
            if (historyCloseBtn) historyCloseBtn.addEventListener('click', closeHistoryModal);
            if (closeHistoryModalBtn) closeHistoryModalBtn.addEventListener('click', closeHistoryModal);
            if (clearHistoryBtn) clearHistoryBtn.addEventListener('click', openConfirmClearModal);
            if (confirmClearNoBtn) confirmClearNoBtn.addEventListener('click', closeConfirmClearModal);
            
            if (confirmClearYesBtn) {
                confirmClearYesBtn.addEventListener('click', () => {
                    archiveHistory = [];
                    localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
                    renderArchiveHistoryTable(); 
                    closeConfirmClearModal();
                    showNotification('notify_archive_history_cleared', false);
                });
            }

            if (archiveHistoryTableBody) {
                archiveHistoryTableBody.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('generate-history-pdf-btn')) {
                        const id = Number(e.target.dataset.id);
                        const entry = archiveHistory.find(item => item.id === id);
                        if (entry && entry.detailedRecords) {
                            showNotification('notify_generating_archive_pdf', false);
                            await generateAndHandlePdf(entry.detailedRecords, false); 
                        } else {
                            showNotification('notify_archive_pdf_error');
                        }
                    }
                    else if (e.target.classList.contains('delete-archive-btn')) {
                        const idToDelete = Number(e.target.dataset.id);
                        openConfirmDeleteModal(
                            'title_delete_archive', 
                            'msg_delete_archive', 
                            { type: 'archive', id: idToDelete }
                        );
                    }
                });
            }
            
            if (openBackupModalBtn) openBackupModalBtn.addEventListener('click', openBackupModal);
            if (backupCloseBtn) backupCloseBtn.addEventListener('click', closeBackupModal);
            if (closeBackupModalBtn) closeBackupModalBtn.addEventListener('click', closeBackupModal);

            if (btnDownloadBackup) {
                btnDownloadBackup.addEventListener('click', () => {
                    const backupData = getAllDataAsObject();
                    if (!backupData.vehicleInfo && backupData.records.length === 0 && backupData.archiveHistory.length === 0) {
                        showNotification('notify_no_data_backup');
                        return; 
                    }
                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `truck_mileage_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
            }

            if (btnUploadBackup) {
                btnUploadBackup.addEventListener('click', () => {
                    uploadBackupInput.click(); 
                });
            }

            if (uploadBackupInput) {
                uploadBackupInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.hasOwnProperty('vehicleInfo') && data.hasOwnProperty('records') && data.hasOwnProperty('archiveHistory')) {
                                localStorage.setItem('pendingRestoreData', JSON.stringify(data));
                                openConfirmRestoreModal('msg_confirm_restore_file');
                            } else {
                                showNotification('notify_invalid_backup_file');
                            }
                        } catch (err) {
                            showNotification('notify_read_backup_error');
                        }
                        e.target.value = null; 
                    };
                    reader.readAsText(file);
                });
            }

            if (confirmRestoreNoBtn) confirmRestoreNoBtn.addEventListener('click', closeConfirmRestoreModal);
            if (confirmRestoreYesBtn) {
                confirmRestoreYesBtn.addEventListener('click', () => {
                    const dataToRestoreJSON = localStorage.getItem('pendingRestoreData');
                    if (!dataToRestoreJSON) return;
                    
                    const dataToRestore = JSON.parse(dataToRestoreJSON);
                    
                    localStorage.setItem('vehicleInfo', JSON.stringify(dataToRestore.vehicleInfo));
                    localStorage.setItem('mileageRecords', JSON.stringify(dataToRestore.records));
                    localStorage.setItem('archiveHistory', JSON.stringify(dataToRestore.archiveHistory));
                    
                    localStorage.removeItem('pendingRestoreData');
                    closeConfirmRestoreModal();
                    closeBackupModal(); 
                    
                    showNotification('notify_restore_success', false);
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1500); 
                });
            }
            
            if (backupListBody) {
                backupListBody.addEventListener('click', (e) => {
                    const timestamp = e.target.dataset.timestamp;
                    if (!timestamp) return;

                    if (e.target.classList.contains('restore-backup-btn')) {
                        const backup = mileageBackups.find(b => b.timestamp == timestamp);
                        if (backup) {
                            localStorage.setItem('pendingRestoreData', JSON.stringify(backup.data));
                            // Mensaje dinámico
                            localStorage.setItem('pendingRestoreDate', formatDateToMMDDYY(Number(backup.timestamp)));
                            openConfirmRestoreModal('msg_confirm_restore_dynamic');
                        }
                    }

                    if (e.target.classList.contains('delete-backup-btn')) {
                        openConfirmDeleteModal(
                            'title_delete_backup', 
                            'msg_delete_backup', 
                            { type: 'backup', id: timestamp }
                        );
                    }
                });
            }

            if (clearBackupsBtn) clearBackupsBtn.addEventListener('click', openConfirmClearBackupsModal);
            if (confirmClearBackupsNoBtn) confirmClearBackupsNoBtn.addEventListener('click', closeConfirmClearBackupsModal);
            if (confirmClearBackupsYesBtn) {
                confirmClearBackupsYesBtn.addEventListener('click', () => {
                    mileageBackups = [];
                    localStorage.setItem('mileageBackups', JSON.stringify(mileageBackups));
                    localStorage.removeItem('lastAutoBackupTime'); 
                    renderBackupList(); 
                    closeConfirmClearBackupsModal();
                    showNotification('notify_backups_cleared', false);
                });
            }

            if (confirmDeleteNoBtn) confirmDeleteNoBtn.addEventListener('click', closeConfirmDeleteModal);
            if (confirmDeleteYesBtn) {
                confirmDeleteYesBtn.addEventListener('click', () => {
                    const pendingDeleteJSON = localStorage.getItem('pendingDelete');
                    if (!pendingDeleteJSON) return;

                    const pendingDelete = JSON.parse(pendingDeleteJSON);

                    if (pendingDelete.type === 'trip') {
                        records = records.filter(record => record.id !== pendingDelete.id);
                        renderTable(); 
                        showNotification('notify_trip_deleted', false);
                    } else if (pendingDelete.type === 'backup') {
                        const timestamp = pendingDelete.id;
                        mileageBackups = mileageBackups.filter(b => b.timestamp != timestamp);
                        localStorage.setItem('mileageBackups', JSON.stringify(mileageBackups));
                        renderBackupList(); 
                        showNotification('notify_backup_deleted', false);
                    }
                    else if (pendingDelete.type === 'archive') {
                        const idToDelete = Number(pendingDelete.id);
                        archiveHistory = archiveHistory.filter(entry => entry.id !== idToDelete);
                        localStorage.setItem('archiveHistory', JSON.stringify(archiveHistory));
                        renderArchiveHistoryTable(); 
                        showNotification('notify_archive_deleted', false);
                    }

                    closeConfirmDeleteModal(); 
                });
            }
            
            
            // =========================================================================
            //  INITIALIZATION
            // =========================================================================
            
            // *** INICIO: CÓDIGO DE IDIOMA ***
            // Cargar la UI con el idioma correcto al iniciar
            updateUI(currentLanguage); 
            // *** FIN: CÓDIGO DE IDIOMA ***

            loadVehicleInfo();
            renderTable(); 
            checkAndRunAutoBackup(); 

            if (addTripSection && showAddTripBtn) {
                if (addTripSection.classList.contains('hidden')) {
                    showAddTripBtn.classList.remove('hidden'); 
                } else {
                    showAddTripBtn.classList.add('hidden'); 
                    moveButtonsDown(); 
                }
                moveButtonsUp(); 
            }

        });
    </script>

</body>
</html>






